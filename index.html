<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sabor e SaÃºde - CardÃ¡pio de Marmitas Fit</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            forest:     '#2D5A3D',
            sage:       '#8FAE8B',
            cream:      '#FDF8F3',
            terracotta: '#C4785A',
            charcoal:   '#2A2A2A'
          },
          animation: {
            'pop': 'pop 0.3s ease-out',
            'slide-in': 'slideIn 0.3s ease-out'
          },
          keyframes: {
            pop: {
              '0%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.2)' },
              '100%': { transform: 'scale(1)' },
            },
            slideIn: {
              '0%': { transform: 'translateY(100%)', opacity: 0 },
              '100%': { transform: 'translateY(0)', opacity: 1 },
            }
          }
        }
      }
    }
  </script>
  <style>
    .font-display { font-family: 'Playfair Display', serif; }
    .font-body    { font-family: 'DM Sans', sans-serif; }
    body          { background-color: #FDF8F3; }
    .fade-in      { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    .modal-bg     { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .loading-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(253,248,243,0.95);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    input[type="number"].qty-input { -moz-appearance:textfield; appearance:textfield; }
    input[type="number"].qty-input::-webkit-inner-spin-button,
    input[type="number"].qty-input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    .table-row:hover { background-color: #f9f5f0; }
    .sidebar-hidden { display: none !important; }
    .vegetal-btn.selected {
      border-color: #2D5A3D !important;
      background-color: #2D5A3D !important;
      color: white !important;
    }
    /* Estilo para barras de scroll */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #FDF8F3; }
    ::-webkit-scrollbar-thumb { background: #8FAE8B; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #2D5A3D; }
  </style>
</head>
<body class="h-full font-body text-charcoal">

<!-- ==================== LOADING ==================== -->
<div id="loading" class="loading-overlay" aria-live="polite" aria-busy="true">
  <div class="text-center">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-forest mx-auto mb-4"></div>
    <p class="text-forest font-bold" id="loading-text">Carregando cardÃ¡pio...</p>
  </div>
</div>

<!-- ==================== MODAL LOGIN ADMIN ==================== -->
<div id="admin-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg" role="dialog" aria-modal="true" aria-labelledby="admin-title">
  <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
    <h2 id="admin-title" class="font-display text-2xl text-forest mb-4">Acesso Administrativo</h2>
    <form onsubmit="handleLogin(event)" class="space-y-4">
      <div>
        <label for="login-username" class="block text-xs font-bold uppercase text-gray-400 mb-1">UsuÃ¡rio</label>
        <input id="login-username" type="text" autocomplete="username" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div>
        <label for="login-password" class="block text-xs font-bold uppercase text-gray-400 mb-1">Senha</label>
        <input id="login-password" type="password" autocomplete="current-password" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <button type="submit" class="w-full bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all active:scale-95">
        Entrar no Painel
      </button>
      <button type="button" onclick="closeAdminModal()" class="w-full text-gray-400 text-sm py-2">Cancelar</button>
      <p id="login-error" class="text-red-500 text-xs text-center hidden" aria-live="polite">UsuÃ¡rio ou senha incorretos</p>
    </form>
  </div>
</div>

<!-- ==================== MODAL VISUALIZAR PEDIDO ==================== -->
<div id="modal-pedido" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg" role="dialog" aria-modal="true">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-display text-2xl text-forest">Detalhes do Pedido</h2>
      <button onclick="closeModalPedido()" class="text-gray-400 hover:text-gray-600 text-2xl" aria-label="Fechar detalhes">âœ•</button>
    </div>
    <div id="modal-pedido-content" class="space-y-4"></div>
    <div class="flex gap-3 pt-6">
      <button id="btn-wpp-cliente" onclick="abrirWhatsAppCliente()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition-all active:scale-95">
        ğŸ“± Abrir WhatsApp
      </button>
      <button onclick="closeModalPedido()" class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all active:scale-95">
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL MARMITA ==================== -->
<div id="modal-marmita" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg" role="dialog" aria-modal="true">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-marmita-title">Novo Item</h2>
    <form onsubmit="salvarMarmita(event)" class="space-y-4">
      <input type="hidden" id="edit-marmita-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome *</label>
        <input id="marmita-nome" type="text" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">PreÃ§o (R$) *</label>
          <input id="marmita-preco" type="number" step="0.01" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Calorias (kcal) *</label>
          <input id="marmita-kcal" type="number" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">DescriÃ§Ã£o *</label>
        <textarea id="marmita-desc" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest h-20"></textarea>
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Categoria *</label>
        <select id="marmita-cat" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          <option value="marmita">ğŸ± Marmita</option>
          <option value="sopa">ğŸ² Sopa</option>
          <option value="suco">ğŸ¥¤ Suco</option>
          <option value="sobremesa">ğŸ° Sobremesa</option>
          <option value="proteico">ğŸ’ª Proteico</option>
          <option value="low-carb">ğŸ¥— Low Carb</option>
          <option value="vegano">ğŸŒ± Vegano</option>
          <option value="vegetal">ğŸ¥¦ Vegetal</option>
        </select>
      </div>

      <div class="bg-sage/10 p-4 rounded-xl space-y-3">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="marmita-visivel" checked class="w-5 h-5 rounded text-forest focus:ring-forest">
          <div>
            <p class="font-bold text-sm text-forest">ğŸ‘ï¸ VisÃ­vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar do cardÃ¡pio</p>
          </div>
        </label>
        <label class="flex items-center gap-3 cursor-pointer border-t border-sage/20 pt-3">
          <input type="checkbox" id="marmita-disponivel-combo" checked class="w-5 h-5 rounded text-forest focus:ring-forest">
          <div>
            <p class="font-bold text-sm text-forest">ğŸ“¦ DisponÃ­vel para seleÃ§Ã£o em Combos</p>
            <p class="text-xs text-gray-500">Desmarque para nÃ£o aparecer na escolha de itens</p>
          </div>
        </label>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all active:scale-95">
          Salvar
        </button>
        <button type="button" onclick="closeModalMarmita()" class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all active:scale-95">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ==================== MODAL COMBO ==================== -->
<div id="modal-combo" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg" role="dialog" aria-modal="true">
  <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-combo-title">Novo Combo</h2>
    <form onsubmit="salvarCombo(event)" class="space-y-4">
      <input type="hidden" id="edit-combo-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome do Combo *</label>
        <input id="combo-nome" type="text" required placeholder="Ex: Kit 10 Marmitas" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>

      <div class="bg-cream p-4 rounded-xl border-2 border-sage/20">
        <fieldset>
          <legend class="block text-xs font-bold uppercase text-gray-400 mb-3">Tipo de Combo *</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
              <input type="radio" name="tipo-combo" value="aberto" checked onchange="toggleTipoCombo()" class="mt-1 text-forest focus:ring-forest">
              <div>
                <p class="font-bold text-forest">ğŸ›’ Combo Aberto</p>
                <p class="text-xs text-gray-500">Cliente escolhe os itens</p>
              </div>
            </label>
            <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
              <input type="radio" name="tipo-combo" value="fechado" onchange="toggleTipoCombo()" class="mt-1 text-forest focus:ring-forest">
              <div>
                <p class="font-bold text-forest">ğŸ“¦ Combo Fechado</p>
                <p class="text-xs text-gray-500">Itens prÃ©-definidos</p>
              </div>
            </label>
          </div>
        </fieldset>
      </div>

      <!-- CONFIG ABERTO -->
      <div id="config-aberto" class="space-y-4">
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Qtd Itens *</label>
            <input id="combo-qtd" type="number" min="1" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">PreÃ§o (R$) *</label>
            <input id="combo-preco" type="number" step="0.01" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1" title="Cliente escolhe de N em N">MÃºltiplos</label>
            <input id="combo-lote" type="number" min="1" value="1" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>
        
        <div class="bg-white border-2 border-sage/20 rounded-xl p-4">
          <div class="flex justify-between items-center mb-2">
            <label class="block text-xs font-bold uppercase text-gray-400">Pratos DisponÃ­veis no Combo</label>
            <div class="flex gap-2">
              <button type="button" onclick="marcarPratosCombo(true)" class="text-xs text-forest font-bold hover:underline">Todos</button>
              <button type="button" onclick="marcarPratosCombo(false)" class="text-xs text-terracotta font-bold hover:underline">Nenhum</button>
            </div>
          </div>
          <div id="checklist-pratos-abertos" class="max-h-48 overflow-y-auto space-y-1 border-t border-sage/10 pt-2">
            <!-- Lista carregada via JS -->
          </div>
        </div>
      </div>

      <!-- CONFIG FECHADO -->
      <div id="config-fechado" class="hidden">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-3">Itens do Combo *</label>
        <div class="bg-white border-2 border-sage/20 rounded-xl p-4 max-h-72 overflow-y-auto" id="itens-combo-container"></div>
        <div class="mt-4">
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">PreÃ§o do Combo (R$) *</label>
          <input id="combo-preco-fechado" type="number" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>

      <!-- LIMITE DE VEGETAIS -->
      <div class="bg-green-50 border-2 border-green-100 p-4 rounded-xl">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-2">ğŸ¥¦ Vegetais no Pedido</label>
        <p class="text-xs text-gray-500 mb-3">Quantos vegetais o cliente poderÃ¡ escolher ao montar este combo?</p>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade mÃ­nima</label>
            <input id="combo-vegetal-min" type="number" min="0" value="0" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade mÃ¡xima</label>
            <input id="combo-vegetal-max" type="number" min="0" value="0" placeholder="0 = sem vegetais" class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>
      </div>

      <div class="bg-sage/10 p-4 rounded-lg">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="combo-visivel" checked class="w-5 h-5 rounded text-forest focus:ring-forest">
          <div>
            <p class="font-bold text-sm text-forest">ğŸ‘ï¸ VisÃ­vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar este combo</p>
          </div>
        </label>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all active:scale-95">
          Salvar Combo
        </button>
        <button type="button" onclick="closeModalCombo()" class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all active:scale-95">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ==================== APP PRINCIPAL ==================== -->
<div id="main-app" class="min-h-screen flex flex-col relative">

  <!-- HEADER -->
  <header class="bg-forest text-cream px-6 py-4 flex justify-between items-center sticky top-0 z-40 shadow-md">
    <div class="flex items-center gap-3">
      <img id="logo-empresa" src="https://raw.githubusercontent.com/Sabor-e-Saude/cardapio-pedidos/refs/heads/main/logo.png" alt="Logotipo Sabor e SaÃºde" class="w-12 h-12 rounded-full object-cover border-2 border-sage/40">
      <div>
        <h1 class="font-display text-xl md:text-2xl">Sabor e SaÃºde</h1>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-toggle-sidebar" onclick="toggleSidebar()" class="hidden text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all" aria-label="Alternar Menu Lateral">â˜°</button>
      <button id="btn-admin-view" onclick="openAdminModal()" class="text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all">Acesso Admin</button>
      <button id="btn-voltar-combo" onclick="resetarSelecaoAtual()" class="hidden text-xs bg-terracotta/30 px-3 py-2 rounded-lg hover:bg-terracotta/50 transition-all">â¬… Voltar</button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR ADMIN -->
    <aside id="sidebar" class="w-64 bg-white border-r hidden overflow-y-auto flex-shrink-0 transition-all" aria-label="NavegaÃ§Ã£o Administrativa">
      <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Gerenciamento</p>
      </div>
      <nav class="p-4 space-y-2">
        <button onclick="showPage('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">ğŸ“Š Dashboard</button>
        <button onclick="showPage('pedidos')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all flex items-center justify-between">
          <span>ğŸ“‹ Pedidos</span>
          <span id="badge-pedidos" class="bg-terracotta text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        <button onclick="showPage('combos')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">ğŸ“¦ Gerenciar Combos</button>
        <button onclick="showPage('marmitas')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">ğŸ± Gerenciar CardÃ¡pio</button>
        <hr class="my-4">
        <button onclick="entrarComoCliente()" class="w-full text-left px-4 py-3 rounded-lg text-terracotta hover:bg-terracotta/5 transition-all">â¬…ï¸ Ver como Cliente</button>
      </nav>
    </aside>

    <!-- CONTEÃšDO PRINCIPAL -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 pb-32">

      <!-- ===== PÃGINA CLIENTE: CARDÃPIO ===== -->
      <section id="page-cardapio" class="fade-in max-w-4xl mx-auto">
        <!-- VISÃƒO 1: LISTA DE COMBOS (HOME) -->
        <div id="home-combos">
          <div class="mb-8">
            <h2 class="font-display text-3xl text-forest">Monte seu Kit ğŸ±</h2>
            <p class="text-sage">Escolha um combo abaixo para comeÃ§ar sua seleÃ§Ã£o.</p>
          </div>
          <div id="combos-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-10" aria-label="Lista de combos disponÃ­veis"></div>
          <div class="mb-10">
            <button onclick="abrirCotacaoEspecial()" class="w-full bg-white border-2 border-dashed border-sage/40 rounded-3xl p-5 flex items-center gap-4 hover:border-forest hover:bg-sage/5 transition-all group text-left active:scale-[0.98]">
              <div class="w-12 h-12 bg-forest/10 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-forest/20 transition-all"><span class="text-2xl" aria-hidden="true">ğŸ¥—</span></div>
              <div>
                <p class="font-bold text-forest">Tenho uma dieta diferenciada</p>
                <p class="text-xs text-gray-400 mt-0.5">RestriÃ§Ãµes alimentares, dieta prescrita ou necessidade especial? Fale conosco para uma cotaÃ§Ã£o personalizada.</p>
              </div>
              <span class="ml-auto text-gray-300 group-hover:text-forest transition-all text-xl shrink-0" aria-hidden="true">â†’</span>
            </button>
          </div>
        </div>

        <!-- VISÃƒO 2: CONFIGURAÃ‡ÃƒO DO COMBO -->
        <div id="marmitas-section" class="hidden fade-in pt-4">
          <article class="bg-forest text-white p-6 rounded-2xl mb-8 shadow-xl">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs opacity-70 uppercase font-bold">Progresso do Kit</p>
                <p class="text-lg font-bold" id="combo-name-display">Carregando...</p>
                <p class="text-xs opacity-70 mt-1" id="combo-tipo-badge"></p>
              </div>
              <div class="text-right" id="progress-counter">
                <p class="text-xs opacity-60 uppercase mb-1">ğŸ± Marmitas</p>
                <div class="flex items-baseline gap-1" aria-live="polite">
                  <span class="text-3xl font-display font-bold" id="current-marmitas">0</span>
                  <span class="text-xl opacity-50">/</span>
                  <span class="text-xl opacity-50" id="max-marmitas">10</span>
                </div>
              </div>
            </div>
            <div id="progress-bar-container" class="mt-4" aria-hidden="true">
              <div class="w-full bg-white/20 rounded-full h-2">
                <div id="progress-bar" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
          </article>

          <article id="combo-fechado-itens" class="hidden mb-8 bg-white rounded-2xl p-6 shadow-sm border border-sage/20">
            <h3 class="text-xl font-bold text-forest mb-4">ğŸ“¦ Itens inclusos neste combo:</h3>
            <div id="lista-itens-fechado" class="space-y-2"></div>
          </article>

          <article id="selecao-marmitas-container">
            <h3 class="text-xl font-bold text-forest mb-4">Selecione suas refeiÃ§Ãµes:</h3>
            <!-- BUSCA E FILTROS -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-sage/20 mb-6 sticky top-20 z-30">
              <div class="relative mb-3">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400" aria-hidden="true">ğŸ”</span>
                <input type="search" id="busca-marmitas" placeholder="Buscar por nome do prato ou ingrediente..." 
                       class="w-full pl-10 pr-4 py-3 bg-cream/50 border border-sage/30 rounded-xl focus:outline-forest text-sm transition-all"
                       oninput="filtrarMarmitas()" aria-label="Buscar pratos">
              </div>
              <div class="flex gap-2 overflow-x-auto pb-2 -mx-2 px-2 snap-x" id="filtros-categoria" aria-label="Filtros de categoria">
                <!-- BotÃµes de filtro via JS -->
              </div>
            </div>
            <div id="marmitas-container" class="grid grid-cols-1 gap-3 mb-8" aria-live="polite"></div>
          </article>

          <article id="secao-vegetais" class="hidden mb-8 fade-in">
            <div class="bg-white rounded-3xl p-6 shadow-sm border-2 border-green-100">
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-display text-xl text-forest">ğŸ¥¦ Escolha seus Vegetais</h3>
                <div class="flex items-center gap-1 bg-green-50 px-3 py-1 rounded-full" aria-live="polite">
                  <span class="text-sm font-bold text-green-700" id="vegetal-counter">0</span>
                  <span class="text-sm text-gray-400" id="vegetal-counter-max"></span>
                </div>
              </div>
              <div class="bg-green-50 rounded-xl px-4 py-3 mb-5">
                <p class="text-sm text-green-700 font-medium" id="vegetal-instrucao"></p>
                <p class="text-xs text-green-600 mt-1">ğŸ’¡ Os vegetais sÃ£o <strong>adicionais</strong> ao seu kit â€” nÃ£o contam no limite de marmitas</p>
              </div>
              <div id="vegetais-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
          </article>

          <article class="bg-white rounded-3xl p-6 shadow-sm border border-sage/20 mb-8">
            <h3 class="font-display text-2xl text-forest mb-6">PreferÃªncias deste Combo</h3>
            <div class="mb-6">
              <fieldset>
                <legend class="block text-xs font-bold uppercase text-gray-400 mb-2 ml-1">PreferÃªncia de Tempero</legend>
                <div class="flex gap-2">
                  <button type="button" onclick="setSpiceLevel(1)" aria-pressed="false" class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">ğŸŒ¿ Suave</button>
                  <button type="button" onclick="setSpiceLevel(2)" aria-pressed="true" class="spice-btn flex-1 py-3 border-2 border-forest bg-forest/5 rounded-xl font-bold">ğŸŒ¶ï¸ MÃ©dio</button>
                  <button type="button" onclick="setSpiceLevel(3)" aria-pressed="false" class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">ğŸ”¥ Picante</button>
                </div>
              </fieldset>
            </div>
            <div>
              <label for="observations" class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">ObservaÃ§Ãµes Especiais</label>
              <textarea id="observations" placeholder="Ex: Sem cebola, restriÃ§Ãµes alimentares..." class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest h-24"></textarea>
            </div>
          </article>

          <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 md:p-6 flex flex-col md:flex-row justify-between items-center shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-40">
            <div class="text-center md:text-left mb-4 md:mb-0">
              <p class="text-xs text-gray-400 uppercase font-bold">Subtotal do Combo</p>
              <p id="total-price" class="text-3xl font-display text-terracotta">R$ 0,00</p>
            </div>
            <button onclick="adicionarAoCarrinho()" class="w-full md:w-auto bg-forest text-white px-12 py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2 text-lg">
              ğŸ›’ Adicionar ao Carrinho
            </button>
          </div>

        </div>
      </section>

      <!-- ===== PÃGINAS DO ADMIN ===== -->
      <section id="page-dashboard" class="hidden fade-in">
        <h2 class="text-2xl font-bold mb-6 font-display text-forest">Painel Administrativo</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Combos</p>
            <p class="text-3xl font-bold text-forest" id="stat-combos">0</p>
            <p class="text-xs text-sage mt-1" id="stat-combos-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Itens no CardÃ¡pio</p>
            <p class="text-3xl font-bold text-forest" id="stat-marmitas">0</p>
            <p class="text-xs text-sage mt-1" id="stat-marmitas-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Pedidos</p>
            <p class="text-3xl font-bold text-terracotta" id="stat-total-pedidos">0</p>
            <p class="text-xs text-sage mt-1">histÃ³rico completo</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Faturamento Total</p>
            <p class="text-3xl font-bold text-forest" id="stat-faturamento">R$ 0</p>
            <p class="text-xs text-sage mt-1">todos os pedidos</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
          <h3 class="font-bold text-lg mb-4">AÃ§Ãµes RÃ¡pidas</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="showPage('pedidos')" class="border-2 border-terracotta text-terracotta px-4 py-3 rounded-xl font-bold hover:bg-terracotta hover:text-white transition-all text-sm">ğŸ“‹ Ver Pedidos</button>
            <button onclick="exportarBancoDados()" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">â¬‡ï¸ Exportar Dados</button>
            <button onclick="showPage('combos')" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">ğŸ“¦ Combos</button>
            <button onclick="showPage('marmitas')" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">ğŸ± CardÃ¡pio</button>
          </div>
        </div>
      </section>

      <section id="page-pedidos" class="hidden fade-in">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold font-display text-forest">ğŸ“‹ Pedidos Recebidos</h2>
          <button onclick="exportarBancoDados()" class="bg-forest text-white px-5 py-3 rounded-xl font-bold hover:scale-105 transition-all text-sm active:scale-95">â¬‡ï¸ Exportar Banco de Dados</button>
        </div>
        <!-- FILTRO POR DATA -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 mb-6">
          <p class="text-xs font-bold uppercase text-gray-400 mb-3">Filtrar por PerÃ­odo</p>
          <div class="flex flex-col md:flex-row gap-3 items-end">
            <div class="flex-1">
              <label for="filtro-data-inicio" class="block text-xs text-gray-500 mb-1">Data inicial</label>
              <input type="date" id="filtro-data-inicio" class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <div class="flex-1">
              <label for="filtro-data-fim" class="block text-xs text-gray-500 mb-1">Data final</label>
              <input type="date" id="filtro-data-fim" class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <button onclick="aplicarFiltroData()" class="bg-forest text-white px-6 py-2 rounded-xl font-bold hover:bg-forest/90 transition-all whitespace-nowrap">Filtrar</button>
            <button onclick="limparFiltro()" class="border border-gray-300 text-gray-500 px-6 py-2 rounded-xl font-bold hover:bg-gray-50 transition-all whitespace-nowrap">Ver Todos</button>
          </div>
        </div>
        <!-- CARDS FATURAMENTO -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20"><p class="text-gray-400 text-xs mb-1">Pedidos</p><p class="text-3xl font-bold text-forest" id="periodo-qtd-pedidos">0</p></div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20"><p class="text-gray-400 text-xs mb-1">Faturamento</p><p class="text-2xl font-bold text-terracotta" id="periodo-faturamento">R$ 0,00</p></div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20"><p class="text-gray-400 text-xs mb-1">Ticket MÃ©dio</p><p class="text-2xl font-bold text-forest" id="periodo-ticket-medio">R$ 0,00</p></div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20"><p class="text-gray-400 text-xs mb-1">Total de Itens</p><p class="text-3xl font-bold text-forest" id="periodo-total-itens">0</p></div>
        </div>
        <!-- TABELA DE PEDIDOS -->
        <div class="bg-white rounded-2xl shadow-sm border border-sage/20 mb-6 overflow-hidden">
          <div class="p-5 border-b border-sage/10 flex justify-between items-center"><p class="font-bold text-forest">Lista de Pedidos</p><p class="text-xs text-gray-400" id="pedidos-periodo-label">Todos os pedidos</p></div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-400 uppercase text-xs"><tr><th class="px-4 py-3 text-left">Data/Hora</th><th class="px-4 py-3 text-left">Cliente</th><th class="px-4 py-3 text-left">WhatsApp</th><th class="px-4 py-3 text-left">Resumo</th><th class="px-4 py-3 text-right">Total</th><th class="px-4 py-3 text-center">AÃ§Ãµes</th></tr></thead>
              <tbody id="tabela-pedidos" class="divide-y divide-gray-50"></tbody>
            </table>
          </div>
          <div id="pedidos-vazio" class="hidden p-12 text-center text-gray-400"><p class="text-4xl mb-3">ğŸ“­</p><p class="font-bold">Nenhum pedido encontrado</p></div>
        </div>
        <!-- RANKINGS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10"><p class="font-bold text-forest">ğŸ“¦ Faturamento por Combo</p></div>
            <div id="ranking-combos" class="p-4 space-y-3"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10"><p class="font-bold text-forest">ğŸ± Itens mais pedidos</p></div>
            <div id="ranking-itens" class="p-4 space-y-3"></div>
          </div>
        </div>
      </section>

      <section id="page-combos" class="hidden fade-in">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar Combos</h2>
          <button onclick="abrirModalCombo()" class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all active:scale-95">+ Novo Combo</button>
        </div>
        <div id="combos-admin-list" class="space-y-3"></div>
      </section>

      <section id="page-marmitas" class="hidden fade-in">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar CardÃ¡pio</h2>
          <button onclick="abrirModalMarmita()" class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all active:scale-95">+ Novo Item</button>
        </div>
        <div id="marmitas-admin-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>

    </main>
  </div>

  <!-- ==================== BOTÃƒO FLUTUANTE CARRINHO ==================== -->
  <button id="btn-floating-cart" onclick="toggleCart()" class="hidden fixed bottom-6 right-6 md:bottom-10 md:right-10 bg-terracotta text-white p-4 rounded-full shadow-2xl hover:bg-terracotta/90 transition-all z-50 flex items-center justify-center gap-2 group active:scale-95" aria-label="Abrir Carrinho de Compras">
    <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ›’</span>
    <span id="cart-badge-floating" class="bg-white text-terracotta text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-inner">0</span>
  </button>

  <!-- ==================== GAVETA DO CARRINHO (SLIDE OVER) ==================== -->
  <div id="cart-sidebar-container" class="fixed inset-0 z-[100] hidden" aria-modal="true" role="dialog">
    <div id="cart-backdrop" class="absolute inset-0 modal-bg opacity-0 transition-opacity duration-300 cursor-pointer" onclick="toggleCart()" aria-label="Fechar Carrinho"></div>
    <div id="cart-panel" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
      <div class="p-6 border-b border-sage/20 flex justify-between items-center bg-cream">
        <h2 class="font-display text-2xl text-forest flex items-center gap-2">ğŸ›’ Seu Carrinho</h2>
        <button onclick="toggleCart()" class="text-gray-400 hover:text-terracotta text-2xl p-2 transition-colors" aria-label="Fechar Gaveta">âœ•</button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="cart-items-container"></div>
      <div class="p-6 border-t border-sage/20 bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)]" id="cart-checkout-form">
        <h3 class="font-bold text-forest mb-4">ğŸ“ Dados para Entrega</h3>
        <div class="space-y-3 mb-6">
          <input id="cliente-nome" type="text" placeholder="Seu Nome Completo *" class="w-full px-4 py-3 border border-sage/30 rounded-xl focus:outline-forest text-sm bg-gray-50">
          <input id="cliente-tel" type="tel" placeholder="WhatsApp * (Ex: 47999999999)" class="w-full px-4 py-3 border border-sage/30 rounded-xl focus:outline-forest text-sm bg-gray-50">
          <input id="cliente-endereco" type="text" placeholder="EndereÃ§o (Rua, NÂº, Ref) *" class="w-full px-4 py-3 border border-sage/30 rounded-xl focus:outline-forest text-sm bg-gray-50">
          <input id="cliente-cidade" type="text" placeholder="Cidade *" class="w-full px-4 py-3 border border-sage/30 rounded-xl focus:outline-forest text-sm bg-gray-50">
        </div>
        <div class="flex justify-between items-end mb-4">
          <span class="text-gray-500 font-bold uppercase text-xs">Total a Pagar</span>
          <span id="cart-total-price" class="font-display text-3xl text-terracotta font-bold">R$ 0,00</span>
        </div>
        <button onclick="finalizarPedidoFinal()" id="btn-finalizar-whatsapp" class="w-full bg-forest text-white py-4 rounded-xl font-bold hover:bg-forest/90 active:scale-95 transition-all shadow-lg flex justify-center items-center gap-2 text-lg">
          ğŸ“± Enviar Pedido
        </button>
      </div>
    </div>
  </div>

</div>

<!-- ==================== TOAST NOTIFICATION ==================== -->
<div id="toast" role="alert" aria-live="assertive" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-charcoal text-white px-8 py-4 rounded-2xl shadow-2xl z-[110] font-bold text-center max-w-sm"></div>

<script>
  // ============================================================
  // FIREBASE CONFIG
  // ============================================================
  const firebaseConfig = {
    apiKey: "AIzaSyBL0z6PwA6Ik_U671G7HJZLsHT9udCT7YI",
    authDomain: "sabor-e-saude-a233e.firebaseapp.com",
    databaseURL: "https://sabor-e-saude-a233e-default-rtdb.firebaseio.com",
    projectId: "sabor-e-saude-a233e",
    storageBucket: "sabor-e-saude-a233e.firebasestorage.app",
    messagingSenderId: "283293618461",
    appId: "1:283293618461:web:1db0ad8b6db9f145d791f4",
    measurementId: "G-R6LW9FKEQF"
  };

  const WHATSAPP_RESTAURANTE = "5547996988109";

  let database;
  let firebaseInitialized = false;
  try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseInitialized = true;
  } catch(e) {
    console.warn("Firebase nÃ£o configurado. Usando localStorage.");
  }

  // ============================================================
  // ESTADO GLOBAL
  // ============================================================
  let isAdmin          = false;
  let sidebarVisible   = true;
  let currentCombo     = null;
  let quantities       = {};
  let vegetaisSelecionados = [];
  let spiceLevel       = 2;
  let maxMarmitas      = 0;
  
  let searchTerm       = '';
  let activeCategory   = 'todas';
  let carrinhoCompras  = [];

  let marmitasCache    = [];
  let combosCache      = [];
  let pedidosCache     = [];
  let pedidoAtualModal = null;

  const CAT_ICONS = { marmita:'ğŸ± Marmitas', sopa:'ğŸ² Sopas', suco:'ğŸ¥¤ Sucos', sobremesa:'ğŸ° Sobremesas', proteico:'ğŸ’ª Proteicos', 'low-carb':'ğŸ¥— Low Carb', vegano:'ğŸŒ± Veganos', vegetal:'ğŸ¥¦ Vegetais' };
  const CAT_EMOJI = { marmita:'ğŸ±', sopa:'ğŸ²', suco:'ğŸ¥¤', sobremesa:'ğŸ°', proteico:'ğŸ’ª', 'low-carb':'ğŸ¥—', vegano:'ğŸŒ±', vegetal:'ğŸ¥¦' };

  // ============================================================
  // UTILITÃRIOS VISUAIS E FEEDBACKS
  // ============================================================
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hidden', 'animate-slide-in');
    void t.offsetWidth; // Force reflow
    t.classList.add('animate-slide-in');
    setTimeout(() => t.classList.add('hidden'), 3500);
  }

  function showLoading(show, text = 'A processar...') {
    const loader = document.getElementById('loading');
    document.getElementById('loading-text').textContent = text;
    if(show) loader.classList.remove('hidden');
    else loader.classList.add('hidden');
  }

  // ============================================================
  // FIREBASE / CRUD HELPERS
  // ============================================================
  async function fbGet(path) { if (!firebaseInitialized) return null; const snap = await database.ref(path).once('value'); return snap.val(); }
  async function fbSet(path, value) { if (!firebaseInitialized) return; await database.ref(path).set(value); }
  async function fbRemove(path) { if (!firebaseInitialized) return; await database.ref(path).remove(); }
  function lsGet(key) { return JSON.parse(localStorage.getItem(key) || '[]'); }
  function lsSet(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

  async function getMarmitas() { if (!firebaseInitialized) return lsGet('marmitas_fit_data'); const d = await fbGet('marmitas'); return d ? Object.values(d) : []; }
  async function saveMarmita(m) { 
    showLoading(true); 
    if (!firebaseInitialized) { let list = lsGet('marmitas_fit_data'); const i = list.findIndex(x => x.id === m.id); i !== -1 ? list[i] = m : list.push(m); lsSet('marmitas_fit_data', list); } 
    else { await fbSet(`marmitas/${m.id}`, m); } 
    showLoading(false); 
  }
  async function deleteMarmita(id) { 
    showLoading(true); 
    if (!firebaseInitialized) { lsSet('marmitas_fit_data', lsGet('marmitas_fit_data').filter(m => m.id !== id)); } 
    else { await fbRemove(`marmitas/${id}`); } 
    showLoading(false); 
  }
  
  async function getCombos() { if (!firebaseInitialized) return lsGet('combos_fit_data'); const d = await fbGet('combos'); return d ? Object.values(d) : []; }
  async function saveCombo(c) { 
    showLoading(true); 
    if (!firebaseInitialized) { let list = lsGet('combos_fit_data'); const i = list.findIndex(x => x.id === c.id); i !== -1 ? list[i] = c : list.push(c); lsSet('combos_fit_data', list); } 
    else { await fbSet(`combos/${c.id}`, c); } 
    showLoading(false); 
  }
  async function deleteCombo(id) { 
    showLoading(true); 
    if (!firebaseInitialized) { lsSet('combos_fit_data', lsGet('combos_fit_data').filter(c => c.id !== id)); } 
    else { await fbRemove(`combos/${id}`); } 
    showLoading(false); 
  }
  
  async function getPedidos() { if (!firebaseInitialized) return lsGet('pedidos_fit_data'); const d = await fbGet('pedidos'); return d ? Object.values(d) : []; }
  async function savePedido(pedido) { 
    if (!firebaseInitialized) { let list = lsGet('pedidos_fit_data'); list.push(pedido); lsSet('pedidos_fit_data', list); } 
    else { await fbSet(`pedidos/${pedido.id}`, pedido); } 
    pedidosCache = await getPedidos(); 
  }
  async function excluirPedido(id) {
    if (!confirm('Excluir este pedido do banco de dados?')) return;
    showLoading(true, 'A excluir pedido...');
    if (!firebaseInitialized) { lsSet('pedidos_fit_data', lsGet('pedidos_fit_data').filter(p => p.id !== id)); } 
    else { await fbRemove(`pedidos/${id}`); }
    pedidosCache = await getPedidos();
    showToast('âœ… Pedido excluÃ­do!');
    aplicarFiltroData();
    atualizarDashboard();
    showLoading(false);
  }

  // ============================================================
  // INICIALIZAÃ‡ÃƒO E LISTENERS
  // ============================================================
  async function initData() {
    showLoading(true, 'A preparar cardÃ¡pio...');

    marmitasCache = await getMarmitas();
    combosCache   = await getCombos();
    pedidosCache  = await getPedidos();

    // Mock initial data se vazio
    if (marmitasCache.length === 0) {
      const iniciais = [
        { id:1, nome:'Frango com Batata Doce', preco:22.00, kcal:350, desc:'Peito de frango e batata doce dourada.', cat:'marmita', visivel:true, dispCombo:true },
        { id:2, nome:'Patinho com Arroz Integral', preco:25.00, kcal:400, desc:'Carne moÃ­da magra com legumes.', cat:'marmita', visivel:true, dispCombo:true },
        { id:3, nome:'Sopa de Legumes', preco:15.00, kcal:180, desc:'Sopa cremosa com legumes.', cat:'sopa', visivel:true, dispCombo:true },
        { id:4, nome:'BrÃ³colis', preco:0, kcal:35, desc:'BrÃ³colis no vapor.', cat:'vegetal', visivel:true, dispCombo:true }
      ];
      for (const m of iniciais) await saveMarmita(m);
      marmitasCache = iniciais;
    }

    if (combosCache.length === 0) {
      const iniciais = [ { id:1, nome:'Kit 10 Marmitas', qtd:10, preco_base:210.00, tipo:'aberto', visivel:true, itens:{}, vegetal_min:1, vegetal_max:3, lote_selecao: 1, itens_disponiveis: [1,2,3] } ];
      for (const c of iniciais) await saveCombo(c);
      combosCache = iniciais;
    }

    if (firebaseInitialized) {
      database.ref('marmitas').on('value', snap => { const d = snap.val(); marmitasCache = d ? Object.values(d) : []; renderCardapio(); if (isAdmin) { renderMarmitasAdmin(); atualizarDashboard(); } });
      database.ref('combos').on('value', snap => { const d = snap.val(); combosCache = d ? Object.values(d) : []; renderCardapio(); if (isAdmin) { renderCombosAdmin(); atualizarDashboard(); } });
      database.ref('pedidos').on('value', snap => { const d = snap.val(); pedidosCache = d ? Object.values(d) : []; atualizarBadgePedidos(); if (isAdmin) { atualizarDashboard(); aplicarFiltroData(); } });
    }

    // Datas default do Admin
    const hoje = new Date(); const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    document.getElementById('filtro-data-inicio').value = primeiroDia.toISOString().split('T')[0];
    document.getElementById('filtro-data-fim').value    = hoje.toISOString().split('T')[0];

    // Recupera Carrinho do LocalStorage
    const cartSalvo = lsGet('current_cart');
    if (cartSalvo && cartSalvo.length) {
      carrinhoCompras = cartSalvo;
      atualizarBadgeCarrinho();
    }

    renderCardapio();
    showLoading(false);
  }

  // ============================================================
  // NAVEGAÃ‡ÃƒO E ADMIN (BASE)
  // ============================================================
  function showPage(pageId) {
    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
    const p = document.getElementById(`page-${pageId}`);
    if (p) p.classList.remove('hidden');
    if (pageId === 'dashboard') atualizarDashboard();
    if (pageId === 'combos')    renderCombosAdmin();
    if (pageId === 'marmitas')  renderMarmitasAdmin();
    if (pageId === 'pedidos')   aplicarFiltroData();
  }

  function toggleSidebar() {
    const sb = document.getElementById('sidebar'); const btn = document.getElementById('btn-toggle-sidebar');
    sidebarVisible = !sidebarVisible;
    if (sidebarVisible) { sb.classList.remove('hidden'); btn.textContent = 'â˜°'; } 
    else { sb.classList.add('hidden'); btn.textContent = 'â˜°'; }
  }

  function openAdminModal()  { document.getElementById('admin-modal').classList.remove('hidden'); }
  function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); document.getElementById('login-error').classList.add('hidden'); }
  
  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('login-username').value.trim(); const p = document.getElementById('login-password').value;
    if (u === 'admin' && p === 'admin123') {
      isAdmin = true; closeAdminModal();
      document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('btn-toggle-sidebar').classList.remove('hidden'); document.getElementById('btn-admin-view').classList.add('hidden');
      showPage('dashboard'); atualizarBadgePedidos(); showToast('âœ… Login realizado!');
    } else { document.getElementById('login-error').classList.remove('hidden'); }
  }

  function entrarComoCliente() {
    isAdmin = false; sidebarVisible = true;
    document.getElementById('sidebar').classList.add('hidden'); document.getElementById('btn-toggle-sidebar').classList.add('hidden'); document.getElementById('btn-admin-view').classList.remove('hidden');
    showPage('cardapio');
  }

  function atualizarBadgePedidos() {
    const badge = document.getElementById('badge-pedidos');
    if (pedidosCache.length > 0) { badge.textContent = pedidosCache.length; badge.classList.remove('hidden'); } 
    else { badge.classList.add('hidden'); }
  }

  function exportarBancoDados() {
    const dbExport = { marmitas: marmitasCache, combos: combosCache, pedidos: pedidosCache, data_exportacao: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(dbExport, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `sabor_saude_backup_${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('âœ… Download do backup concluÃ­do!');
  }

  function abrirCotacaoEspecial() {
    const msg = encodeURIComponent(`OlÃ¡! Vim pelo cardÃ¡pio digital da Sabor e SaÃºde ğŸ¥—\n\nTenho uma dieta diferenciada e gostaria de uma cotaÃ§Ã£o personalizada.\n\nPoderia me ajudar?`);
    window.open(`https://wa.me/${WHATSAPP_RESTAURANTE}?text=${msg}`, '_blank');
  }

  // ============================================================
  // DASHBOARD ADMIN (COMPLETO)
  // ============================================================
  function atualizarDashboard() {
    if (!isAdmin) return;
    
    // Cards Topo
    document.getElementById('stat-combos').textContent = combosCache.length;
    document.getElementById('stat-combos-visiveis').textContent = combosCache.filter(c => c.visivel !== false).length + ' visÃ­veis';
    
    document.getElementById('stat-marmitas').textContent = marmitasCache.length;
    document.getElementById('stat-marmitas-visiveis').textContent = marmitasCache.filter(m => m.visivel !== false).length + ' visÃ­veis';
    
    document.getElementById('stat-total-pedidos').textContent = pedidosCache.length;
    
    const totalFat = pedidosCache.reduce((sum, p) => sum + (p.total || 0), 0);
    document.getElementById('stat-faturamento').textContent = `R$ ${totalFat.toFixed(2)}`;
  }

  // ============================================================
  // PEDIDOS ADMIN (FILTROS E TABELA)
  // ============================================================
  function aplicarFiltroData() {
    if (!isAdmin) return;
    const dtIn = document.getElementById('filtro-data-inicio').value;
    const dtFim = document.getElementById('filtro-data-fim').value;
    
    let listaFiltrada = pedidosCache;

    if (dtIn && dtFim) {
      const dataInicio = new Date(dtIn + 'T00:00:00');
      const dataFim = new Date(dtFim + 'T23:59:59');
      listaFiltrada = pedidosCache.filter(p => {
        const d = new Date(p.timestamp);
        return d >= dataInicio && d <= dataFim;
      });
      document.getElementById('pedidos-periodo-label').textContent = `${dtIn.split('-').reverse().join('/')} atÃ© ${dtFim.split('-').reverse().join('/')}`;
    } else {
      document.getElementById('pedidos-periodo-label').textContent = 'Todos os pedidos';
    }

    listaFiltrada.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    renderTabelaPedidos(listaFiltrada);
    atualizarEstatisticasPedidos(listaFiltrada);
    renderRankings(listaFiltrada);
  }

  function limparFiltro() {
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value = '';
    aplicarFiltroData();
  }

  function renderTabelaPedidos(lista) {
    const tbody = document.getElementById('tabela-pedidos');
    const vazio = document.getElementById('pedidos-vazio');
    
    if (lista.length === 0) {
      tbody.innerHTML = '';
      vazio.classList.remove('hidden');
      return;
    }
    vazio.classList.add('hidden');

    tbody.innerHTML = lista.map(p => {
      const data = new Date(p.timestamp).toLocaleString('pt-BR');
      return `
        <tr class="table-row border-b border-gray-50">
          <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">${data}</td>
          <td class="px-4 py-3 font-bold text-forest">${p.cliente_nome}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${p.cliente_tel}</td>
          <td class="px-4 py-3 text-xs text-gray-500 max-w-[200px] truncate" title="${p.combo_nome}">${p.combo_nome}</td>
          <td class="px-4 py-3 text-right font-bold text-terracotta">R$ ${(p.total||0).toFixed(2)}</td>
          <td class="px-4 py-3 text-center">
            <button onclick="abrirModalPedido('${p.id}')" class="text-xs bg-sage/20 text-forest px-3 py-1 rounded-lg hover:bg-sage/40 font-bold mr-1">Ver</button>
            <button onclick="excluirPedido('${p.id}')" class="text-xs bg-red-50 text-red-500 px-3 py-1 rounded-lg hover:bg-red-100 font-bold">Excluir</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function atualizarEstatisticasPedidos(lista) {
    const qtd = lista.length;
    const faturamento = lista.reduce((sum, p) => sum + (p.total || 0), 0);
    const ticket = qtd > 0 ? (faturamento / qtd) : 0;
    const itens = lista.reduce((sum, p) => sum + (p.qtd_itens || 0), 0);

    document.getElementById('periodo-qtd-pedidos').textContent = qtd;
    document.getElementById('periodo-faturamento').textContent = `R$ ${faturamento.toFixed(2)}`;
    document.getElementById('periodo-ticket-medio').textContent = `R$ ${ticket.toFixed(2)}`;
    document.getElementById('periodo-total-itens').textContent = itens;
  }

  function renderRankings(lista) {
    const boxCombos = document.getElementById('ranking-combos');
    const boxItens = document.getElementById('ranking-itens');

    // Rank Combos (Por Faturamento)
    const mapCombos = {};
    lista.forEach(p => {
      const nome = p.combo_nome || 'Outros';
      mapCombos[nome] = (mapCombos[nome] || 0) + (p.total || 0);
    });
    const rankCombos = Object.entries(mapCombos).sort((a,b) => b[1] - a[1]).slice(0,5);
    
    if (rankCombos.length === 0) {
      boxCombos.innerHTML = '<p class="text-gray-400 text-sm italic">Sem dados suficientes</p>';
    } else {
      boxCombos.innerHTML = rankCombos.map((c, i) => `
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-400 w-4">${i+1}</span>
            <span class="text-sm font-bold text-forest">${c[0]}</span>
          </div>
          <span class="text-sm font-bold text-terracotta">R$ ${c[1].toFixed(2)}</span>
        </div>
      `).join('');
    }

    // Rank Itens Individuais (Por Quantidade)
    const mapItens = {};
    lista.forEach(p => {
      if (p.itens_detalhes) {
        Object.entries(p.itens_detalhes).forEach(([nome, qtd]) => {
          mapItens[nome] = (mapItens[nome] || 0) + qtd;
        });
      }
    });
    const rankItens = Object.entries(mapItens).sort((a,b) => b[1] - a[1]).slice(0,5);

    if (rankItens.length === 0) {
      boxItens.innerHTML = '<p class="text-gray-400 text-sm italic">Sem dados suficientes</p>';
    } else {
      boxItens.innerHTML = rankItens.map((item, i) => `
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-400 w-4">${i+1}</span>
            <span class="text-sm font-medium text-charcoal truncate max-w-[150px]" title="${item[0].replace('Vegetal_', '')}">${item[0].replace('Vegetal_', 'ğŸ¥¦ ')}</span>
          </div>
          <span class="text-xs bg-sage/20 text-forest px-2 py-1 rounded-full font-bold">${item[1]}x</span>
        </div>
      `).join('');
    }
  }

  function abrirModalPedido(id) {
    const pedido = pedidosCache.find(p => p.id === id);
    if (!pedido) return;
    pedidoAtualModal = pedido;

    let htmlDetalhes = '';
    if (pedido.itens_detalhes && Object.keys(pedido.itens_detalhes).length > 0) {
      htmlDetalhes = `<ul class="space-y-1 mt-2">`;
      Object.entries(pedido.itens_detalhes).forEach(([item, q]) => {
        const isVeg = item.startsWith('Vegetal_');
        const prefix = isVeg ? 'ğŸ¥¦ ' : 'â€¢ ';
        const nome = isVeg ? item.replace('Vegetal_', '') : item;
        htmlDetalhes += `<li class="text-sm text-gray-600 border-b border-gray-100 pb-1">${prefix} ${q}x ${nome}</li>`;
      });
      htmlDetalhes += `</ul>`;
    }

    const html = `
      <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
        <p class="text-xs text-gray-400 uppercase font-bold mb-1">Cliente</p>
        <p class="font-bold text-forest text-lg">${pedido.cliente_nome}</p>
        <p class="text-sm text-gray-600">ğŸ“± ${pedido.cliente_tel}</p>
        <p class="text-sm text-gray-600 mt-2">ğŸ“ ${pedido.cliente_endereco} - ${pedido.cliente_cidade}</p>
      </div>
      <div class="bg-white p-4 rounded-xl border border-sage/30">
        <p class="text-xs text-gray-400 uppercase font-bold mb-2">Resumo do Pedido</p>
        <p class="font-bold text-forest mb-1">ğŸ“¦ ${pedido.combo_nome}</p>
        <p class="text-xs text-gray-500 mb-2">Tempero: ${pedido.tempero}</p>
        ${htmlDetalhes}
      </div>
      <div class="bg-terracotta/5 p-4 rounded-xl border border-terracotta/20">
        <p class="text-xs text-gray-400 uppercase font-bold mb-1">ObservaÃ§Ãµes do Cliente</p>
        <p class="text-sm font-medium text-terracotta">${pedido.observacoes || 'Nenhuma observaÃ§Ã£o.'}</p>
      </div>
      <div class="flex justify-between items-center mt-4">
        <span class="text-gray-400 text-sm">Data: ${new Date(pedido.timestamp).toLocaleString('pt-BR')}</span>
        <span class="font-display text-2xl text-terracotta font-bold">R$ ${(pedido.total||0).toFixed(2)}</span>
      </div>
    `;

    document.getElementById('modal-pedido-content').innerHTML = html;
    document.getElementById('modal-pedido').classList.remove('hidden');
  }

  function closeModalPedido() {
    document.getElementById('modal-pedido').classList.add('hidden');
    pedidoAtualModal = null;
  }

  function abrirWhatsAppCliente() {
    if (!pedidoAtualModal) return;
    let tel = pedidoAtualModal.cliente_tel.replace(/\D/g, '');
    if (!tel.startsWith('55')) tel = '55' + tel;
    const msg = encodeURIComponent(`OlÃ¡ ${pedidoAtualModal.cliente_nome}, tudo bem? Aqui Ã© da Sabor e SaÃºde, referente ao seu pedido de ${pedidoAtualModal.combo_nome}.`);
    window.open(`https://wa.me/${tel}?text=${msg}`, '_blank');
  }

  // ============================================================
  // ADMIN - MARMITAS
  // ============================================================
  function renderMarmitasAdmin() {
    const el = document.getElementById('marmitas-admin-list');
    if (!marmitasCache.length) { el.innerHTML = '<p class="text-gray-400">Nenhum item cadastrado.</p>'; return; }
    
    el.innerHTML = marmitasCache.map(m => `
      <div class="bg-white p-4 rounded-2xl shadow-sm border ${m.visivel ? 'border-sage/30' : 'border-gray-200 opacity-60'}">
        <div class="flex justify-between items-start mb-2">
          <div>
            <span class="text-[10px] font-bold uppercase text-white px-2 py-0.5 rounded-full ${m.visivel ? 'bg-forest' : 'bg-gray-400'}">${CAT_EMOJI[m.cat]||''} ${m.cat}</span>
            <h3 class="font-bold text-forest mt-1">${m.nome}</h3>
          </div>
          <span class="font-bold text-terracotta">R$ ${m.preco.toFixed(2)}</span>
        </div>
        <p class="text-xs text-gray-500 mb-3 truncate" title="${m.desc}">${m.desc} (${m.kcal} kcal)</p>
        <div class="flex items-center justify-between border-t border-gray-100 pt-3">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" ${m.visivel ? 'checked' : ''} onchange="toggleMarmitaVisivel(${m.id}, this.checked)" class="w-4 h-4 rounded text-forest focus:ring-forest">
            <span class="text-xs font-bold text-gray-500">VisÃ­vel</span>
          </label>
          <div class="flex gap-2">
            <button onclick="abrirModalMarmita(${m.id})" class="text-xs bg-sage/20 text-forest px-3 py-1.5 rounded-lg hover:bg-sage/40 font-bold">âœï¸ Editar</button>
            <button onclick="excluirMarmitaAdmin(${m.id})" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-100 font-bold">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function abrirModalMarmita(id = null) {
    const title = document.getElementById('modal-marmita-title');
    const form = document.getElementById('modal-marmita').querySelector('form');
    form.reset();
    
    if (id) {
      const m = marmitasCache.find(x => x.id === id);
      if (m) {
        title.textContent = 'Editar Item';
        document.getElementById('edit-marmita-id').value = m.id;
        document.getElementById('marmita-nome').value = m.nome;
        document.getElementById('marmita-preco').value = m.preco;
        document.getElementById('marmita-kcal').value = m.kcal;
        document.getElementById('marmita-desc').value = m.desc;
        document.getElementById('marmita-cat').value = m.cat;
        document.getElementById('marmita-visivel').checked = m.visivel !== false;
        document.getElementById('marmita-disponivel-combo').checked = m.dispCombo !== false;
      }
    } else {
      title.textContent = 'Novo Item';
      document.getElementById('edit-marmita-id').value = '';
      document.getElementById('marmita-visivel').checked = true;
      document.getElementById('marmita-disponivel-combo').checked = true;
    }
    document.getElementById('modal-marmita').classList.remove('hidden');
  }

  function closeModalMarmita() { document.getElementById('modal-marmita').classList.add('hidden'); }

  async function salvarMarmita(e) {
    e.preventDefault();
    const id = document.getElementById('edit-marmita-id').value;
    const m = {
      id: id ? parseInt(id) : (marmitasCache.length ? Math.max(...marmitasCache.map(x=>x.id))+1 : 1),
      nome: document.getElementById('marmita-nome').value.trim(),
      preco: parseFloat(document.getElementById('marmita-preco').value),
      kcal: parseInt(document.getElementById('marmita-kcal').value),
      desc: document.getElementById('marmita-desc').value.trim(),
      cat: document.getElementById('marmita-cat').value,
      visivel: document.getElementById('marmita-visivel').checked,
      dispCombo: document.getElementById('marmita-disponivel-combo').checked
    };
    await window.saveMarmita(m); // Usa a funÃ§Ã£o base
    showToast(id ? 'âœ… Item atualizado!' : 'âœ… Item criado!');
    closeModalMarmita();
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }

  async function excluirMarmitaAdmin(id) {
    if (!confirm('Excluir este item?')) return;
    await deleteMarmita(id);
    showToast('âœ… Item excluÃ­do!');
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }

  async function toggleMarmitaVisivel(id, visivel) {
    const m = marmitasCache.find(x => x.id === id);
    if(m) { m.visivel = visivel; await window.saveMarmita(m); if (!firebaseInitialized) renderMarmitasAdmin(); renderCardapio(); }
  }

  // ============================================================
  // ADMIN - COMBOS
  // ============================================================
  function renderCombosAdmin() {
    const el = document.getElementById('combos-admin-list');
    if (!combosCache.length) { el.innerHTML = '<p class="text-gray-400">Nenhum combo cadastrado.</p>'; return; }

    el.innerHTML = combosCache.map(c => `
      <div class="bg-white p-5 rounded-2xl shadow-sm border ${c.visivel ? 'border-sage/30' : 'border-gray-200 opacity-60'} flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-[10px] font-bold uppercase text-white px-2 py-0.5 rounded-full ${c.tipo==='fechado' ? 'bg-terracotta' : 'bg-sage'}">${c.tipo==='fechado' ? 'ğŸ“¦ Fechado' : 'ğŸ›’ Aberto'}</span>
            ${c.visivel ? '' : '<span class="text-[10px] font-bold uppercase text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">Oculto</span>'}
          </div>
          <h3 class="font-bold text-forest text-lg">${c.nome}</h3>
          <p class="text-xs text-gray-500">${c.tipo==='fechado' ? 'Itens prÃ©-definidos' : `${c.qtd} itens â€¢ R$ ${(c.preco_base/c.qtd).toFixed(2)} un.`} ${c.vegetal_max > 0 ? `â€¢ ğŸ¥¦ ${c.vegetal_max} vegetais` : ''}</p>
        </div>
        <div class="text-left md:text-right">
          <p class="font-display font-bold text-terracotta text-2xl mb-2">R$ ${c.preco_base.toFixed(2)}</p>
          <div class="flex gap-2 justify-start md:justify-end">
            <button onclick="abrirModalCombo(${c.id})" class="text-xs bg-sage/20 text-forest px-4 py-2 rounded-lg hover:bg-sage/40 font-bold transition-all">âœï¸ Editar</button>
            <button onclick="excluirComboAdmin(${c.id})" class="text-xs bg-red-50 text-red-500 px-4 py-2 rounded-lg hover:bg-red-100 font-bold transition-all">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function toggleTipoCombo() {
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    const configAberto = document.getElementById('config-aberto');
    const configFechado = document.getElementById('config-fechado');
    const inputQtd = document.getElementById('combo-qtd');
    const inputPreco = document.getElementById('combo-preco');
    const inputLote = document.getElementById('combo-lote');

    if (tipo === 'aberto') {
      configAberto.classList.remove('hidden');
      configFechado.classList.add('hidden');
      inputQtd.required = true;
      inputPreco.required = true;
      inputLote.required = true;
      document.getElementById('preco-unitario-preview').textContent = "Preencha Qtd e PreÃ§o para ver o valor unitÃ¡rio";
    } else {
      configAberto.classList.add('hidden');
      configFechado.classList.remove('hidden');
      inputQtd.required = false;
      inputPreco.required = false;
      inputLote.required = false;
      renderItensFechadoAdmin();
      document.getElementById('preco-unitario-preview').textContent = "Combo Fechado tem preÃ§o fixo pelo pacote inteiro";
    }
  }

  function marcarPratosCombo(check) {
    document.querySelectorAll('.check-prato-combo').forEach(cb => cb.checked = check);
  }

  function renderItensFechadoAdmin(itensSalvos = {}) {
    const container = document.getElementById('itens-combo-container');
    const disponiveis = marmitasCache.filter(m => m.cat !== 'vegetal');
    if (!disponiveis.length) { container.innerHTML = '<p class="text-xs text-red-500">Nenhuma marmita cadastrada no cardÃ¡pio ainda.</p>'; return; }

    container.innerHTML = disponiveis.map(m => `
      <div class="flex justify-between items-center py-2 border-b border-sage/10 last:border-0">
        <p class="text-sm font-medium text-forest truncate pr-2">${m.nome}</p>
        <div class="flex items-center gap-2">
          <input type="number" min="0" value="${itensSalvos[m.id] || 0}" data-id="${m.id}" class="w-16 px-2 py-1 border rounded text-center text-sm focus:outline-forest item-qtd-fechado">
        </div>
      </div>
    `).join('');
  }

  function abrirModalCombo(id = null) {
    const form = document.getElementById('modal-combo').querySelector('form');
    form.reset();
    document.getElementById('modal-combo-title').textContent = id ? 'Editar Combo' : 'Novo Combo';
    document.getElementById('edit-combo-id').value = id || '';

    // Render Checklist Abertos
    const containerAbertos = document.getElementById('checklist-pratos-abertos');
    const marmitasNormais = marmitasCache.filter(m => m.cat !== 'vegetal');
    containerAbertos.innerHTML = marmitasNormais.map(m => `
      <label class="flex items-center justify-between py-1.5 px-2 hover:bg-sage/5 rounded cursor-pointer border-b border-sage/5 last:border-0">
        <span class="text-xs text-charcoal font-medium truncate">${m.nome}</span>
        <input type="checkbox" value="${m.id}" class="check-prato-combo w-4 h-4 rounded text-forest focus:ring-forest" checked>
      </label>
    `).join('');

    if (id) {
      const c = combosCache.find(x => x.id === id);
      if (c) {
        document.getElementById('combo-nome').value = c.nome;
        document.getElementById('combo-visivel').checked = c.visivel !== false;
        document.querySelector(`input[name="tipo-combo"][value="${c.tipo}"]`).checked = true;
        document.getElementById('combo-vegetal-min').value = c.vegetal_min || 0;
        document.getElementById('combo-vegetal-max').value = c.vegetal_max || 0;

        if (c.tipo === 'fechado') {
          document.getElementById('combo-preco-fechado').value = c.preco_base;
          renderItensFechadoAdmin(c.itens || {});
        } else {
          document.getElementById('combo-qtd').value = c.qtd;
          document.getElementById('combo-preco').value = c.preco_base;
          document.getElementById('combo-lote').value = c.lote_selecao || 1;
          
          if (c.itens_disponiveis && c.itens_disponiveis.length > 0) {
            document.querySelectorAll('.check-prato-combo').forEach(cb => {
              cb.checked = c.itens_disponiveis.includes(parseInt(cb.value));
            });
          }
        }
      }
    } else {
      renderItensFechadoAdmin();
    }
    
    toggleTipoCombo();
    document.getElementById('modal-combo').classList.remove('hidden');
  }

  function closeModalCombo() { document.getElementById('modal-combo').classList.add('hidden'); }

  async function salvarCombo(e) {
    e.preventDefault();
    const id = document.getElementById('edit-combo-id').value;
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    const nome = document.getElementById('combo-nome').value.trim();
    const visivel = document.getElementById('combo-visivel').checked;
    const vegMin = parseInt(document.getElementById('combo-vegetal-min').value) || 0;
    const vegMax = parseInt(document.getElementById('combo-vegetal-max').value) || 0;

    let qtd = 0, preco_base = 0, itens = {}, lote_selecao = 1, itens_disponiveis = [];

    if (tipo === 'aberto') {
      qtd = parseInt(document.getElementById('combo-qtd').value);
      preco_base = parseFloat(document.getElementById('combo-preco').value);
      lote_selecao = parseInt(document.getElementById('combo-lote').value) || 1;
      
      const cbSelecionados = Array.from(document.querySelectorAll('.check-prato-combo:checked')).map(cb => parseInt(cb.value));
      const totalMarmitasNormais = marmitasCache.filter(m => m.cat !== 'vegetal').length;
      if (cbSelecionados.length < totalMarmitasNormais) {
        itens_disponiveis = cbSelecionados;
      }
    } else {
      preco_base = parseFloat(document.getElementById('combo-preco-fechado').value);
      document.querySelectorAll('.item-qtd-fechado').forEach(input => {
        const v = parseInt(input.value);
        if (v > 0) { itens[input.dataset.id] = v; qtd += v; }
      });
      if (qtd === 0) return showToast('âš ï¸ Adicione ao menos um item ao combo fechado!');
    }

    const combo = {
      id: id ? parseInt(id) : (combosCache.length ? Math.max(...combosCache.map(c=>c.id))+1 : 1),
      nome, qtd, preco_base, visivel, tipo, itens,
      vegetal_min: vegMin, vegetal_max: vegMax,
      lote_selecao, itens_disponiveis
    };

    await window.saveCombo(combo); // Chama funÃ§Ã£o raiz Firebase/LocalStorage
    showToast(id ? 'âœ… Combo atualizado!' : 'âœ… Combo criado!');
    closeModalCombo();
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  async function excluirComboAdmin(id) {
    if (!confirm('Excluir este combo permanentemente?')) return;
    await deleteCombo(id);
    showToast('âœ… Combo excluÃ­do!');
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  // PreÃ§o unitÃ¡rio dinÃ¢mico no modal
  document.getElementById('combo-qtd').addEventListener('input', updatePrecoPreview);
  document.getElementById('combo-preco').addEventListener('input', updatePrecoPreview);
  function updatePrecoPreview() {
    const q = parseInt(document.getElementById('combo-qtd').value);
    const p = parseFloat(document.getElementById('combo-preco').value);
    const el = document.getElementById('preco-unitario-preview');
    if (q > 0 && p > 0) el.textContent = `PreÃ§o unitÃ¡rio: R$ ${(p/q).toFixed(2)}`;
    else el.textContent = "Preencha Qtd e PreÃ§o para ver o valor unitÃ¡rio";
  }

  // ============================================================
  // CARDÃPIO HOME E SELEÃ‡ÃƒO DE COMBO (CLIENTE)
  // ============================================================
  function renderCardapio() {
    const visiveis = combosCache.filter(c => c.visivel !== false);
    const el = document.getElementById('combos-container');
    if (!visiveis.length) { el.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum combo disponÃ­vel.</p>'; return; }
    
    el.innerHTML = visiveis.map(c => {
      const badge = c.tipo === 'fechado' ? '<span class="text-xs bg-terracotta/20 text-terracotta px-2 py-1 rounded-full font-bold">ğŸ“¦ Fechado</span>' : '<span class="text-xs bg-sage/20 text-sage px-2 py-1 rounded-full font-bold">ğŸ›’ Aberto</span>';
      const vegInfo = (c.vegetal_max > 0) ? `<p class="text-xs text-green-600 mt-1">ğŸ¥¦ Inclui atÃ© ${c.vegetal_max} vegetal(is)</p>` : '';
      let infoExtra = '';
      if (c.tipo === 'fechado') {
        let totalItens = 0; const nomes = [];
        Object.entries(c.itens || {}).forEach(([itemId, qtd]) => { const m = marmitasCache.find(x => x.id === parseInt(itemId)); if (m && qtd > 0) { totalItens += qtd; nomes.push(`${qtd}x ${m.nome}`); } });
        const previa = nomes.slice(0, 3).join(', ') + (nomes.length > 3 ? ` +${nomes.length - 3} mais` : '');
        infoExtra = `<div class="mt-3 bg-cream rounded-xl p-3"><p class="text-xs font-bold text-forest mb-1">ğŸ“‹ ${totalItens} itens inclusos</p><p class="text-xs text-gray-400 leading-relaxed">${previa}</p></div>`;
      } else {
        infoExtra = `<p class="text-xs text-gray-400 mt-2">ğŸ’¡ Cada item sai por <span class="font-bold text-sage">R$ ${(c.preco_base / c.qtd).toFixed(2)}</span></p>`;
      }
      return `
        <article onclick="selecionarCombo(${c.id})" class="bg-white p-6 rounded-3xl border-2 border-transparent hover:border-forest shadow-sm text-left transition-all hover:-translate-y-1 cursor-pointer focus-within:ring-4 focus-within:ring-sage/30 outline-none" tabindex="0" role="button" aria-label="Selecionar ${c.nome}">
          <div class="flex justify-between items-start mb-2"><h3 class="text-forest font-bold text-xl">${c.nome}</h3>${badge}</div>
          <div class="mt-3"><span class="text-3xl font-display font-bold text-terracotta">R$ ${c.preco_base.toFixed(2)}</span></div>
          ${infoExtra}${vegInfo}
        </article>`;
    }).join('');
  }

  function selecionarCombo(id) {
    currentCombo = combosCache.find(c => c.id === id);
    if (!currentCombo) return showToast('âŒ Combo nÃ£o encontrado');

    maxMarmitas = currentCombo.qtd;
    quantities = {};
    vegetaisSelecionados = [];
    searchTerm = '';
    activeCategory = 'todas';
    setSpiceLevel(2);
    document.getElementById('observations').value = '';

    document.getElementById('home-combos').classList.add('hidden');
    document.getElementById('marmitas-section').classList.remove('hidden');
    document.getElementById('btn-voltar-combo').classList.remove('hidden');
    
    document.getElementById('combo-name-display').textContent = currentCombo.nome;
    document.getElementById('max-marmitas').textContent = maxMarmitas;
    document.getElementById('current-marmitas').textContent = '0';
    document.getElementById('combo-tipo-badge').textContent = currentCombo.tipo === 'fechado' ? 'ğŸ“¦ Combo Fechado' : 'ğŸ›’ VocÃª escolhe os itens';

    if (currentCombo.tipo === 'fechado') {
      mostrarComboFechado();
      document.getElementById('selecao-marmitas-container').classList.add('hidden');
      document.getElementById('progress-counter').classList.add('hidden');
    } else {
      document.getElementById('combo-fechado-itens').classList.add('hidden');
      document.getElementById('selecao-marmitas-container').classList.remove('hidden');
      document.getElementById('progress-counter').classList.remove('hidden');
      
      document.getElementById('busca-marmitas').value = '';
      renderFiltrosCategoria();
      renderMarmitas();
      
      const bar = document.getElementById('progress-bar'); if (bar) bar.style.width = '0%';
    }

    renderVegetais();
    atualizarTotalComboBase();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function resetarSelecaoAtual() {
    document.getElementById('marmitas-section').classList.add('hidden');
    document.getElementById('home-combos').classList.remove('hidden');
    document.getElementById('btn-voltar-combo').classList.add('hidden');
    currentCombo = null;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ============================================================
  // BUSCA E FILTROS 
  // ============================================================
  function renderFiltrosCategoria() {
    const el = document.getElementById('filtros-categoria');
    const categoriasPresentes = new Set();
    
    marmitasCache.forEach(m => {
      if (m.visivel && m.cat !== 'vegetal' && m.dispCombo !== false) {
        if (!currentCombo?.itens_disponiveis || currentCombo.itens_disponiveis.includes(m.id)) {
          categoriasPresentes.add(m.cat);
        }
      }
    });

    let html = `<button onclick="setCategoria('todas')" class="px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all border-2 active:scale-95 ${activeCategory === 'todas' ? 'bg-forest text-white border-forest' : 'bg-white text-gray-500 border-sage/30 hover:border-forest'}">ğŸ½ï¸ Todos</button>`;
    
    categoriasPresentes.forEach(cat => {
      const isAtivo = activeCategory === cat;
      const icone = CAT_EMOJI[cat] || 'ğŸ“¦';
      const nomeFormatado = cat.charAt(0).toUpperCase() + cat.slice(1);
      html += `<button onclick="setCategoria('${cat}')" class="px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all border-2 active:scale-95 ${isAtivo ? 'bg-forest text-white border-forest' : 'bg-white text-gray-500 border-sage/30 hover:border-forest'}">${icone} ${nomeFormatado}</button>`;
    });

    el.innerHTML = html;
  }

  function setCategoria(cat) {
    activeCategory = cat;
    renderFiltrosCategoria();
    renderMarmitas();
  }

  function filtrarMarmitas() {
    searchTerm = document.getElementById('busca-marmitas').value;
    renderMarmitas();
  }

  function renderMarmitas() {
    const lote = currentCombo?.lote_selecao || 1;

    const disponiveis = marmitasCache.filter(m => {
      if (!m.visivel || m.cat === 'vegetal' || m.dispCombo === false) return false;
      if (currentCombo?.itens_disponiveis && currentCombo.itens_disponiveis.length > 0 && !currentCombo.itens_disponiveis.includes(m.id)) return false;
      if (activeCategory !== 'todas' && m.cat !== activeCategory) return false;
      if (searchTerm && !m.nome.toLowerCase().includes(searchTerm.toLowerCase()) && !m.desc.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      return true;
    });

    const el = document.getElementById('marmitas-container');
    if (!disponiveis.length) {
      el.innerHTML = `<div class="text-center py-12 bg-white rounded-3xl border border-sage/20 shadow-sm"><p class="text-4xl mb-4" aria-hidden="true">ğŸ”</p><p class="text-gray-500 font-bold text-lg">Nenhum prato encontrado.</p><button onclick="setCategoria('todas'); document.getElementById('busca-marmitas').value=''; filtrarMarmitas();" class="mt-4 bg-sage/10 text-forest px-6 py-2 rounded-full font-bold hover:bg-sage/20 transition-all">Limpar filtros</button></div>`;
      return;
    }

    const porCat = {};
    disponiveis.forEach(m => { if (!porCat[m.cat]) porCat[m.cat] = []; porCat[m.cat].push(m); });

    el.innerHTML = Object.keys(porCat).map(cat => `
      <div class="mb-6">
        <p class="text-xs font-bold uppercase text-gray-400 mb-3 ml-1">${CAT_ICONS[cat] || 'ğŸ´ Outros'}</p>
        ${porCat[cat].map(m => {
          let nomeExibicao = m.nome;
          if (searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            nomeExibicao = m.nome.replace(regex, '<mark class="bg-yellow-200 text-charcoal rounded px-1">$1</mark>');
          }
          return `
          <div class="bg-white p-5 rounded-2xl flex flex-col sm:flex-row justify-between sm:items-center shadow-sm border border-gray-100 hover:border-sage/50 transition-all mb-3 focus-within:ring-2 focus-within:ring-forest">
            <div class="flex-1 pr-4 mb-4 sm:mb-0">
              <p class="font-bold text-forest text-lg">${CAT_EMOJI[m.cat]||'ğŸ´'} ${nomeExibicao}</p>
              <p class="text-xs text-gray-400 leading-relaxed mt-1">${m.desc} â€¢ <span class="text-sage font-bold">${m.kcal} kcal</span></p>
            </div>
            <div class="flex items-center gap-3 bg-cream p-1.5 rounded-xl shrink-0 self-start sm:self-auto border border-sage/10">
              <button type="button" onclick="updateQty(${m.id}, -1)" aria-label="Remover ${lote} unidade(s) de ${m.nome}" class="w-10 h-10 rounded-lg bg-white shadow-sm font-bold text-lg hover:bg-red-50 text-red-500 transition-all active:scale-90 flex items-center justify-center">âˆ’${lote}</button>
              <span id="qty-${m.id}" class="font-bold w-6 text-center text-lg" aria-live="polite">${quantities[m.id] || 0}</span>
              <button type="button" onclick="updateQty(${m.id}, 1)" aria-label="Adicionar ${lote} unidade(s) de ${m.nome}" class="w-10 h-10 rounded-lg bg-forest text-white shadow-sm font-bold text-lg hover:bg-forest/90 transition-all active:scale-90 flex items-center justify-center">+${lote}</button>
            </div>
          </div>`
        }).join('')}
      </div>`).join('');
  }

  function updateQty(id, delta) {
    const lote = currentCombo?.lote_selecao || 1;
    const total = Object.values(quantities).reduce((a,b) => a+b, 0);
    
    if (delta > 0 && total + lote > maxMarmitas) return showToast(`âš ï¸ Kit completo! MÃ¡ximo atingido.`);
    
    const atual = quantities[id] || 0;
    let novoValor = atual + (delta * lote);
    if (novoValor < 0) novoValor = 0;
    
    quantities[id] = novoValor;
    const el = document.getElementById(`qty-${id}`);
    if (el) el.textContent = quantities[id];

    const novoTotal = Object.values(quantities).reduce((a,b) => a+b, 0);
    document.getElementById('current-marmitas').textContent = novoTotal;

    const pct = Math.min(100, Math.round((novoTotal / maxMarmitas) * 100));
    const bar  = document.getElementById('progress-bar');
    if (bar) bar.style.width = pct + '%';

    if (novoTotal === maxMarmitas) {
      showToast('ğŸ‰ Kit completo configurado!');
      const vegMax = currentCombo?.vegetal_max || 0;
      if (vegMax > 0) setTimeout(() => { document.getElementById('secao-vegetais').scrollIntoView({behavior: 'smooth', block: 'start'}); }, 700);
      else setTimeout(() => { window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'}); }, 700);
    }
  }

  // ============================================================
  // CARRINHO DE COMPRAS E CHECKOUT
  // ============================================================
  function atualizarBadgeCarrinho() {
    const btn = document.getElementById('btn-floating-cart');
    const badge = document.getElementById('cart-badge-floating');
    
    if (carrinhoCompras.length > 0) {
      btn.classList.remove('hidden');
      badge.textContent = carrinhoCompras.length;
      btn.classList.remove('animate-pop');
      void btn.offsetWidth;
      btn.classList.add('animate-pop');
    } else {
      btn.classList.add('hidden');
      const container = document.getElementById('cart-sidebar-container');
      if (!container.classList.contains('hidden')) toggleCart();
    }
    lsSet('current_cart', carrinhoCompras);
  }

  function toggleCart() {
    const container = document.getElementById('cart-sidebar-container');
    const panel = document.getElementById('cart-panel');
    const backdrop = document.getElementById('cart-backdrop');
    
    if (container.classList.contains('hidden')) {
      renderItensCarrinho();
      container.classList.remove('hidden');
      setTimeout(() => { backdrop.classList.remove('opacity-0'); panel.classList.remove('translate-x-full'); }, 10);
    } else {
      backdrop.classList.add('opacity-0'); panel.classList.add('translate-x-full');
      setTimeout(() => container.classList.add('hidden'), 300);
    }
  }

  function adicionarAoCarrinho() {
    if (currentCombo.tipo !== 'fechado') {
      const total = Object.values(quantities).reduce((a,b) => a+b, 0);
      if (total === 0) return showToast('âš ï¸ Selecione pelo menos um item!');
      if (total < maxMarmitas && !confirm(`Ainda restam ${maxMarmitas - total} unidades livres no combo. Adicionar ao carrinho incompleto?`)) return;
    }

    const vegMin = currentCombo?.vegetal_min || 0;
    if (vegMin > 0 && vegetaisSelecionados.length < vegMin) return showToast(`âš ï¸ Selecione pelo menos ${vegMin} vegetal(is)`);

    const temperos = ['ğŸŒ¿ Suave','ğŸŒ¶ï¸ MÃ©dio','ğŸ”¥ Picante'];
    const tempEscolhido = temperos[spiceLevel - 1];
    const obs = document.getElementById('observations').value.trim();

    const itemCarrinho = {
      idUnico: 'cart_' + Date.now() + Math.floor(Math.random()*1000),
      comboId: currentCombo.id,
      comboNome: currentCombo.nome,
      comboTipo: currentCombo.tipo,
      precoBase: currentCombo.preco_base,
      tempero: tempEscolhido,
      observacoes: obs,
      quantidades: { ...quantities },
      vegetais: [...vegetaisSelecionados],
      itensFechado: currentCombo.tipo === 'fechado' ? { ...currentCombo.itens } : null
    };

    carrinhoCompras.push(itemCarrinho);
    showToast(`âœ… ${currentCombo.nome} no Carrinho!`);
    atualizarBadgeCarrinho();
    resetarSelecaoAtual();
  }

  function removerDoCarrinho(idUnico) {
    carrinhoCompras = carrinhoCompras.filter(i => i.idUnico !== idUnico);
    atualizarBadgeCarrinho();
    renderItensCarrinho();
  }

  function renderItensCarrinho() {
    const container = document.getElementById('cart-items-container');
    const totalPriceEl = document.getElementById('cart-total-price');
    let total = 0;

    if (carrinhoCompras.length === 0) {
      container.innerHTML = `<div class="text-center py-12 opacity-50"><p class="text-5xl mb-4" aria-hidden="true">ğŸ›’</p><p class="font-bold">O seu carrinho estÃ¡ vazio</p></div>`;
      totalPriceEl.textContent = 'R$ 0,00';
      return;
    }

    container.innerHTML = carrinhoCompras.map((item, index) => {
      total += item.precoBase;
      let resumo = '';
      if (item.comboTipo === 'fechado') {
        resumo = 'Itens prÃ©-definidos do combo';
      } else {
        const nomes = [];
        Object.entries(item.quantidades).forEach(([id, q]) => {
          if (q > 0) { const m = marmitasCache.find(x => x.id == id); if (m) nomes.push(`${q}x ${m.nome}`); }
        });
        resumo = nomes.slice(0, 3).join(', ') + (nomes.length > 3 ? ` ...` : '');
      }

      let vegResumo = '';
      if (item.vegetais && item.vegetais.length > 0) {
        const vegNomes = item.vegetais.map(vId => marmitasCache.find(x => x.id === vId)?.nome).filter(Boolean);
        vegResumo = `<p class="text-xs text-green-700 bg-green-50 inline-block px-2 py-1 rounded font-bold mt-2">ğŸ¥¦ ${vegNomes.join(', ')}</p>`;
      }

      return `
        <article class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 mb-3 relative group">
          <button onclick="removerDoCarrinho('${item.idUnico}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition-colors bg-white rounded-full p-1" aria-label="Remover do carrinho">âœ•</button>
          <div class="pr-8">
            <h4 class="font-bold text-forest text-lg leading-tight mb-1">${index + 1}. ${item.comboNome}</h4>
            <span class="text-lg font-display text-terracotta font-bold block mb-2">R$ ${item.precoBase.toFixed(2)}</span>
            <p class="text-xs text-gray-500 line-clamp-2 leading-relaxed">${resumo}</p>
            ${vegResumo}
            <div class="mt-3 pt-3 border-t border-sage/10 flex flex-wrap gap-2">
              <span class="text-[10px] uppercase font-bold bg-sage/10 text-sage px-2 py-1 rounded">${item.comboTipo === 'fechado' ? 'ğŸ“¦ Fechado' : 'ğŸ›’ Personalizado'}</span>
              <span class="text-[10px] uppercase font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded">${item.tempero}</span>
            </div>
          </div>
        </article>
      `;
    }).join('');

    totalPriceEl.textContent = `R$ ${total.toFixed(2)}`;
  }

  async function finalizarPedidoFinal() {
    const nome     = document.getElementById('cliente-nome').value.trim();
    const tel      = document.getElementById('cliente-tel').value.trim();
    const endereco = document.getElementById('cliente-endereco').value.trim();
    const cidade   = document.getElementById('cliente-cidade').value.trim();

    if (!nome || !tel || !endereco || !cidade) return showToast('âŒ Preencha todos os dados de entrega por favor.');
    if (carrinhoCompras.length === 0) return showToast('âŒ Carrinho vazio!');

    showLoading(true, 'A gerar pedido...');

    let msgWhatsApp = `*ğŸ“¦ NOVO PEDIDO - SABOR E SAÃšDE*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*CLIENTE:* ${nome}\n*TEL:* ${tel}\n*ENDEREÃ‡O:* ${endereco}, ${cidade}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*ğŸ›’ ITENS DO PEDIDO:*\n\n`;
    let totalGeralPreco = 0;
    let totalGeralItensFisicos = 0;
    let itensDetalhesConsolidado = {};
    let comboNomesConsolidado = [];

    carrinhoCompras.forEach((itemCart, index) => {
      totalGeralPreco += itemCart.precoBase;
      comboNomesConsolidado.push(itemCart.comboNome);

      msgWhatsApp += `*${index + 1}. ${itemCart.comboNome}* (${itemCart.comboTipo === 'fechado' ? 'Fechado' : 'Personalizado'})\n`;
      msgWhatsApp += `Tempero: ${itemCart.tempero}\n`;
      if (itemCart.observacoes) msgWhatsApp += `Obs: ${itemCart.observacoes}\n`;

      if (itemCart.comboTipo === 'fechado') {
        Object.entries(itemCart.itensFechado || {}).forEach(([itemId, qtd]) => {
          const m = marmitasCache.find(x => x.id === parseInt(itemId));
          if (m && qtd > 0) {
            msgWhatsApp += `â€¢ ${qtd}x ${m.nome}\n`;
            itensDetalhesConsolidado[m.nome] = (itensDetalhesConsolidado[m.nome] || 0) + qtd;
            totalGeralItensFisicos += qtd;
          }
        });
      } else {
        Object.entries(itemCart.quantidades).forEach(([itemId, qtd]) => {
          const m = marmitasCache.find(x => x.id == itemId);
          if (m && qtd > 0) {
            msgWhatsApp += `â€¢ ${qtd}x ${m.nome}\n`;
            itensDetalhesConsolidado[m.nome] = (itensDetalhesConsolidado[m.nome] || 0) + qtd;
            totalGeralItensFisicos += qtd;
          }
        });
      }

      if (itemCart.vegetais && itemCart.vegetais.length > 0) {
        const vegNomes = itemCart.vegetais.map(vId => marmitasCache.find(x => x.id === vId)?.nome).filter(Boolean);
        msgWhatsApp += `ğŸ¥¦ Vegetais: ${vegNomes.join(', ')}\n`;
        vegNomes.forEach(v => {
          const chave = `Vegetal_${v.replace(/[\.\#\$\/\[\]]/g, '_')}`;
          itensDetalhesConsolidado[chave] = (itensDetalhesConsolidado[chave] || 0) + 1;
        });
      }
      msgWhatsApp += `\n`;
    });

    msgWhatsApp += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*ğŸ’° TOTAL A PAGAR:* R$ ${totalGeralPreco.toFixed(2)}`;

    const pedidoFirebase = {
      id:               'pedido_' + Date.now(),
      timestamp:        new Date().toISOString(),
      cliente_nome:     nome,
      cliente_tel:      tel,
      cliente_endereco: endereco,
      cliente_cidade:   cidade,
      observacoes:      "Ver detalhes nas informaÃ§Ãµes do Carrinho",
      combo_nome:       comboNomesConsolidado.length > 1 ? `MÃºltiplos Combos (${carrinhoCompras.length})` : comboNomesConsolidado[0],
      combo_tipo:       'carrinho',
      tempero:          'Variado',
      vegetais:         [],
      itens_detalhes:   itensDetalhesConsolidado,
      qtd_itens:        totalGeralItensFisicos,
      total:            totalGeralPreco
    };

    await savePedido(pedidoFirebase);
    
    carrinhoCompras = [];
    atualizarBadgeCarrinho();
    ['cliente-nome','cliente-tel','cliente-endereco','cliente-cidade'].forEach(id => { document.getElementById(id).value = ''; });
    
    showLoading(false);
    toggleCart();
    showToast('âœ… Pedido Gerado! A redirecionar para WhatsApp...');
    
    const msgEncoded = encodeURIComponent(msgWhatsApp);
    setTimeout(() => window.open(`https://wa.me/${WHATSAPP_RESTAURANTE}?text=${msgEncoded}`, '_blank'), 800);
  }

  // ============================================================
  // UTILITÃRIOS EXTRAS
  // ============================================================
  function renderVegetais() {
    const secao = document.getElementById('secao-vegetais');
    const vegMax = currentCombo?.vegetal_max || 0;
    const vegMin = currentCombo?.vegetal_min || 0;
    if (!vegMax) { secao.classList.add('hidden'); return; }

    const vegetais = marmitasCache.filter(m => m.cat === 'vegetal' && m.visivel);
    if (!vegetais.length) { secao.classList.add('hidden'); return; }

    secao.classList.remove('hidden');
    document.getElementById('vegetal-counter').textContent = '0';
    document.getElementById('vegetal-counter-max').textContent = ` / ${vegMax}`;
    document.getElementById('vegetal-instrucao').textContent = vegMin > 0 ? `Escolha de ${vegMin} a ${vegMax} vegetal(is) â€” nÃ£o contam no limite principal` : `Escolha atÃ© ${vegMax} vegetal(is) (opcional)`;

    document.getElementById('vegetais-container').innerHTML = vegetais.map(v => `
      <button type="button" id="vegetal-btn-${v.id}" onclick="toggleVegetal(${v.id})" class="vegetal-btn flex items-center gap-3 px-4 py-3 border-2 border-sage/30 rounded-xl bg-white text-left text-sm font-medium hover:border-forest transition-all w-full active:scale-95" aria-pressed="false">
        <span class="text-2xl" aria-hidden="true">ğŸ¥¦</span>
        <div><p class="font-bold text-forest">${v.nome}</p><p class="text-xs text-gray-500 mt-0.5">${v.kcal} kcal</p></div>
      </button>`).join('');
  }

  function toggleVegetal(id) {
    const vegMax = currentCombo?.vegetal_max || 0;
    const idx = vegetaisSelecionados.indexOf(id);
    const btn = document.getElementById(`vegetal-btn-${id}`);

    if (idx === -1) {
      if (vegetaisSelecionados.length >= vegMax) return showToast(`âš ï¸ Limite de ${vegMax} vegetal(is) atingido.`);
      vegetaisSelecionados.push(id); btn.classList.add('selected'); btn.setAttribute('aria-pressed', 'true');
    } else {
      vegetaisSelecionados.splice(idx, 1); btn.classList.remove('selected'); btn.setAttribute('aria-pressed', 'false');
    }
    document.getElementById('vegetal-counter').textContent = vegetaisSelecionados.length;
  }

  function mostrarComboFechado() {
    const el = document.getElementById('lista-itens-fechado');
    document.getElementById('combo-fechado-itens').classList.remove('hidden');

    const porCat = {};
    Object.entries(currentCombo.itens || {}).forEach(([itemId, qtd]) => {
      const m = marmitasCache.find(x => x.id === parseInt(itemId));
      if (m && qtd > 0) { if (!porCat[m.cat]) porCat[m.cat] = []; porCat[m.cat].push({ ...m, quantidade: qtd }); }
    });

    let totalGeral = 0; Object.values(porCat).forEach(arr => arr.forEach(i => totalGeral += i.quantidade));

    el.innerHTML = `
      <p class="text-xs text-gray-400 mb-4">Total: <span class="font-bold text-forest">${totalGeral} itens</span> inclusos</p>
      ${Object.keys(porCat).map(cat => `
        <div class="mb-4">
          <p class="font-bold text-xs uppercase text-gray-400 mb-2">${CAT_ICONS[cat] || 'ğŸ“¦ Outros'}</p>
          <div class="space-y-2">
            ${porCat[cat].map(item => `
              <div class="bg-cream rounded-xl overflow-hidden border border-transparent hover:border-sage/30 transition-all">
                <button type="button" onclick="toggleDescItem(this)" class="w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none focus:bg-sage/10" aria-expanded="false">
                  <div class="flex items-center gap-3">
                    <span class="bg-forest text-white text-xs font-bold px-2 py-1 rounded-lg min-w-[32px] text-center">${item.quantidade}x</span>
                    <span class="font-medium text-charcoal text-sm">${CAT_EMOJI[item.cat] || 'ğŸ´'} ${item.nome}</span>
                  </div>
                  <span class="text-gray-400 text-xs ml-2 shrink-0 transition-transform">â–¼</span>
                </button>
                <div class="desc-item hidden px-4 pb-3">
                  <p class="text-xs text-gray-500 leading-relaxed border-t border-sage/20 pt-2">${item.desc} (${item.kcal} kcal)</p>
                </div>
              </div>`).join('')}
          </div>
        </div>`).join('')}`;
  }

  function toggleDescItem(btn) {
    const desc = btn.nextElementSibling;
    const arrow = btn.querySelector('span:last-child');
    const aberto = !desc.classList.contains('hidden');
    desc.classList.toggle('hidden', aberto);
    arrow.style.transform = aberto ? 'rotate(180deg)' : 'rotate(0deg)';
    btn.setAttribute('aria-expanded', !aberto);
  }

  function atualizarTotalComboBase() {
    if (currentCombo) document.getElementById('total-price').textContent = `R$ ${currentCombo.preco_base.toFixed(2)}`;
  }

  function setSpiceLevel(l) {
    spiceLevel = l;
    document.querySelectorAll('.spice-btn').forEach((btn, i) => {
      const active = i === l - 1;
      btn.classList.toggle('border-2', active); btn.classList.toggle('border-forest', active); btn.classList.toggle('bg-forest/5', active);
      btn.classList.toggle('font-bold', active); btn.classList.toggle('border-sage/20', !active); btn.classList.toggle('bg-white', !active);
      btn.setAttribute('aria-pressed', active);
    });
  }

  window.onload = initData;
</script>
</body>
</html>