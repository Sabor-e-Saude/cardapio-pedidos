<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sabor e Sa√∫de - Card√°pio de Marmitas Fit</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            forest:    '#2D5A3D',
            sage:      '#8FAE8B',
            cream:     '#FDF8F3',
            terracotta:'#C4785A',
            charcoal:  '#2A2A2A',
          }
        }
      }
    }
  </script>
  <style>
    .font-display  { font-family: 'Playfair Display', serif; }
    .font-body     { font-family: 'DM Sans', sans-serif; }
    body           { background-color: #FDF8F3; }
    .fade-in       { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    .modal-bg      { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .loading-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(253,248,243,0.95);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    input[type=number].qty-input { -moz-appearance:textfield; appearance:textfield; }
    input[type=number].qty-input::-webkit-inner-spin-button,
    input[type=number].qty-input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    .table-row:hover { background-color: #f9f5f0; }
    .sidebar-hidden  { display: none !important; }
    .vegetal-btn.selected {
      border-color: #2D5A3D !important;
      background-color: #2D5A3D !important;
      color: white !important;
    }
  </style>
</head>
<body class="h-full font-body text-charcoal">

<!-- LOADING -->
<div id="loading" class="loading-overlay">
  <div class="text-center">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-forest mx-auto mb-4"></div>
    <p class="text-forest font-bold">Carregando card√°pio...</p>
  </div>
</div>

<!-- MODAL LOGIN ADMIN -->
<div id="admin-modal" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
    <h2 class="font-display text-2xl text-forest mb-4">Acesso Administrativo</h2>
    <form onsubmit="handleLogin(event)" class="space-y-4">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Usu√°rio</label>
        <input id="login-username" type="text" autocomplete="username"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Senha</label>
        <input id="login-password" type="password" autocomplete="current-password"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <button type="submit" class="w-full bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">Entrar no Painel</button>
      <button type="button" onclick="closeAdminModal()" class="w-full text-gray-400 text-sm py-2">Cancelar</button>
      <p id="login-error" class="text-red-500 text-xs text-center hidden">Usu√°rio ou senha incorretos</p>
    </form>
  </div>
</div>

<!-- MODAL VISUALIZAR PEDIDO -->
<div id="modal-pedido" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-display text-2xl text-forest">Detalhes do Pedido</h2>
      <button onclick="closeModalPedido()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    <div id="modal-pedido-content" class="space-y-4"></div>
    <div class="flex gap-3 pt-6">
      <button id="btn-wpp-cliente" onclick="abrirWhatsAppCliente()"
              class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition-all">Abrir WhatsApp</button>
      <button onclick="closeModalPedido()"
              class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL MARMITA -->
<div id="modal-marmita" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-marmita-title">Novo Item</h2>
    <form onsubmit="salvarMarmita(event)" class="space-y-4">
      <input type="hidden" id="edit-marmita-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome *</label>
        <input id="marmita-nome" type="text" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo (R$) *</label>
          <input id="marmita-preco" type="number" step="0.01" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Calorias (kcal) *</label>
          <input id="marmita-kcal" type="number" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Descri√ß√£o *</label>
        <textarea id="marmita-desc" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest h-20"></textarea>
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Categoria *</label>
        <select id="marmita-cat" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          <option value="marmita">Marmita</option>
          <option value="sopa">Sopa</option>
          <option value="suco">Suco</option>
          <option value="sobremesa">Sobremesa</option>
          <option value="proteico">Proteico</option>
          <option value="low-carb">Low Carb</option>
          <option value="vegano">Vegano</option>
          <option value="vegetal">Vegetal</option>
        </select>
      </div>
      <div class="bg-sage/10 p-4 rounded-xl space-y-3">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="marmita-visivel" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üëÅÔ∏è Vis√≠vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar do card√°pio</p>
          </div>
        </label>
        <label class="flex items-center gap-3 cursor-pointer border-t border-sage/20 pt-3">
          <input type="checkbox" id="marmita-disponivel-combo" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üõí Dispon√≠vel para sele√ß√£o em Combos</p>
            <p class="text-xs text-gray-500">Desmarque para n√£o aparecer na escolha de itens do combo</p>
          </div>
        </label>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">Salvar</button>
        <button type="button" onclick="closeModalMarmita()" class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL COMBO -->
<div id="modal-combo" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-combo-title">Novo Combo</h2>
    <form onsubmit="salvarCombo(event)" class="space-y-4">
      <input type="hidden" id="edit-combo-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome do Combo *</label>
        <input id="combo-nome" type="text" required placeholder="Ex: Kit 10 Marmitas"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>

      <!-- TIPO -->
      <div class="bg-cream p-4 rounded-xl border-2 border-sage/20">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-3">Tipo de Combo</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
            <input type="radio" name="tipo-combo" value="aberto" checked onchange="toggleTipoCombo()" class="mt-1">
            <div>
              <p class="font-bold text-forest">Combo Aberto</p>
              <p class="text-xs text-gray-500">Cliente escolhe os itens</p>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
            <input type="radio" name="tipo-combo" value="fechado" onchange="toggleTipoCombo()" class="mt-1">
            <div>
              <p class="font-bold text-forest">Combo Fechado</p>
              <p class="text-xs text-gray-500">Itens pr√©-definidos</p>
            </div>
          </label>
        </div>
      </div>

      <!-- CONFIG ABERTO -->
      <div id="config-aberto" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Quantidade de Itens *</label>
            <input id="combo-qtd" type="number" min="1" required
                   oninput="atualizarPreviewCombo()"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo Total (R$) *</label>
            <input id="combo-preco" type="number" step="0.01" required
                   oninput="atualizarPreviewCombo()"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>

        <!-- SELE√á√ÉO M√öLTIPLA -->
        <div class="bg-blue-50 border-2 border-blue-100 p-4 rounded-xl">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="font-bold text-sm text-blue-800">üî¢ Sele√ß√£o em M√∫ltiplos</p>
              <p class="text-xs text-blue-600 mt-0.5">O cliente s√≥ pode escolher em blocos desse valor (0, 5, 10‚Ä¶)</p>
            </div>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="combo-multiplo-ativo" class="w-4 h-4" onchange="toggleMultiplo()">
              <span class="text-xs font-bold text-blue-700">Ativar</span>
            </label>
          </div>
          <div id="combo-multiplo-config" class="hidden mt-3">
            <label class="block text-xs text-gray-500 mb-1">Valor do m√∫ltiplo (ex: 5)</label>
            <input id="combo-multiplo-valor" type="number" min="1" value="5"
                   class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:outline-forest bg-white">
            <p class="text-xs text-gray-400 mt-1">üí° Com m√∫ltiplo 5: cliente escolhe 0, 5, 10, 15‚Ä¶ de cada item</p>
          </div>
        </div>

        <!-- ITENS DISPON√çVEIS NESTE COMBO -->
        <div class="bg-sage/10 border-2 border-sage/20 p-4 rounded-xl">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="font-bold text-sm text-forest">üç± Itens dispon√≠veis neste combo</p>
              <p class="text-xs text-gray-500 mt-0.5">Deixe todos desmarcados para exibir todos os itens habilitados globalmente</p>
            </div>
            <div class="flex gap-2">
              <button type="button" onclick="marcarTodosItensCombo(true)"
                      class="text-xs text-forest font-bold px-2 py-1 rounded-lg hover:bg-sage/20">Todos</button>
              <button type="button" onclick="marcarTodosItensCombo(false)"
                      class="text-xs text-gray-400 font-bold px-2 py-1 rounded-lg hover:bg-gray-100">Nenhum</button>
            </div>
          </div>
          <div id="itens-disponiveis-combo" class="max-h-52 overflow-y-auto space-y-1 mt-3"></div>
        </div>
      </div>

      <!-- CONFIG FECHADO -->
      <div id="config-fechado" class="hidden">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-3">Itens do Combo *</label>
        <div class="bg-white border-2 border-sage/20 rounded-xl p-4 max-h-72 overflow-y-auto"
             id="itens-combo-container"></div>
        <div class="mt-4">
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo do Combo (R$) *</label>
          <input id="combo-preco-fechado" type="number" step="0.01"
                 class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>

      <!-- LIMITE DE VEGETAIS -->
      <div class="bg-green-50 border-2 border-green-100 p-4 rounded-xl">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-2">ü•¶ Vegetais no Pedido</label>
        <p class="text-xs text-gray-500 mb-3">Quantos vegetais o cliente poder√° escolher ao montar este combo?</p>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade m√≠nima</label>
            <input id="combo-vegetal-min" type="number" min="0" value="0"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade m√°xima</label>
            <input id="combo-vegetal-max" type="number" min="0" value="0" placeholder="0 = sem vegetais"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">üí° Deixe m√°ximo em 0 para n√£o oferecer vegetais neste combo</p>
      </div>

      <div class="bg-sage/10 p-4 rounded-lg">
        <p class="text-xs text-gray-600">üí° <span id="preco-unitario-preview">Configure o combo acima</span></p>
      </div>

      <!-- VISIBILIDADE -->
      <div class="bg-sage/10 p-4 rounded-lg">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="combo-visivel" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üëÅÔ∏è Vis√≠vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar este combo</p>
          </div>
        </label>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">Salvar Combo</button>
        <button type="button" onclick="closeModalCombo()" class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<!-- APP PRINCIPAL -->
<div id="main-app" class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-forest text-cream px-6 py-4 flex justify-between items-center sticky top-0 z-40 shadow-md">
    <div class="flex items-center gap-3">
      <img id="logo-empresa" src="https://raw.githubusercontent.com/Sabor-e-Saude/cardapio-pedidos/refs/heads/main/logo.png"
           alt="Logo Sabor e Sa√∫de" class="w-12 h-12 rounded-full object-cover border-2 border-sage/40">
      <div>
        <h1 class="font-display text-xl md:text-2xl">Sabor e Sa√∫de</h1>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-toggle-sidebar" onclick="toggleSidebar()"
              class="hidden text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all"
              title="Minimizar/expandir menu">‚ò∞</button>
      <button id="btn-admin-view" onclick="openAdminModal()"
              class="text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all">Acesso Admin</button>
      <button onclick="resetarPedido()"
              class="text-xs bg-terracotta/30 px-3 py-2 rounded-lg hover:bg-terracotta/50 transition-all">Resetar</button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR ADMIN -->
    <aside id="sidebar" class="w-64 bg-white border-r hidden overflow-y-auto flex-shrink-0 transition-all">
      <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Gerenciamento</p>
      </div>
      <nav class="p-4 space-y-2">
        <button onclick="showPage('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">Dashboard</button>
        <button onclick="showPage('pedidos')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">
          Pedidos <span id="badge-pedidos" class="ml-2 bg-terracotta text-white text-xs px-2 py-0.5 rounded-full hidden"></span>
        </button>
        <button onclick="showPage('combos')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">Gerenciar Combos</button>
        <button onclick="showPage('marmitas')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">Gerenciar Card√°pio</button>
        <hr class="my-4">
        <button onclick="entrarComoCliente()" class="w-full text-left px-4 py-3 rounded-lg text-terracotta hover:bg-terracotta/5 transition-all">Ver como Cliente</button>
      </nav>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 pb-32">

      <!-- P√ÅGINA CLIENTE CARD√ÅPIO -->
      <section id="page-cardapio" class="fade-in max-w-4xl mx-auto">
        <div class="mb-8">
          <h2 class="font-display text-3xl text-forest">Monte seu Kit üç±</h2>
          <p class="text-sage">Escolha um combo abaixo para come√ßar sua sele√ß√£o.</p>
        </div>

        <!-- GRID DE COMBOS -->
        <div id="combos-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"></div>

        <!-- BOT√ÉO DIETA DIFERENCIADA -->
        <div class="mb-10">
          <button onclick="abrirCotacaoEspecial()"
                  class="w-full bg-white border-2 border-dashed border-sage/40 rounded-3xl p-5
                         flex items-center gap-4 hover:border-forest hover:bg-sage/5 transition-all group text-left">
            <div class="w-12 h-12 bg-forest/10 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-forest/20 transition-all">
              <span class="text-2xl">ü•ó</span>
            </div>
            <div>
              <p class="font-bold text-forest">Tenho uma dieta diferenciada</p>
              <p class="text-xs text-gray-400 mt-0.5">Restri√ß√µes alimentares, dieta prescrita ou necessidade especial? Fale conosco para uma cota√ß√£o personalizada.</p>
            </div>
            <span class="ml-auto text-gray-300 group-hover:text-forest transition-all text-xl shrink-0">‚Üí</span>
          </button>
        </div>

        <!-- SE√á√ÉO MARMITAS -->
        <div id="marmitas-section" class="hidden fade-in border-t border-sage/20 pt-8">

          <!-- BARRA DE PROGRESSO -->
          <div class="bg-forest text-white p-6 rounded-2xl mb-8 shadow-xl">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs opacity-70 uppercase font-bold">Progresso do Kit</p>
                <p class="text-lg font-bold" id="combo-name-display">Carregando...</p>
                <p class="text-xs opacity-70 mt-1" id="combo-tipo-badge"></p>
              </div>
              <div class="text-right" id="progress-counter">
                <p class="text-xs opacity-60 uppercase mb-1">Marmitas</p>
                <div class="flex items-baseline gap-1">
                  <span class="text-3xl font-display font-bold" id="current-marmitas">0</span>
                  <span class="text-xl opacity-50">/</span>
                  <span class="text-xl opacity-50" id="max-marmitas">10</span>
                </div>
              </div>
            </div>
            <div id="progress-bar-container" class="mt-4">
              <div class="w-full bg-white/20 rounded-full h-2">
                <div id="progress-bar" class="bg-white h-2 rounded-full transition-all duration-300" style="width:0"></div>
              </div>
            </div>
          </div>

          <!-- COMBO FECHADO ITENS INCLUSOS -->
          <div id="combo-fechado-itens" class="hidden mb-8 bg-white rounded-2xl p-6 shadow-sm border border-sage/20">
            <h3 class="text-xl font-bold text-forest mb-4">üì¶ Itens inclusos neste combo:</h3>
            <div id="lista-itens-fechado" class="space-y-2"></div>
          </div>

          <!-- COMBO ABERTO SELE√á√ÉO -->
          <div id="selecao-marmitas-container">
            <h3 class="text-xl font-bold text-forest mb-4">Selecione suas refei√ß√µes:</h3>
            <div id="marmitas-container" class="grid grid-cols-1 gap-3 mb-8"></div>
          </div>

          <!-- SELE√á√ÉO DE VEGETAIS -->
          <div id="secao-vegetais" class="hidden mb-8 fade-in">
            <div class="bg-white rounded-3xl p-6 shadow-sm border-2 border-green-100">
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-display text-xl text-forest">ü•¶ Escolha seus Vegetais</h3>
                <div class="flex items-center gap-1 bg-green-50 px-3 py-1 rounded-full">
                  <span class="text-sm font-bold text-green-700" id="vegetal-counter">0</span>
                  <span class="text-sm text-gray-400" id="vegetal-counter-max"></span>
                </div>
              </div>
              <div class="bg-green-50 rounded-xl px-4 py-3 mb-5">
                <p class="text-sm text-green-700 font-medium" id="vegetal-instrucao"></p>
                <p class="text-xs text-green-600 mt-1">Os vegetais s√£o <strong>adicionais</strong> ao seu kit ‚Äî n√£o contam no limite de marmitas</p>
              </div>
              <div id="vegetais-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
          </div>

          <!-- PREFER√äNCIAS DO PEDIDO -->
          <div class="bg-white rounded-3xl p-6 shadow-sm border border-sage/20 mb-8">
            <h3 class="font-display text-2xl text-forest mb-6">Prefer√™ncias do Pedido</h3>
            <div class="mb-6">
              <label class="block text-xs font-bold uppercase text-gray-400 mb-2 ml-1">Prefer√™ncia de Tempero</label>
              <div class="flex gap-2">
                <button type="button" onclick="setSpiceLevel(1)" class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">Suave</button>
                <button type="button" onclick="setSpiceLevel(2)" class="spice-btn flex-1 py-3 border-2 border-forest bg-forest/5 rounded-xl font-bold">M√©dio</button>
                <button type="button" onclick="setSpiceLevel(3)" class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">Picante</button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Observa√ß√µes Adicionais</label>
              <textarea id="observations" placeholder="Ex: Sem cebola, restri√ß√µes alimentares, prefer√™ncias especiais..."
                        class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest h-24"></textarea>
            </div>
          </div>

          <!-- DADOS PARA ENTREGA -->
          <div class="bg-white rounded-3xl p-6 shadow-sm border border-sage/20 mb-8">
            <h3 class="font-display text-2xl text-forest mb-6">Dados para Entrega</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Seu Nome</label>
                <input id="cliente-nome" type="text" placeholder="Ex: Jo√£o Silva"
                       class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
              </div>
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">WhatsApp</label>
                <input id="cliente-tel" type="tel" placeholder="(00) 00000-0000"
                       class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div class="md:col-span-2">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Endere√ßo de Entrega</label>
                <input id="cliente-endereco" type="text" placeholder="Rua, n√∫mero, bairro e ponto de refer√™ncia"
                       class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
              </div>
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Cidade</label>
                <input id="cliente-cidade" type="text" placeholder="Ex: Blumenau"
                       class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
              </div>
            </div>
          </div>

        </div><!-- fim marmitas-section -->

        <!-- BARRA FIXA DE FINALIZA√á√ÉO -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 md:p-6 flex flex-col md:flex-row justify-between items-center shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50">
          <div class="text-center md:text-left mb-4 md:mb-0">
            <p class="text-xs text-gray-400 uppercase font-bold">Total do Kit</p>
            <p id="total-price" class="text-3xl font-display text-terracotta">R$ 0,00</p>
          </div>
          <button onclick="finalizarPedido()"
                  class="w-full md:w-auto bg-forest text-white px-12 py-4 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2">
            üì≤ Enviar para WhatsApp
          </button>
        </div>

      </section>

      <!-- DASHBOARD ADMIN -->
      <section id="page-dashboard" class="hidden">
        <h2 class="text-2xl font-bold mb-6 font-display text-forest">Painel Administrativo</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Combos</p>
            <p class="text-3xl font-bold text-forest" id="stat-combos">0</p>
            <p class="text-xs text-sage mt-1" id="stat-combos-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Itens no Card√°pio</p>
            <p class="text-3xl font-bold text-forest" id="stat-marmitas">0</p>
            <p class="text-xs text-sage mt-1" id="stat-marmitas-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Pedidos</p>
            <p class="text-3xl font-bold text-terracotta" id="stat-total-pedidos">0</p>
            <p class="text-xs text-sage mt-1">hist√≥rico completo</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Faturamento Total</p>
            <p class="text-3xl font-bold text-forest" id="stat-faturamento">R$ 0</p>
            <p class="text-xs text-sage mt-1">todos os pedidos</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
          <h3 class="font-bold text-lg mb-4">A√ß√µes R√°pidas</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="showPage('pedidos')" class="border-2 border-terracotta text-terracotta px-4 py-3 rounded-xl font-bold hover:bg-terracotta hover:text-white transition-all text-sm">Ver Pedidos</button>
            <button onclick="exportarBancoDados()" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">Exportar Dados</button>
            <button onclick="showPage('combos')" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">Combos</button>
            <button onclick="showPage('marmitas')" class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold hover:bg-forest hover:text-white transition-all text-sm">Card√°pio</button>
          </div>
        </div>
      </section>

      <!-- P√ÅGINA PEDIDOS -->
      <section id="page-pedidos" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold font-display text-forest">üìã Pedidos Recebidos</h2>
          <button onclick="exportarBancoDados()" class="bg-forest text-white px-5 py-3 rounded-xl font-bold hover:scale-105 transition-all text-sm">Exportar Banco de Dados</button>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 mb-6">
          <p class="text-xs font-bold uppercase text-gray-400 mb-3">Filtrar por Per√≠odo</p>
          <div class="flex flex-col md:flex-row gap-3 items-end">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Data inicial</label>
              <input type="date" id="filtro-data-inicio" class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Data final</label>
              <input type="date" id="filtro-data-fim" class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <button onclick="aplicarFiltroData()" class="bg-forest text-white px-6 py-2 rounded-xl font-bold hover:bg-forest/90 transition-all whitespace-nowrap">Filtrar</button>
            <button onclick="limparFiltro()" class="border border-gray-300 text-gray-500 px-6 py-2 rounded-xl font-bold hover:bg-gray-50 transition-all whitespace-nowrap">Ver Todos</button>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Pedidos no Per√≠odo</p>
            <p class="text-3xl font-bold text-forest" id="periodo-qtd-pedidos">0</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Faturamento no Per√≠odo</p>
            <p class="text-2xl font-bold text-terracotta" id="periodo-faturamento">R$ 0,00</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Ticket M√©dio</p>
            <p class="text-2xl font-bold text-forest" id="periodo-ticket-medio">R$ 0,00</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Total de Itens</p>
            <p class="text-3xl font-bold text-forest" id="periodo-total-itens">0</p>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-sage/20 mb-6 overflow-hidden">
          <div class="p-5 border-b border-sage/10 flex justify-between items-center">
            <p class="font-bold text-forest">Lista de Pedidos</p>
            <p class="text-xs text-gray-400" id="pedidos-periodo-label">Todos os pedidos</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-400 uppercase text-xs">
                <tr>
                  <th class="px-4 py-3 text-left">Data/Hora</th>
                  <th class="px-4 py-3 text-left">Cliente</th>
                  <th class="px-4 py-3 text-left">WhatsApp</th>
                  <th class="px-4 py-3 text-left">Cidade</th>
                  <th class="px-4 py-3 text-left">Combo</th>
                  <th class="px-4 py-3 text-right">Total</th>
                  <th class="px-4 py-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabela-pedidos" class="divide-y divide-gray-50"></tbody>
            </table>
          </div>
          <div id="pedidos-vazio" class="hidden p-12 text-center text-gray-400">
            <p class="text-4xl mb-3">üì≠</p>
            <p class="font-bold">Nenhum pedido encontrado</p>
            <p class="text-xs mt-1">Ajuste o per√≠odo ou aguarde novos pedidos</p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10">
              <p class="font-bold text-forest">üì¶ Faturamento por Combo</p>
              <p class="text-xs text-gray-400 mt-1">Combos mais vendidos no per√≠odo</p>
            </div>
            <div id="ranking-combos" class="p-4 space-y-3"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10">
              <p class="font-bold text-forest">üç± Itens mais pedidos</p>
              <p class="text-xs text-gray-400 mt-1">Top 10 itens no per√≠odo</p>
            </div>
            <div id="ranking-itens" class="p-4 space-y-3"></div>
          </div>
        </div>
      </section>

      <!-- GERENCIAR COMBOS -->
      <section id="page-combos" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar Combos</h2>
          <button onclick="abrirModalCombo()" class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all">+ Novo Combo</button>
        </div>
        <div id="combos-admin-list" class="space-y-3"></div>
      </section>

      <!-- GERENCIAR CARD√ÅPIO -->
      <section id="page-marmitas" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar Card√°pio</h2>
          <button onclick="abrirModalMarmita()" class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all">+ Novo Item</button>
        </div>
        <div id="marmitas-admin-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>

    </main>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-charcoal text-white px-8 py-4 rounded-2xl shadow-2xl z-[70] font-bold text-center max-w-sm"></div>
<script>
  // ============================================================
  // FIREBASE CONFIG
  // ============================================================
  const firebaseConfig = {
    apiKey:            "AIzaSyBL0z6PwA6IkU671G7HJZLsHT9udCT7YI",
    authDomain:        "sabor-e-saude-a233e.firebaseapp.com",
    databaseURL:       "https://sabor-e-saude-a233e-default-rtdb.firebaseio.com",
    projectId:         "sabor-e-saude-a233e",
    storageBucket:     "sabor-e-saude-a233e.firebasestorage.app",
    messagingSenderId: "283293618461",
    appId:             "1:283293618461:web:1db0ad8b6db9f145d791f4",
    measurementId:     "G-R6LW9FKEQF"
  };
  const WHATSAPP_RESTAURANTE = '5547996988109';

  // ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ
  let database;
  let firebaseInitialized = false;
  try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseInitialized = true;
  } catch(e) {
    console.warn('Firebase n√£o configurado. Usando localStorage.');
  }

  // ‚îÄ‚îÄ Estado Global ‚îÄ‚îÄ
  let isAdmin          = false;
  let sidebarVisible   = true;
  let currentCombo     = null;
  let quantities       = {};
  let vegetaisSelecionados = [];
  let spiceLevel       = 2;
  let maxMarmitas      = 0;
  let marmitasCache    = [];
  let combosCache      = [];
  let pedidosCache     = [];
  let pedidoAtualModal = null;

  const CAT_ICONS = {
    marmita:'üç± Marmitas', sopa:'üç≤ Sopas', suco:'ü•§ Sucos',
    sobremesa:'üçÆ Sobremesas', proteico:'üí™ Proteicos',
    'low-carb':'ü•ó Low Carb', vegano:'üå± Veganos', vegetal:'ü•¶ Vegetais'
  };
  const CAT_EMOJI = {
    marmita:'üç±', sopa:'üç≤', suco:'ü•§', sobremesa:'üçÆ',
    proteico:'üí™', 'low-carb':'ü•ó', vegano:'üå±', vegetal:'ü•¶'
  };

  // ‚îÄ‚îÄ Firebase Helpers ‚îÄ‚îÄ
  async function fbGet(path) {
    if (!firebaseInitialized) return null;
    const snap = await database.ref(path).once('value');
    return snap.val();
  }
  async function fbSet(path, value) {
    if (!firebaseInitialized) return;
    await database.ref(path).set(value);
  }
  async function fbRemove(path) {
    if (!firebaseInitialized) return;
    await database.ref(path).remove();
  }
  function lsGet(key)       { return JSON.parse(localStorage.getItem(key)) || []; }
  function lsSet(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

  // ‚îÄ‚îÄ CRUD Marmitas ‚îÄ‚îÄ
  async function getMarmitas() {
    if (!firebaseInitialized) return lsGet('marmitas_fitdata');
    const d = await fbGet('marmitas');
    return d ? Object.values(d) : [];
  }
  async function saveMarmita(m) {
    if (!firebaseInitialized) {
      let list = lsGet('marmitas_fitdata');
      const i  = list.findIndex(x => x.id === m.id);
      i !== -1 ? list[i] = m : list.push(m);
      lsSet('marmitas_fitdata', list);
    } else { await fbSet(`marmitas/${m.id}`, m); }
  }
  async function deleteMarmita(id) {
    if (!firebaseInitialized) lsSet('marmitas_fitdata', lsGet('marmitas_fitdata').filter(m => m.id !== id));
    else await fbRemove(`marmitas/${id}`);
  }

  // ‚îÄ‚îÄ CRUD Combos ‚îÄ‚îÄ
  async function getCombos() {
    if (!firebaseInitialized) return lsGet('combos_fitdata');
    const d = await fbGet('combos');
    return d ? Object.values(d) : [];
  }
  async function saveCombo(c) {
    if (!firebaseInitialized) {
      let list = lsGet('combos_fitdata');
      const i  = list.findIndex(x => x.id === c.id);
      i !== -1 ? list[i] = c : list.push(c);
      lsSet('combos_fitdata', list);
    } else { await fbSet(`combos/${c.id}`, c); }
  }
  async function deleteCombo(id) {
    if (!firebaseInitialized) lsSet('combos_fitdata', lsGet('combos_fitdata').filter(c => c.id !== id));
    else await fbRemove(`combos/${id}`);
  }

  // ‚îÄ‚îÄ CRUD Pedidos ‚îÄ‚îÄ
  async function getPedidos() {
    if (!firebaseInitialized) return lsGet('pedidos_fitdata');
    const d = await fbGet('pedidos');
    return d ? Object.values(d) : [];
  }
  async function savePedido(pedido) {
    if (!firebaseInitialized) {
      let list = lsGet('pedidos_fitdata');
      list.push(pedido);
      lsSet('pedidos_fitdata', list);
    } else { await fbSet(`pedidos/${pedido.id}`, pedido); }
    pedidosCache = await getPedidos();
  }
  async function excluirPedido(id) {
    if (!confirm('Excluir este pedido do banco de dados?')) return;
    if (!firebaseInitialized) lsSet('pedidos_fitdata', lsGet('pedidos_fitdata').filter(p => p.id !== id));
    else await fbRemove(`pedidos/${id}`);
    pedidosCache = await getPedidos();
    showToast('Pedido exclu√≠do!');
    aplicarFiltroData();
    atualizarDashboard();
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  async function initData() {
    document.getElementById('loading').classList.remove('hidden');
    marmitasCache = await getMarmitas();
    combosCache   = await getCombos();
    pedidosCache  = await getPedidos();

    if (marmitasCache.length === 0) {
      const iniciais = [
        {id:1,nome:'Frango com Batata Doce',preco:22.00,kcal:350,desc:'Frango grelhado e pur√™ de batata doce',cat:'marmita',visivel:true,dispCombo:true},
        {id:2,nome:'Patinho com Arroz Integral',preco:25.00,kcal:400,desc:'Carne mo√≠da magra com legumes salteados',cat:'marmita',visivel:true,dispCombo:true},
        {id:3,nome:'Til√°pia com Ervas',preco:28.00,kcal:300,desc:'Peixe assado com ervas e vagem',cat:'marmita',visivel:true,dispCombo:true},
        {id:4,nome:'Strogonoff de Frango Fit',preco:24.00,kcal:380,desc:'Com arroz integral e batata palha',cat:'marmita',visivel:true,dispCombo:true},
        {id:5,nome:'Sopa de Legumes',preco:15.00,kcal:180,desc:'Sopa cremosa com legumes frescos',cat:'sopa',visivel:true,dispCombo:true},
        {id:6,nome:'Suco Detox Verde',preco:8.00,kcal:80,desc:'Couve, lim√£o e gengibre',cat:'suco',visivel:true,dispCombo:false},
        {id:7,nome:'Br√≥colis',preco:0,kcal:35,desc:'Br√≥colis cozido no vapor',cat:'vegetal',visivel:true,dispCombo:true},
        {id:8,nome:'Abobrinha',preco:0,kcal:20,desc:'Abobrinha grelhada',cat:'vegetal',visivel:true,dispCombo:true},
        {id:9,nome:'Cenoura',preco:0,kcal:40,desc:'Cenoura cozida',cat:'vegetal',visivel:true,dispCombo:true},
      ];
      for (const m of iniciais) await saveMarmita(m);
      marmitasCache = iniciais;
    }

    if (combosCache.length === 0) {
      const iniciais = [
        {id:1,nome:'Kit 10 Marmitas',qtd:10,precobase:210.00,tipo:'aberto',visivel:true,itens:{},multiplovalor:0,itensdisponiveis:[],vegetalmin:1,vegetalmax:3},
        {id:2,nome:'Kit 20 Marmitas',qtd:20,precobase:400.00,tipo:'aberto',visivel:true,itens:{},multiplovalor:0,itensdisponiveis:[],vegetalmin:1,vegetalmax:3},
      ];
      for (const c of iniciais) await saveCombo(c);
      combosCache = iniciais;
    }

    // Listeners Firebase tempo real
    if (firebaseInitialized) {
      database.ref('marmitas').on('value', snap => {
        const d = snap.val();
        marmitasCache = d ? Object.values(d) : [];
        renderCardapio();
        if (isAdmin) { renderMarmitasAdmin(); atualizarDashboard(); }
      });
      database.ref('combos').on('value', snap => {
        const d = snap.val();
        combosCache = d ? Object.values(d) : [];
        renderCardapio();
        if (isAdmin) { renderCombosAdmin(); atualizarDashboard(); }
      });
      database.ref('pedidos').on('value', snap => {
        const d = snap.val();
        pedidosCache = d ? Object.values(d) : [];
        atualizarBadgePedidos();
        if (isAdmin) atualizarDashboard();
      });
    }

    const hoje       = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    document.getElementById('filtro-data-inicio').value = primeiroDia.toISOString().split('T')[0];
    document.getElementById('filtro-data-fim').value    = hoje.toISOString().split('T')[0];

    renderCardapio();
    document.getElementById('loading').classList.add('hidden');
    if (!firebaseInitialized) showToast('‚ö†Ô∏è Modo offline ‚Äî configure o Firebase');
  }
  // ‚îÄ‚îÄ Navega√ß√£o ‚îÄ‚îÄ
  function showPage(pageId) {
    document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
    const p = document.getElementById(`page-${pageId}`);
    if (!p) return;
    p.classList.remove('hidden');
    if (pageId === 'dashboard') atualizarDashboard();
    if (pageId === 'combos')    renderCombosAdmin();
    if (pageId === 'marmitas')  renderMarmitasAdmin();
    if (pageId === 'pedidos')   aplicarFiltroData();
  }

  function toggleSidebar() {
    const sb  = document.getElementById('sidebar');
    const btn = document.getElementById('btn-toggle-sidebar');
    sidebarVisible = !sidebarVisible;
    if (sidebarVisible) { sb.classList.remove('hidden'); btn.textContent = '‚ò∞'; btn.title = 'Minimizar menu'; }
    else                { sb.classList.add('hidden');    btn.textContent = '‚ò∞'; btn.title = 'Expandir menu'; }
  }

  // ‚îÄ‚îÄ Login ‚îÄ‚îÄ
  function openAdminModal()  { document.getElementById('admin-modal').classList.remove('hidden'); }
  function closeAdminModal() {
    document.getElementById('admin-modal').classList.add('hidden');
    document.getElementById('login-error').classList.add('hidden');
  }
  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value;
    if (u === 'admin' && p === 'admin123') {
      isAdmin = true;
      closeAdminModal();
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('btn-toggle-sidebar').classList.remove('hidden');
      document.getElementById('btn-admin-view').classList.add('hidden');
      showPage('dashboard');
      atualizarBadgePedidos();
      showToast('‚úÖ Login realizado com sucesso!');
    } else {
      document.getElementById('login-error').classList.remove('hidden');
    }
  }
  function entrarComoCliente() {
    isAdmin = false;
    sidebarVisible = true;
    document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('btn-toggle-sidebar').classList.add('hidden');
    document.getElementById('btn-admin-view').classList.remove('hidden');
    showPage('cardapio');
  }
  function atualizarBadgePedidos() {
    const badge = document.getElementById('badge-pedidos');
    if (pedidosCache.length > 0) { badge.textContent = pedidosCache.length; badge.classList.remove('hidden'); }
    else badge.classList.add('hidden');
  }

  // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
  function atualizarDashboard() {
    const mv  = marmitasCache.filter(m => m.visivel).length;
    const cv  = combosCache.filter(c => c.visivel !== false).length;
    const fat = pedidosCache.reduce((a,p) => a + (p.total||0), 0);
    document.getElementById('stat-combos').textContent          = combosCache.length;
    document.getElementById('stat-combos-visiveis').textContent = `${cv} vis√≠veis`;
    document.getElementById('stat-marmitas').textContent        = marmitasCache.length;
    document.getElementById('stat-marmitas-visiveis').textContent = `${mv} vis√≠veis`;
    document.getElementById('stat-total-pedidos').textContent   = pedidosCache.length;
    document.getElementById('stat-faturamento').textContent     = `R$ ${fat.toFixed(2)}`;
  }

  // ‚îÄ‚îÄ Card√°pio Cliente ‚îÄ‚îÄ
  function renderCardapio() {
    const visiveis = combosCache.filter(c => c.visivel !== false);
    const el = document.getElementById('combos-container');
    if (!visiveis.length) {
      el.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum combo dispon√≠vel.</p>';
      return;
    }
    el.innerHTML = visiveis.map(c => {
      const badge = c.tipo === 'fechado'
        ? '<span class="text-xs bg-terracotta/20 text-terracotta px-2 py-1 rounded-full font-bold">üì¶ Fechado</span>'
        : '<span class="text-xs bg-sage/20 text-sage px-2 py-1 rounded-full font-bold">üõí Aberto</span>';
      const vegInfo = (c.vegetalmax > 0)
        ? `<p class="text-xs text-green-600 mt-1">ü•¶ Inclui at√© ${c.vegetalmax} vegetal(is)</p>` : '';

      let infoExtra = '';
      if (c.tipo === 'fechado') {
        let totalItens = 0;
        const nomes = [];
        Object.entries(c.itens || {}).forEach(([itemId, qtd]) => {
          const m = marmitasCache.find(x => x.id === parseInt(itemId));
          if (m && qtd > 0) { totalItens += qtd; nomes.push(`${qtd}x ${m.nome}`); }
        });
        const previa = nomes.slice(0,3).join(', ') + (nomes.length > 3 ? ` +${nomes.length-3} mais` : '');
        infoExtra = `
          <div class="mt-3 bg-cream rounded-xl p-3">
            <p class="text-xs font-bold text-forest mb-1">üìã ${totalItens} itens inclusos</p>
            <p class="text-xs text-gray-400 leading-relaxed">${previa}</p>
          </div>`;
      } else {
        infoExtra = `<p class="text-xs text-gray-400 mt-2">üí° Cada item sai por <span class="font-bold text-sage">R$ ${(c.precobase/c.qtd).toFixed(2)}</span></p>`;
      }

      return `
        <button onclick="selecionarCombo(${c.id})"
                class="bg-white p-6 rounded-3xl border-2 border-transparent hover:border-forest shadow-sm text-left transition-all hover:-translate-y-1">
          <div class="flex justify-between items-start mb-2">
            <p class="text-forest font-bold text-xl">${c.nome}</p>
            ${badge}
          </div>
          <div class="mt-3">
            <span class="text-3xl font-display font-bold text-terracotta">R$ ${c.precobase.toFixed(2)}</span>
          </div>
          ${infoExtra}${vegInfo}
        </button>`;
    }).join('');
  }

  function selecionarCombo(id) {
    currentCombo = combosCache.find(c => c.id === id);
    if (!currentCombo) { showToast('Combo n√£o encontrado'); return; }
    maxMarmitas = currentCombo.qtd;
    quantities  = {};
    vegetaisSelecionados = [];

    document.getElementById('marmitas-section').classList.remove('hidden');
    document.getElementById('combo-name-display').textContent = currentCombo.nome;
    document.getElementById('max-marmitas').textContent       = maxMarmitas;
    document.getElementById('current-marmitas').textContent   = 0;
    document.getElementById('combo-tipo-badge').textContent   = currentCombo.tipo === 'fechado' ? 'üì¶ Combo Fechado' : 'üõí Voc√™ escolhe os itens';

    if (currentCombo.tipo === 'fechado') {
      mostrarComboFechado();
      document.getElementById('selecao-marmitas-container').classList.add('hidden');
      document.getElementById('progress-counter').classList.add('hidden');
    } else {
      document.getElementById('combo-fechado-itens').classList.add('hidden');
      document.getElementById('selecao-marmitas-container').classList.remove('hidden');
      document.getElementById('progress-counter').classList.remove('hidden');
      renderMarmitas();
    }
    renderVegetais();
    atualizarTotal();
    setTimeout(() => window.scrollTo({ top: document.getElementById('marmitas-section').offsetTop - 100, behavior: 'smooth' }), 100);
  }

  // ‚îÄ‚îÄ Vegetais ‚îÄ‚îÄ
  function renderVegetais() {
    const secao  = document.getElementById('secao-vegetais');
    const vegMax = currentCombo?.vegetalmax || 0;
    const vegMin = currentCombo?.vegetalmin || 0;
    if (!vegMax) { secao.classList.add('hidden'); return; }
    const vegetais = marmitasCache.filter(m => m.cat === 'vegetal' && m.visivel);
    if (!vegetais.length) { secao.classList.add('hidden'); return; }
    secao.classList.remove('hidden');
    document.getElementById('vegetal-counter').textContent     = 0;
    document.getElementById('vegetal-counter-max').textContent = `/ ${vegMax}`;
    document.getElementById('vegetal-instrucao').textContent   = vegMin > 0
      ? `Escolha de ${vegMin} a ${vegMax} vegetal(is) ‚Äî eles s√£o adicionais ao seu kit`
      : `Escolha at√© ${vegMax} vegetal(is) para acompanhar seu kit (opcional)`;
    const container = document.getElementById('vegetais-container');
    container.innerHTML = vegetais.map(v => `
      <button type="button" id="vegetal-btn-${v.id}" onclick="toggleVegetal(${v.id})"
              class="vegetal-btn flex items-center gap-2 px-4 py-3 border-2 border-sage/30 rounded-xl bg-white text-left text-sm font-medium hover:border-forest transition-all w-full">
        <span class="text-xl">${CAT_EMOJI['vegetal']}</span>
        <div>
          <p class="font-medium">${v.nome}</p>
          <p class="text-xs text-gray-400">${v.kcal} kcal</p>
        </div>
      </button>`).join('');
  }

  function toggleVegetal(id) {
    const vegMax = currentCombo?.vegetalmax || 0;
    const idx    = vegetaisSelecionados.indexOf(id);
    const btn    = document.getElementById(`vegetal-btn-${id}`);
    if (idx === -1) {
      if (vegetaisSelecionados.length >= vegMax) { showToast(`‚ö†Ô∏è M√°ximo de ${vegMax} vegetal(is) para este combo`); return; }
      vegetaisSelecionados.push(id);
      btn.classList.add('selected');
    } else {
      vegetaisSelecionados.splice(idx, 1);
      btn.classList.remove('selected');
    }
    document.getElementById('vegetal-counter').textContent = vegetaisSelecionados.length;
  }

  // ‚îÄ‚îÄ Combo Fechado ‚îÄ‚îÄ
  function mostrarComboFechado() {
    const el = document.getElementById('lista-itens-fechado');
    document.getElementById('combo-fechado-itens').classList.remove('hidden');
    const porCat = {};
    Object.entries(currentCombo.itens || {}).forEach(([itemId, qtd]) => {
      const m = marmitasCache.find(x => x.id === parseInt(itemId));
      if (m && qtd > 0) {
        if (!porCat[m.cat]) porCat[m.cat] = [];
        porCat[m.cat].push({...m, quantidade: qtd});
      }
    });
    let totalGeral = 0;
    Object.values(porCat).forEach(arr => arr.forEach(i => totalGeral += i.quantidade));
    el.innerHTML = `
      <p class="text-xs text-gray-400 mb-4">Total: <span class="font-bold text-forest">${totalGeral} itens</span> inclusos neste combo</p>
      ${Object.keys(porCat).map(cat => `
        <div class="mb-4">
          <p class="font-bold text-xs uppercase text-gray-400 mb-2">${CAT_ICONS[cat]||'üì¶ Outros'}</p>
          <div class="space-y-2">
            ${porCat[cat].map(item => `
              <div class="bg-cream rounded-xl overflow-hidden">
                <button type="button" onclick="toggleDescItem(this)"
                        class="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-sage/10 transition-all">
                  <div class="flex items-center gap-3">
                    <span class="bg-forest text-white text-xs font-bold px-2 py-1 rounded-lg min-w-[32px] text-center">${item.quantidade}x</span>
                    <span class="font-medium text-charcoal text-sm">${CAT_EMOJI[item.cat]||'üç¥'} ${item.nome}</span>
                    <span class="text-xs text-gray-400">${item.kcal} kcal</span>
                  </div>
                  <span class="text-gray-400 text-xs ml-2 shrink-0">‚ñº</span>
                </button>
                <div class="desc-item hidden px-4 pb-3">
                  <p class="text-xs text-gray-500 leading-relaxed border-t border-sage/20 pt-2">${item.desc}</p>
                </div>
              </div>`).join('')}
          </div>
        </div>`).join('')}`;
  }

  function toggleDescItem(btn) {
    const desc  = btn.nextElementSibling;
    const arrow = btn.querySelector('span:last-child');
    const aberto = !desc.classList.contains('hidden');
    desc.classList.toggle('hidden', aberto);
    arrow.textContent = aberto ? '‚ñº' : '‚ñ≤';
  }
  function renderMarmitas() {
    let disponiveis = marmitasCache.filter(m =>
      m.visivel && m.cat !== 'vegetal' && m.dispCombo !== false
    );
    if (currentCombo?.itensdisponiveis?.length > 0) {
      disponiveis = disponiveis.filter(m => currentCombo.itensdisponiveis.includes(m.id));
    }
    const el = document.getElementById('marmitas-container');
    if (!disponiveis.length) {
      el.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum item dispon√≠vel.</p>';
      return;
    }
    const multiplo = currentCombo?.multiplovalor || 0;
    const porCat   = {};
    disponiveis.forEach(m => {
      if (!porCat[m.cat]) porCat[m.cat] = [];
      porCat[m.cat].push(m);
    });
    el.innerHTML = Object.keys(porCat).map(cat => `
      <div class="mb-6">
        <p class="text-xs font-bold uppercase text-gray-400 mb-3 ml-1">${CAT_ICONS[cat]||'üç¥ Outros'}</p>
        ${porCat[cat].map(m => `
          <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-100 hover:border-sage/50 transition-all mb-2">
            <div class="flex-1 pr-4">
              <p class="font-bold text-forest">${CAT_EMOJI[m.cat]||'üç¥'} ${m.nome}</p>
              <p class="text-xs text-gray-400 leading-tight mt-1">${m.desc} ‚Ä¢ ${m.kcal} kcal</p>
              ${multiplo > 0 ? `<p class="text-[10px] text-blue-500 mt-1">üî¢ M√∫ltiplo de ${multiplo}</p>` : ''}
            </div>
            <div class="flex items-center gap-3 bg-cream p-1 rounded-xl">
              <button type="button" onclick="updateQty(${m.id},-1)"
                      class="w-8 h-8 rounded-lg bg-white shadow-sm font-bold hover:bg-red-50 transition-all">‚àí</button>
              <span id="qty-${m.id}" class="font-bold w-8 text-center">${quantities[m.id]||0}</span>
              <button type="button" onclick="updateQty(${m.id},1)"
                      class="w-8 h-8 rounded-lg bg-forest text-white shadow-sm font-bold hover:bg-forest/80 transition-all">+</button>
            </div>
          </div>`).join('')}
      </div>`).join('');
  }

  function updateQty(id, delta) {
    const multiplo = currentCombo?.multiplovalor || 0;
    const passo    = multiplo > 0 ? multiplo : 1;
    const atual    = quantities[id] || 0;
    const novo     = Math.max(0, atual + delta * passo);
    const total    = Object.entries(quantities).reduce((a,[k,v]) => a + (parseInt(k)===id ? 0 : v), 0) + novo;
    if (delta > 0 && total > maxMarmitas) {
      showToast(`‚ö†Ô∏è Kit completo! M√°ximo de ${maxMarmitas} marmitas`);
      return;
    }
    quantities[id] = novo;
    const el = document.getElementById(`qty-${id}`);
    if (el) el.textContent = novo;
    const novoTotal = Object.values(quantities).reduce((a,b) => a+b, 0);
    document.getElementById('current-marmitas').textContent = novoTotal;
    const pct = Math.min(100, Math.round((novoTotal/maxMarmitas)*100));
    const bar = document.getElementById('progress-bar');
    if (bar) bar.style.width = pct + '%';
    if (novoTotal === maxMarmitas) showToast('üéâ Kit completo! Agora escolha seus vegetais abaixo.');
    atualizarTotal();
  }

  function atualizarTotal() {
    if (currentCombo)
      document.getElementById('total-price').textContent = `R$ ${currentCombo.precobase.toFixed(2)}`;
  }

  function setSpiceLevel(l) {
    spiceLevel = l;
    document.querySelectorAll('.spice-btn').forEach((btn,i) => {
      const active = (i === l-1);
      btn.classList.toggle('border-2',       active);
      btn.classList.toggle('border-forest',  active);
      btn.classList.toggle('bg-forest/5',    active);
      btn.classList.toggle('font-bold',      active);
      btn.classList.toggle('border-sage/20', !active);
      btn.classList.toggle('bg-white',       !active);
    });
  }

  function resetarPedido() {
    currentCombo = null; quantities = {}; vegetaisSelecionados = []; spiceLevel = 2; maxMarmitas = 0;
    document.getElementById('marmitas-section').classList.add('hidden');
    document.getElementById('combo-fechado-itens').classList.add('hidden');
    document.getElementById('selecao-marmitas-container').classList.remove('hidden');
    document.getElementById('progress-counter').classList.remove('hidden');
    document.getElementById('secao-vegetais').classList.add('hidden');
    document.getElementById('total-price').textContent = 'R$ 0,00';
    document.getElementById('current-marmitas').textContent = '0';
    document.getElementById('progress-bar').style.width = '0';
    document.getElementById('observations').value = '';
    document.getElementById('cliente-nome').value = '';
    document.getElementById('cliente-tel').value  = '';
    document.getElementById('cliente-endereco').value = '';
    document.getElementById('cliente-cidade').value   = '';
    showPage('cardapio');
  }

  // ‚îÄ‚îÄ Finalizar Pedido ‚îÄ‚îÄ
  async function finalizarPedido() {
    const nome     = document.getElementById('cliente-nome').value.trim();
    const tel      = document.getElementById('cliente-tel').value.trim();
    const endereco = document.getElementById('cliente-endereco').value.trim();
    const cidade   = document.getElementById('cliente-cidade').value.trim();
    const obs      = document.getElementById('observations').value.trim();

    if (!currentCombo)  { showToast('‚ö†Ô∏è Selecione um combo primeiro!'); return; }
    if (!nome)          { showToast('‚ö†Ô∏è Informe seu nome!'); return; }
    if (!tel)           { showToast('‚ö†Ô∏è Informe seu WhatsApp!'); return; }
    if (!endereco)      { showToast('‚ö†Ô∏è Informe o endere√ßo de entrega!'); return; }

    const spiceLabels = ['Suave','M√©dio','Picante'];

    let itensPedido = [];
    if (currentCombo.tipo === 'fechado') {
      Object.entries(currentCombo.itens||{}).forEach(([itemId,qtd]) => {
        const m = marmitasCache.find(x => x.id === parseInt(itemId));
        if (m && qtd > 0) itensPedido.push({id:m.id, nome:m.nome, quantidade:qtd});
      });
    } else {
      const total = Object.values(quantities).reduce((a,b)=>a+b,0);
      if (total === 0) { showToast('‚ö†Ô∏è Selecione pelo menos um item!'); return; }
      if (total < maxMarmitas) {
        if (!confirm(`Voc√™ selecionou ${total} de ${maxMarmitas} itens. Deseja continuar assim mesmo?`)) return;
      }
      Object.entries(quantities).forEach(([id,qtd]) => {
        if (qtd > 0) {
          const m = marmitasCache.find(x => x.id === parseInt(id));
          if (m) itensPedido.push({id:m.id, nome:m.nome, quantidade:qtd});
        }
      });
    }

    const vegetaisNomes = vegetaisSelecionados.map(id => {
      const v = marmitasCache.find(x => x.id === id);
      return v ? v.nome : '';
    }).filter(Boolean);

    const pedido = {
      id:        Date.now(),
      data:      new Date().toISOString(),
      nome, tel, endereco, cidade,
      combo:     currentCombo.nome,
      comboId:   currentCombo.id,
      itens:     itensPedido,
      vegetais:  vegetaisNomes,
      tempero:   spiceLabels[spiceLevel-1],
      obs,
      total:     currentCombo.precobase
    };

    await savePedido(pedido);

    // Montar mensagem WhatsApp
    let msg = `üç± *NOVO PEDIDO - Sabor e Sa√∫de*\n\n`;
    msg += `üë§ *Cliente:* ${nome}\n`;
    msg += `üì± *WhatsApp:* ${tel}\n`;
    msg += `üìç *Endere√ßo:* ${endereco}, ${cidade}\n\n`;
    msg += `üì¶ *Combo:* ${currentCombo.nome}\n`;
    msg += `üí∞ *Total:* R$ ${currentCombo.precobase.toFixed(2)}\n\n`;
    msg += `üçΩÔ∏è *Itens:\n*`;
    itensPedido.forEach(i => { msg += `  ‚Ä¢ ${i.quantidade}x ${i.nome}\n`; });
    if (vegetaisNomes.length) msg += `\nü•¶ *Vegetais:* ${vegetaisNomes.join(', ')}\n`;
    msg += `\nüå∂Ô∏è *Tempero:* ${spiceLabels[spiceLevel-1]}\n`;
    if (obs) msg += `\nüìù *Observa√ß√µes:* ${obs}\n`;
    msg += `\n_Pedido registrado em ${new Date().toLocaleString('pt-BR')}_`;

    window.open(`https://wa.me/${WHATSAPP_RESTAURANTE}?text=${encodeURIComponent(msg)}`, '_blank');
    showToast('‚úÖ Pedido enviado!');
    setTimeout(resetarPedido, 2000);
  }

  function abrirCotacaoEspecial() {
    const msg = encodeURIComponent(
      `Ol√°! Vim pelo card√°pio digital da Sabor e Sa√∫de ü•ó\n\n` +
      `Tenho uma dieta diferenciada e gostaria de uma cota√ß√£o personalizada.\n\n` +
      `Poderia me ajudar?`
    );
    window.open(`https://wa.me/${WHATSAPP_RESTAURANTE}?text=${msg}`, '_blank');
  }

  // ‚îÄ‚îÄ Admin: visualizar pedido ‚îÄ‚îÄ
  function verPedido(id) {
    pedidoAtualModal = pedidosCache.find(p => p.id === id);
    if (!pedidoAtualModal) return;
    const p   = pedidoAtualModal;
    const el  = document.getElementById('modal-pedido-content');
    const itensHtml = (p.itens||[]).map(i => `<li class="text-sm">‚Ä¢ ${i.quantidade}x ${i.nome}</li>`).join('');
    const vegsHtml  = (p.vegetais||[]).length ? `<p class="text-sm text-green-700">ü•¶ ${p.vegetais.join(', ')}</p>` : '';
    el.innerHTML = `
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><p class="text-xs text-gray-400">Cliente</p><p class="font-bold">${p.nome}</p></div>
        <div><p class="text-xs text-gray-400">WhatsApp</p><p class="font-bold">${p.tel}</p></div>
        <div class="col-span-2"><p class="text-xs text-gray-400">Endere√ßo</p><p class="font-bold">${p.endereco}, ${p.cidade}</p></div>
        <div><p class="text-xs text-gray-400">Combo</p><p class="font-bold">${p.combo}</p></div>
        <div><p class="text-xs text-gray-400">Total</p><p class="font-bold text-terracotta">R$ ${(p.total||0).toFixed(2)}</p></div>
      </div>
      <div class="bg-cream rounded-xl p-4 mt-2">
        <p class="text-xs text-gray-400 mb-2">Itens</p>
        <ul class="space-y-1">${itensHtml}</ul>
        ${vegsHtml}
      </div>
      ${p.obs ? `<div class="bg-yellow-50 rounded-xl p-3"><p class="text-xs text-gray-400">Obs</p><p class="text-sm">${p.obs}</p></div>` : ''}
      <p class="text-xs text-gray-400 text-center">${new Date(p.data).toLocaleString('pt-BR')}</p>`;
    document.getElementById('modal-pedido').classList.remove('hidden');
  }
  function closeModalPedido() { document.getElementById('modal-pedido').classList.add('hidden'); }
  function abrirWhatsAppCliente() {
    if (pedidoAtualModal?.tel)
      window.open(`https://wa.me/55${pedidoAtualModal.tel.replace(/\D/g,'')}`, '_blank');
  }

  // ‚îÄ‚îÄ Filtros / Relat√≥rios ‚îÄ‚îÄ
  function aplicarFiltroData() {
    const ini = document.getElementById('filtro-data-inicio').value;
    const fim = document.getElementById('filtro-data-fim').value;
    let filtrados = pedidosCache;
    if (ini) filtrados = filtrados.filter(p => p.data >= ini);
    if (fim) filtrados = filtrados.filter(p => p.data <= fim + 'T23:59:59');
    renderTabelaPedidos(filtrados);
    renderRankings(filtrados);
    const fat    = filtrados.reduce((a,p)=>a+(p.total||0),0);
    const ticket = filtrados.length ? fat/filtrados.length : 0;
    const itens  = filtrados.reduce((a,p)=>a+(p.itens||[]).reduce((b,i)=>b+i.quantidade,0),0);
    document.getElementById('periodo-qtd-pedidos').textContent  = filtrados.length;
    document.getElementById('periodo-faturamento').textContent  = `R$ ${fat.toFixed(2)}`;
    document.getElementById('periodo-ticket-medio').textContent = `R$ ${ticket.toFixed(2)}`;
    document.getElementById('periodo-total-itens').textContent  = itens;
    document.getElementById('pedidos-periodo-label').textContent = (ini||fim) ? `${ini||'in√≠cio'} ‚Üí ${fim||'hoje'}` : 'Todos os pedidos';
  }
  function limparFiltro() {
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value    = '';
    aplicarFiltroData();
  }
  function renderTabelaPedidos(lista) {
    const tbody = document.getElementById('tabela-pedidos');
    const vazio = document.getElementById('pedidos-vazio');
    if (!lista.length) { tbody.innerHTML=''; vazio.classList.remove('hidden'); return; }
    vazio.classList.add('hidden');
    tbody.innerHTML = [...lista].sort((a,b)=>b.data.localeCompare(a.data)).map(p => `
      <tr class="table-row cursor-pointer" onclick="verPedido(${p.id})">
        <td class="px-4 py-3 text-xs">${new Date(p.data).toLocaleString('pt-BR')}</td>
        <td class="px-4 py-3 font-medium">${p.nome}</td>
        <td class="px-4 py-3 text-xs">${p.tel}</td>
        <td class="px-4 py-3 text-xs">${p.cidade||'-'}</td>
        <td class="px-4 py-3 text-xs">${p.combo}</td>
        <td class="px-4 py-3 text-right font-bold text-forest">R$ ${(p.total||0).toFixed(2)}</td>
        <td class="px-4 py-3 text-center">
          <button onclick="event.stopPropagation();excluirPedido(${p.id})"
                  class="text-red-400 hover:text-red-600 text-xs px-2 py-1 rounded hover:bg-red-50">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
  }
  function renderRankings(lista) {
    const combosMap = {};
    const itensMap  = {};
    lista.forEach(p => {
      combosMap[p.combo] = (combosMap[p.combo]||0) + (p.total||0);
      (p.itens||[]).forEach(i => { itensMap[i.nome] = (itensMap[i.nome]||0) + i.quantidade; });
    });
    const rc = document.getElementById('ranking-combos');
    const ri = document.getElementById('ranking-itens');
    const renderBar = (label, val, max, suffix) =>
      `<div class="flex items-center gap-3">
         <span class="text-sm flex-1 truncate">${label}</span>
         <div class="w-24 bg-gray-100 rounded-full h-2"><div class="bg-forest h-2 rounded-full" style="width:${Math.round(val/max*100)}%"></div></div>
         <span class="text-xs font-bold text-forest w-16 text-right">${suffix}</span>
       </div>`;
    const cvs = Object.entries(combosMap).sort((a,b)=>b[1]-a[1]);
    rc.innerHTML = cvs.length ? cvs.map(([n,v])=>renderBar(n,v,cvs[0][1],`R$ ${v.toFixed(2)}`)).join('') : '<p class="text-xs text-gray-400">Sem dados</p>';
    const ivs = Object.entries(itensMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
    ri.innerHTML = ivs.length ? ivs.map(([n,v])=>renderBar(n,v,ivs[0][1],`${v}x`)).join('') : '<p class="text-xs text-gray-400">Sem dados</p>';
  }

  // ‚îÄ‚îÄ Exportar ‚îÄ‚îÄ
  function exportarBancoDados() {
    const dados = { marmitas: marmitasCache, combos: combosCache, pedidos: pedidosCache, exportadoEm: new Date().toISOString() };
    const blob  = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url   = URL.createObjectURL(blob);
    const a     = document.createElement('a');
    a.href = url; a.download = `sabor-saude-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click(); URL.revokeObjectURL(url);
  }

  // ‚îÄ‚îÄ Admin Marmitas ‚îÄ‚îÄ
  function renderMarmitasAdmin() {
    const el = document.getElementById('marmitas-admin-list');
    if (!marmitasCache.length) { el.innerHTML = '<p class="text-gray-400">Nenhum item cadastrado.</p>'; return; }
    el.innerHTML = marmitasCache.map(m => `
      <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
        <div class="flex justify-between items-start mb-2">
          <div>
            <p class="font-bold text-forest">${CAT_EMOJI[m.cat]||'üç¥'} ${m.nome}</p>
            <p class="text-xs text-gray-400">${CAT_ICONS[m.cat]||m.cat} ‚Ä¢ ${m.kcal} kcal ‚Ä¢ R$ ${m.preco?.toFixed(2)||'0.00'}</p>
          </div>
          <div class="flex gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${m.visivel ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}">${m.visivel?'Vis√≠vel':'Oculto'}</span>
            <span class="text-xs px-2 py-1 rounded-full ${m.dispCombo!==false?'bg-blue-100 text-blue-700':'bg-gray-100 text-gray-400'}">${m.dispCombo!==false?'Combo ‚úì':'Combo ‚úó'}</span>
          </div>
        </div>
        <p class="text-xs text-gray-500 mb-3">${m.desc}</p>
        <div class="flex gap-2">
          <button onclick="editarMarmita(${m.id})" class="text-xs bg-sage/20 text-forest px-3 py-1.5 rounded-lg hover:bg-sage/40 transition-all">‚úèÔ∏è Editar</button>
          <button onclick="excluirMarmitaAdmin(${m.id})" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-all">üóëÔ∏è Excluir</button>
        </div>
      </div>`).join('');
  }

  function abrirModalMarmita(id = null) {
    document.getElementById('modal-marmita-title').textContent = id ? 'Editar Item' : 'Novo Item';
    document.getElementById('edit-marmita-id').value = id || '';
    if (id) {
      const m = marmitasCache.find(x => x.id === id);
      if (m) {
        document.getElementById('marmita-nome').value  = m.nome;
        document.getElementById('marmita-preco').value = m.preco;
        document.getElementById('marmita-kcal').value  = m.kcal;
        document.getElementById('marmita-desc').value  = m.desc;
        document.getElementById('marmita-cat').value   = m.cat;
        document.getElementById('marmita-visivel').checked          = m.visivel !== false;
        document.getElementById('marmita-disponivel-combo').checked = m.dispCombo !== false;
      }
    } else {
      document.getElementById('marmita-nome').value  = '';
      document.getElementById('marmita-preco').value = '';
      document.getElementById('marmita-kcal').value  = '';
      document.getElementById('marmita-desc').value  = '';
      document.getElementById('marmita-cat').value   = 'marmita';
      document.getElementById('marmita-visivel').checked          = true;
      document.getElementById('marmita-disponivel-combo').checked = true;
    }
    document.getElementById('modal-marmita').classList.remove('hidden');
  }
  function closeModalMarmita() { document.getElementById('modal-marmita').classList.add('hidden'); }
  function editarMarmita(id)   { abrirModalMarmita(id); }

  async function salvarMarmita(e) {
    e.preventDefault();
    const id = document.getElementById('edit-marmita-id').value;
    const m  = {
      id:        id ? parseInt(id) : (marmitasCache.length ? Math.max(...marmitasCache.map(x=>x.id))+1 : 1),
      nome:      document.getElementById('marmita-nome').value.trim(),
      preco:     parseFloat(document.getElementById('marmita-preco').value),
      kcal:      parseInt(document.getElementById('marmita-kcal').value),
      desc:      document.getElementById('marmita-desc').value.trim(),
      cat:       document.getElementById('marmita-cat').value,
      visivel:   document.getElementById('marmita-visivel').checked,
      dispCombo: document.getElementById('marmita-disponivel-combo').checked,
    };
    await saveMarmita(m);
    showToast(id ? '‚úÖ Item atualizado!' : '‚úÖ Item criado!');
    closeModalMarmita();
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }

  async function excluirMarmitaAdmin(id) {
    if (!confirm('Excluir este item do card√°pio?')) return;
    await deleteMarmita(id);
    showToast('‚úÖ Item exclu√≠do!');
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }
  // ‚îÄ‚îÄ Admin Combos ‚îÄ‚îÄ
  function renderCombosAdmin() {
    const el = document.getElementById('combos-admin-list');
    if (!combosCache.length) { el.innerHTML = '<p class="text-gray-400">Nenhum combo cadastrado.</p>'; return; }
    el.innerHTML = combosCache.map(c => `
      <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 flex justify-between items-center">
        <div>
          <div class="flex items-center gap-2 mb-1">
            <p class="font-bold text-forest">${c.nome}</p>
            <span class="text-xs px-2 py-0.5 rounded-full ${c.tipo==='fechado'?'bg-terracotta/20 text-terracotta':'bg-sage/20 text-sage'}">${c.tipo==='fechado'?'Fechado':'Aberto'}</span>
            <span class="text-xs px-2 py-0.5 rounded-full ${c.visivel!==false?'bg-green-100 text-green-700':'bg-gray-100 text-gray-400'}">${c.visivel!==false?'Vis√≠vel':'Oculto'}</span>
          </div>
          <p class="text-xs text-gray-400">${c.qtd} itens ‚Ä¢ R$ ${c.precobase?.toFixed(2)} ‚Ä¢ R$ ${(c.precobase/c.qtd).toFixed(2)}/item</p>
          ${c.multiplovalor > 0 ? `<p class="text-xs text-blue-500 mt-0.5">üî¢ M√∫ltiplo de ${c.multiplovalor}</p>` : ''}
          ${c.itensdisponiveis?.length > 0 ? `<p class="text-xs text-forest mt-0.5">üç± ${c.itensdisponiveis.length} itens espec√≠ficos</p>` : ''}
        </div>
        <div class="flex gap-2">
          <button onclick="editarCombo(${c.id})" class="text-xs bg-sage/20 text-forest px-3 py-1.5 rounded-lg hover:bg-sage/40 transition-all">‚úèÔ∏è Editar</button>
          <button onclick="excluirComboAdmin(${c.id})" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-all">üóëÔ∏è Excluir</button>
        </div>
      </div>`).join('');
  }

  // ‚îÄ‚îÄ Modal Combo: fun√ß√µes ‚îÄ‚îÄ
  function toggleTipoCombo() {
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    document.getElementById('config-aberto').classList.toggle('hidden', tipo === 'fechado');
    document.getElementById('config-fechado').classList.toggle('hidden', tipo === 'aberto');
    if (tipo === 'fechado') {
      document.getElementById('combo-qtd').removeAttribute('required');
      document.getElementById('combo-preco').removeAttribute('required');
      document.getElementById('combo-preco-fechado').setAttribute('required','required');
      carregarItensComboFechado();
    } else {
      document.getElementById('combo-qtd').setAttribute('required','required');
      document.getElementById('combo-preco').setAttribute('required','required');
      document.getElementById('combo-preco-fechado').removeAttribute('required');
      carregarItensDisponiveisCombo(null);
    }
    atualizarPreviewCombo();
  }

  function carregarItensComboFechado() {
    const el = document.getElementById('itens-combo-container');
    const porCat = {};
    marmitasCache.filter(m => m.dispCombo !== false && m.cat !== 'vegetal').forEach(m => {
      if (!porCat[m.cat]) porCat[m.cat] = [];
      porCat[m.cat].push(m);
    });
    el.innerHTML = Object.keys(porCat).map(cat => `
      <div class="mb-4">
        <p class="font-bold text-sm text-forest mb-2">${CAT_ICONS[cat]||'üì¶ Outros'}</p>
        ${porCat[cat].map(item => `
          <div class="flex items-center gap-3 py-2 px-3 hover:bg-sage/5 rounded-lg">
            <div class="flex-1">
              <span class="text-sm">${item.nome}</span>
              <span class="text-xs text-gray-400 ml-2">${item.kcal} kcal</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-500">Qtd:</label>
              <input type="number" name="item-combo-${item.id}" min="0" value="0"
                     onchange="atualizarPreviewCombo()"
                     class="qty-input w-16 px-2 py-1 border border-sage/30 rounded text-center text-sm focus:outline-forest">
            </div>
          </div>`).join('')}
      </div>`).join('');
  }

  function atualizarPreviewCombo() {
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    const el   = document.getElementById('preco-unitario-preview');
    if (tipo === 'aberto') {
      const qtd   = parseInt(document.getElementById('combo-qtd').value)    || 0;
      const preco = parseFloat(document.getElementById('combo-preco').value) || 0;
      el.textContent = (qtd > 0 && preco > 0) ? `Cada item sair√° por R$ ${(preco/qtd).toFixed(2)}` : 'Preencha quantidade e pre√ßo';
    } else {
      let total = 0;
      document.querySelectorAll('input[name^="item-combo-"]').forEach(i => { total += parseInt(i.value)||0; });
      const preco = parseFloat(document.getElementById('combo-preco-fechado').value) || 0;
      el.textContent = total > 0 ? `${total} itens${preco>0?` ‚Ä¢ R$ ${(preco/total).toFixed(2)} por item`:' ‚Ä¢ Defina o pre√ßo'}` : 'Selecione os itens e defina o pre√ßo';
    }
  }

  function toggleMultiplo() {
    const ativo = document.getElementById('combo-multiplo-ativo').checked;
    document.getElementById('combo-multiplo-config').classList.toggle('hidden', !ativo);
  }

  function marcarTodosItensCombo(estado) {
    document.querySelectorAll('input[name="item-disp-combo"]').forEach(cb => cb.checked = estado);
  }

  function carregarItensDisponiveisCombo(itensSelecionados = null) {
    const el = document.getElementById('itens-disponiveis-combo');
    if (!el) return;
    const disponiveis = marmitasCache.filter(m => m.dispCombo !== false && m.cat !== 'vegetal' && m.visivel);
    if (!disponiveis.length) { el.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">Nenhum item dispon√≠vel</p>'; return; }
    const porCat = {};
    disponiveis.forEach(m => {
      if (!porCat[m.cat]) porCat[m.cat] = [];
      porCat[m.cat].push(m);
    });
    el.innerHTML = Object.keys(porCat).map(cat => `
      <div class="mb-3">
        <p class="text-xs font-bold uppercase text-gray-400 mb-1">${CAT_ICONS[cat]||'Outros'}</p>
        ${porCat[cat].map(m => `
          <label class="flex items-center gap-2 py-1.5 px-2 rounded-lg hover:bg-white cursor-pointer">
            <input type="checkbox" name="item-disp-combo" value="${m.id}" class="w-4 h-4 rounded"
                   ${itensSelecionados !== null && itensSelecionados.includes(m.id) ? 'checked' : ''}>
            <span class="text-sm text-charcoal">${CAT_EMOJI[m.cat]||'üç¥'} ${m.nome}</span>
            <span class="text-xs text-gray-400 ml-auto">${m.kcal} kcal</span>
          </label>`).join('')}
      </div>`).join('');
  }

  function abrirModalCombo(id = null) {
    document.getElementById('modal-combo-title').textContent = id ? 'Editar Combo' : 'Novo Combo';
    document.getElementById('edit-combo-id').value = id || '';
    if (id) {
      const c = combosCache.find(x => x.id === id);
      if (c) {
        document.getElementById('combo-nome').value        = c.nome;
        document.getElementById('combo-visivel').checked   = c.visivel !== false;
        document.getElementById('combo-vegetal-min').value = c.vegetalmin || 0;
        document.getElementById('combo-vegetal-max').value = c.vegetalmax || 0;
        if (c.tipo === 'fechado') {
          document.querySelector('input[name="tipo-combo"][value="fechado"]').checked = true;
          toggleTipoCombo();
          document.getElementById('combo-preco-fechado').value = c.precobase;
          setTimeout(() => {
            Object.entries(c.itens||{}).forEach(([itemId,qtd]) => {
              const inp = document.querySelector(`input[name="item-combo-${itemId}"]`);
              if (inp) inp.value = qtd;
            });
            atualizarPreviewCombo();
          }, 100);
        } else {
          document.querySelector('input[name="tipo-combo"][value="aberto"]').checked = true;
          toggleTipoCombo();
          document.getElementById('combo-qtd').value   = c.qtd;
          document.getElementById('combo-preco').value = c.precobase;
          const temMultiplo = c.multiplovalor > 0;
          document.getElementById('combo-multiplo-ativo').checked = temMultiplo;
          document.getElementById('combo-multiplo-valor').value   = c.multiplovalor || 5;
          document.getElementById('combo-multiplo-config').classList.toggle('hidden', !temMultiplo);
          const sel = Array.isArray(c.itensdisponiveis) && c.itensdisponiveis.length > 0 ? c.itensdisponiveis : null;
          carregarItensDisponiveisCombo(sel);
          atualizarPreviewCombo();
        }
      }
    } else {
      document.getElementById('combo-nome').value              = '';
      document.getElementById('combo-qtd').value               = '';
      document.getElementById('combo-preco').value             = '';
      document.getElementById('combo-preco-fechado').value     = '';
      document.getElementById('combo-vegetal-min').value       = '0';
      document.getElementById('combo-vegetal-max').value       = '0';
      document.getElementById('combo-visivel').checked         = true;
      document.getElementById('combo-multiplo-ativo').checked  = false;
      document.getElementById('combo-multiplo-valor').value    = '5';
      document.getElementById('combo-multiplo-config').classList.add('hidden');
      document.querySelector('input[name="tipo-combo"][value="aberto"]').checked = true;
      toggleTipoCombo();
      carregarItensDisponiveisCombo(null);
    }
    document.getElementById('modal-combo').classList.remove('hidden');
  }

  function closeModalCombo() { document.getElementById('modal-combo').classList.add('hidden'); }
  function editarCombo(id)   { abrirModalCombo(id); }

  async function salvarCombo(e) {
    e.preventDefault();
    const id      = document.getElementById('edit-combo-id').value;
    const nome    = document.getElementById('combo-nome').value.trim();
    const visivel = document.getElementById('combo-visivel').checked;
    const tipo    = document.querySelector('input[name="tipo-combo"]:checked').value;
    const vegMin  = parseInt(document.getElementById('combo-vegetal-min').value) || 0;
    const vegMax  = parseInt(document.getElementById('combo-vegetal-max').value) || 0;
    let qtd, precobase, itens = {}, multiplovalor = 0, itensdisponiveis = [];

    if (tipo === 'fechado') {
      let total = 0;
      document.querySelectorAll('input[name^="item-combo-"]').forEach(inp => {
        const itemId = inp.name.replace('item-combo-','');
        const q = parseInt(inp.value) || 0;
        if (q > 0) { itens[itemId] = q; total += q; }
      });
      if (!total) { showToast('‚ö†Ô∏è Selecione pelo menos um item!'); return; }
      qtd       = total;
      precobase = parseFloat(document.getElementById('combo-preco-fechado').value);
    } else {
      qtd       = parseInt(document.getElementById('combo-qtd').value);
      precobase = parseFloat(document.getElementById('combo-preco').value);
      const multiploAtivo = document.getElementById('combo-multiplo-ativo').checked;
      multiplovalor = multiploAtivo
        ? (parseInt(document.getElementById('combo-multiplo-valor').value) || 1)
        : 0;

      document.querySelectorAll('input[name="item-disp-combo"]:checked').forEach(cb => {
        itensdisponiveis.push(parseInt(cb.value));
      });
    }

    if (!qtd || !precobase) { showToast('‚ö†Ô∏è Preencha quantidade e pre√ßo'); return; }

    const combo = {
      id:               id ? parseInt(id) : (combosCache.length ? Math.max(...combosCache.map(c=>c.id))+1 : 1),
      nome, qtd, precobase, visivel, tipo, itens,
      multiplovalor,
      itensdisponiveis,
      vegetalmin: vegMin,
      vegetalmax: vegMax
    };
    await saveCombo(combo);
    showToast(id ? '‚úÖ Combo atualizado!' : '‚úÖ Combo criado!');
    closeModalCombo();
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  async function excluirComboAdmin(id) {
    if (!confirm('Excluir este combo?')) return;
    await deleteCombo(id);
    showToast('‚úÖ Combo exclu√≠do!');
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  // ============================================================
  // UTILIT√ÅRIOS
  // ============================================================
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3500);
  }

  // ============================================================
  // START
  // ============================================================
  window.onload = initData;
</script>
</body>
</html>
