<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sabor e Sa√∫de - Card√°pio de Marmitas Fit</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            forest:     '#2D5A3D',
            sage:       '#8FAE8B',
            cream:      '#FDF8F3',
            terracotta: '#C4785A',
            charcoal:   '#2A2A2A'
          }
        }
      }
    }
  </script>
  <style>
    .font-display { font-family: 'Playfair Display', serif; }
    .font-body    { font-family: 'DM Sans', sans-serif; }
    body          { background-color: #FDF8F3; }
    .fade-in      { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    .modal-bg     { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .loading-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(253,248,243,0.95);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    input[type="number"].qty-input { -moz-appearance:textfield; appearance:textfield; }
    input[type="number"].qty-input::-webkit-inner-spin-button,
    input[type="number"].qty-input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    .table-row:hover { background-color: #f9f5f0; }
    .sidebar-hidden { display: none !important; }
    .vegetal-btn.selected {
      border-color: #2D5A3D !important;
      background-color: #2D5A3D !important;
      color: white !important;
    }
  </style>
</head>
<body class="h-full font-body text-charcoal">

<!-- ==================== LOADING ==================== -->
<div id="loading" class="loading-overlay">
  <div class="text-center">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-forest mx-auto mb-4"></div>
    <p class="text-forest font-bold">Carregando card√°pio...</p>
  </div>
</div>

<!-- ==================== MODAL LOGIN ADMIN ==================== -->
<div id="admin-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
    <h2 class="font-display text-2xl text-forest mb-4">Acesso Administrativo</h2>
    <form onsubmit="handleLogin(event)" class="space-y-4">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Usu√°rio</label>
        <input id="login-username" type="text" autocomplete="username"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Senha</label>
        <input id="login-password" type="password" autocomplete="current-password"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <button type="submit"
              class="w-full bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">
        Entrar no Painel
      </button>
      <button type="button" onclick="closeAdminModal()"
              class="w-full text-gray-400 text-sm py-2">Cancelar</button>
      <p id="login-error" class="text-red-500 text-xs text-center hidden">Usu√°rio ou senha incorretos</p>
    </form>
  </div>
</div>

<!-- ==================== MODAL VISUALIZAR PEDIDO ==================== -->
<div id="modal-pedido" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="font-display text-2xl text-forest">Detalhes do Pedido</h2>
      <button onclick="closeModalPedido()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <div id="modal-pedido-content" class="space-y-4"></div>
    <div class="flex gap-3 pt-6">
      <button id="btn-wpp-cliente" onclick="abrirWhatsAppCliente()"
              class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition-all">
        üì± Abrir WhatsApp
      </button>
      <button onclick="closeModalPedido()"
              class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL MARMITA ==================== -->
<div id="modal-marmita" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-marmita-title">Novo Item</h2>
    <form onsubmit="salvarMarmita(event)" class="space-y-4">
      <input type="hidden" id="edit-marmita-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome *</label>
        <input id="marmita-nome" type="text" required
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo (R$) *</label>
          <input id="marmita-preco" type="number" step="0.01" required
                 class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
        <div>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Calorias (kcal) *</label>
          <input id="marmita-kcal" type="number" required
                 class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="block text-xs font-bold uppercase text-gray-400">Descri√ß√£o *</label>
          <button type="button" id="btn-gerar-ia" onclick="gerarDescricaoIA()" class="text-xs text-forest font-bold hover:underline">‚ú® Gerar IA</button>
        </div>
        <textarea id="marmita-desc" required
                  class="w-full px-4 py-2 border rounded-lg focus:outline-forest h-20"></textarea>
      </div>
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Categoria *</label>
        <select id="marmita-cat" required class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          <option value="marmita">üç± Marmita</option>
          <option value="sopa">üç≤ Sopa</option>
          <option value="suco">ü•§ Suco</option>
          <option value="sobremesa">üç∞ Sobremesa</option>
          <option value="proteico">üí™ Proteico</option>
          <option value="low-carb">ü•ó Low Carb</option>
          <option value="vegano">üå± Vegano</option>
          <option value="vegetal">ü•¶ Vegetal</option>
        </select>
      </div>

      <!-- VISIBILIDADE -->
      <div class="bg-sage/10 p-4 rounded-xl space-y-3">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="marmita-visivel" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üëÅÔ∏è Vis√≠vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar do card√°pio</p>
          </div>
        </label>
        <label class="flex items-center gap-3 cursor-pointer border-t border-sage/20 pt-3">
          <input type="checkbox" id="marmita-disponivel-combo" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üì¶ Dispon√≠vel para sele√ß√£o em Combos</p>
            <p class="text-xs text-gray-500">Desmarque para n√£o aparecer na escolha de itens do combo</p>
          </div>
        </label>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit"
                class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">
          Salvar
        </button>
        <button type="button" onclick="closeModalMarmita()"
                class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ==================== MODAL COMBO ==================== -->
<div id="modal-combo" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
    <h2 class="font-display text-2xl text-forest mb-6" id="modal-combo-title">Novo Combo</h2>
    <form onsubmit="salvarCombo(event)" class="space-y-4">
      <input type="hidden" id="edit-combo-id">
      <div>
        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Nome do Combo *</label>
        <input id="combo-nome" type="text" required placeholder="Ex: Kit 10 Marmitas"
               class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
      </div>

      <!-- TIPO -->
      <div class="bg-cream p-4 rounded-xl border-2 border-sage/20">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-3">Tipo de Combo *</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
            <input type="radio" name="tipo-combo" value="aberto" checked onchange="toggleTipoCombo()" class="mt-1">
            <div>
              <p class="font-bold text-forest">üõí Combo Aberto</p>
              <p class="text-xs text-gray-500">Cliente escolhe os itens</p>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border-2 border-sage/30 rounded-xl cursor-pointer hover:border-forest bg-white transition-all">
            <input type="radio" name="tipo-combo" value="fechado" onchange="toggleTipoCombo()" class="mt-1">
            <div>
              <p class="font-bold text-forest">üì¶ Combo Fechado</p>
              <p class="text-xs text-gray-500">Itens pr√©-definidos</p>
            </div>
          </label>
        </div>
      </div>

      <!-- CONFIG ABERTO -->
      <div id="config-aberto" class="space-y-4">
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Qtd Itens *</label>
            <input id="combo-qtd" type="number" min="1" required
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo (R$) *</label>
            <input id="combo-preco" type="number" step="0.01" required
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs font-bold uppercase text-gray-400 mb-1" title="Cliente escolhe de N em N">M√∫ltiplos</label>
            <input id="combo-lote" type="number" min="1" value="1" required
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>
        
        <div class="bg-white border-2 border-sage/20 rounded-xl p-4">
          <div class="flex justify-between items-center mb-2">
            <label class="block text-xs font-bold uppercase text-gray-400">Pratos Dispon√≠veis no Combo</label>
            <div class="flex gap-2">
              <button type="button" onclick="marcarPratosCombo(true)" class="text-xs text-forest font-bold hover:underline">Todos</button>
              <button type="button" onclick="marcarPratosCombo(false)" class="text-xs text-terracotta font-bold hover:underline">Nenhum</button>
            </div>
          </div>
          <div id="checklist-pratos-abertos" class="max-h-48 overflow-y-auto space-y-1 border-t border-sage/10 pt-2">
            <!-- Lista carregada via JS -->
          </div>
        </div>
      </div>

      <!-- CONFIG FECHADO -->
      <div id="config-fechado" class="hidden">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-3">Itens do Combo *</label>
        <div class="bg-white border-2 border-sage/20 rounded-xl p-4 max-h-72 overflow-y-auto"
             id="itens-combo-container"></div>
        <div class="mt-4">
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Pre√ßo do Combo (R$) *</label>
          <input id="combo-preco-fechado" type="number" step="0.01"
                 class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
        </div>
      </div>

      <!-- LIMITE DE VEGETAIS -->
      <div class="bg-green-50 border-2 border-green-100 p-4 rounded-xl">
        <label class="block text-xs font-bold uppercase text-gray-400 mb-2">ü•¶ Vegetais no Pedido</label>
        <p class="text-xs text-gray-500 mb-3">Quantos vegetais o cliente poder√° escolher ao montar este combo?</p>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade m√≠nima</label>
            <input id="combo-vegetal-min" type="number" min="0" value="0"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">Quantidade m√°xima</label>
            <input id="combo-vegetal-max" type="number" min="0" value="0"
                   placeholder="0 = sem vegetais"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-forest">
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">üí° Deixe m√°ximo em 0 para n√£o oferecer vegetais neste combo</p>
      </div>

      <div class="bg-sage/10 p-4 rounded-lg">
        <p class="text-xs text-gray-600">üí° <span id="preco-unitario-preview">Configure o combo acima</span></p>
      </div>

      <!-- VISIBILIDADE -->
      <div class="bg-sage/10 p-4 rounded-lg">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="combo-visivel" checked class="w-5 h-5 rounded">
          <div>
            <p class="font-bold text-sm text-forest">üëÅÔ∏è Vis√≠vel para Clientes</p>
            <p class="text-xs text-gray-500">Desmarque para ocultar este combo</p>
          </div>
        </label>
      </div>

      <div class="flex gap-3 pt-2">
        <button type="submit"
                class="flex-1 bg-forest text-white py-3 rounded-xl font-bold hover:bg-forest/90 transition-all">
          Salvar Combo
        </button>
        <button type="button" onclick="closeModalCombo()"
                class="flex-1 border border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
<!-- ==================== APP PRINCIPAL ==================== -->
<div id="main-app" class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-forest text-cream px-6 py-4 flex justify-between items-center sticky top-0 z-40 shadow-md">
    <div class="flex items-center gap-3">
      <img id="logo-empresa"
           src="https://raw.githubusercontent.com/Sabor-e-Saude/cardapio-pedidos/refs/heads/main/logo.png"
           alt="Logo Sabor e Sa√∫de"
           class="w-12 h-12 rounded-full object-cover border-2 border-sage/40">
      <div>
        <h1 class="font-display text-xl md:text-2xl">Sabor e Sa√∫de</h1>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-toggle-sidebar" onclick="toggleSidebar()"
              class="hidden text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all"
              title="Minimizar/expandir menu">
        ‚ò∞
      </button>
      <button id="btn-admin-view" onclick="openAdminModal()"
              class="text-xs border border-sage/30 px-3 py-2 rounded-lg hover:bg-white/10 transition-all">
        Acesso Admin
      </button>
      <button onclick="resetarPedido()"
              class="text-xs bg-terracotta/30 px-3 py-2 rounded-lg hover:bg-terracotta/50 transition-all">
        Resetar
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR ADMIN -->
    <aside id="sidebar" class="w-64 bg-white border-r hidden overflow-y-auto flex-shrink-0 transition-all">
      <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Gerenciamento</p>
      </div>
      <nav class="p-4 space-y-2">
        <button onclick="showPage('dashboard')"
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">
          üìä Dashboard
        </button>
        <button onclick="showPage('pedidos')"
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">
          üìã Pedidos
          <span id="badge-pedidos"
                class="ml-2 bg-terracotta text-white text-xs px-2 py-0.5 rounded-full hidden"></span>
        </button>
        <button onclick="showPage('combos')"
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">
          üì¶ Gerenciar Combos
        </button>
        <button onclick="showPage('marmitas')"
                class="w-full text-left px-4 py-3 rounded-lg hover:bg-sage/10 transition-all">
          üç± Gerenciar Card√°pio
        </button>
        <hr class="my-4">
        <button onclick="entrarComoCliente()"
                class="w-full text-left px-4 py-3 rounded-lg text-terracotta hover:bg-terracotta/5 transition-all">
          ‚¨ÖÔ∏è Ver como Cliente
        </button>
      </nav>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 pb-32">

      <!-- ===== P√ÅGINA CLIENTE: CARD√ÅPIO ===== -->
      <section id="page-cardapio" class="fade-in max-w-4xl mx-auto">
        <div class="mb-8">
          <h2 class="font-display text-3xl text-forest">Monte seu Kit üç±</h2>
          <p class="text-sage">Escolha um combo abaixo para come√ßar sua sele√ß√£o.</p>
        </div>

        <!-- GRID DE COMBOS -->
        <div id="combos-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-10"></div>

        <!-- SE√á√ÉO MARMITAS -->
        <div id="marmitas-section" class="hidden fade-in border-t border-sage/20 pt-8">

      <!-- BARRA DE PROGRESSO -->
      <div class="bg-forest text-white p-6 rounded-2xl mb-8 shadow-xl">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-xs opacity-70 uppercase font-bold">Progresso do Kit</p>
            <p class="text-lg font-bold" id="combo-name-display">Carregando...</p>
            <p class="text-xs opacity-70 mt-1" id="combo-tipo-badge"></p>
          </div>
          <div class="text-right" id="progress-counter">
            <p class="text-xs opacity-60 uppercase mb-1">üç± Marmitas</p>
            <div class="flex items-baseline gap-1">
              <span class="text-3xl font-display font-bold" id="current-marmitas">0</span>
              <span class="text-xl opacity-50">/</span>
              <span class="text-xl opacity-50" id="max-marmitas">10</span>
            </div>
          </div>
        </div>

        <!-- Barra de progresso visual -->
        <div id="progress-bar-container" class="mt-4">
          <div class="w-full bg-white/20 rounded-full h-2">
            <div id="progress-bar"
                class="bg-white h-2 rounded-full transition-all duration-300"
                style="width: 0%"></div>
          </div>
        </div>
      </div>


          <!-- COMBO FECHADO: ITENS INCLUSOS -->
          <div id="combo-fechado-itens"
               class="hidden mb-8 bg-white rounded-2xl p-6 shadow-sm border border-sage/20">
            <h3 class="text-xl font-bold text-forest mb-4">üì¶ Itens inclusos neste combo:</h3>
            <div id="lista-itens-fechado" class="space-y-2"></div>
          </div>

          <!-- COMBO ABERTO: SELE√á√ÉO -->
          <div id="selecao-marmitas-container">
            <!-- Assistente IA -->
            <div class="bg-forest/5 border border-forest/20 rounded-2xl p-4 mb-6">
              <h4 class="font-bold text-forest flex items-center gap-2 mb-2">‚ú® Assistente Fit IA</h4>
              <p class="text-sm text-gray-600 mb-3">Diga o seu objetivo (ex: Emagrecimento, mais prote√≠na) e a nossa Intelig√™ncia Artificial escolhe as refei√ß√µes ideais!</p>
              <div class="flex gap-2 flex-col sm:flex-row">
                <input type="text" id="ia-objetivo" placeholder="Ex: Quero ganhar massa muscular, sem peixe..." class="flex-1 px-4 py-2 rounded-xl border border-sage/30 focus:outline-forest text-sm bg-white">
                <button type="button" onclick="preencherComboComIA()" id="btn-ia-preencher" class="bg-forest text-white px-4 py-2 rounded-xl font-bold hover:bg-forest/90 transition-all text-sm whitespace-nowrap flex justify-center items-center">
                  ‚ú® Gerar Sele√ß√£o
                </button>
              </div>
            </div>

            <h3 class="text-xl font-bold text-forest mb-4">Selecione suas refei√ß√µes:</h3>
            <div id="marmitas-container" class="grid grid-cols-1 gap-3 mb-8"></div>
          </div>

<!-- ===== SELE√á√ÉO DE VEGETAIS ===== -->
<div id="secao-vegetais" class="hidden mb-8 fade-in scroll-mt-24">
  <div class="bg-white rounded-3xl p-6 shadow-sm border-2 border-green-100">

    <!-- Cabe√ßalho -->
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-display text-xl text-forest">ü•¶ Escolha seus Vegetais</h3>
      <div class="flex items-center gap-1 bg-green-50 px-3 py-1 rounded-full">
        <span class="text-sm font-bold text-green-700" id="vegetal-counter">0</span>
        <span class="text-sm text-gray-400" id="vegetal-counter-max"></span>
      </div>
    </div>

    <!-- Instru√ß√£o -->
    <div class="bg-green-50 rounded-xl px-4 py-3 mb-5">
      <p class="text-sm text-green-700 font-medium" id="vegetal-instrucao"></p>
      <p class="text-xs text-green-600 mt-1">
        üí° Os vegetais s√£o <strong>adicionais</strong> ao seu kit ‚Äî n√£o contam no limite de marmitas
      </p>
    </div>

    <!-- Grid de vegetais -->
    <div id="vegetais-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>

  </div>
</div>


          <!-- PREFER√äNCIAS E CHECKOUT -->
          <div id="secao-checkout" class="scroll-mt-24">
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-sage/20 mb-8">
              <h3 class="font-display text-2xl text-forest mb-6">Prefer√™ncias do Pedido</h3>
              <div class="mb-6">
                <label class="block text-xs font-bold uppercase text-gray-400 mb-2 ml-1">
                  Prefer√™ncia de Tempero
                </label>
                <div class="flex gap-2">
                  <button type="button" onclick="setSpiceLevel(1)"
                          class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">
                    üåø Suave
                  </button>
                  <button type="button" onclick="setSpiceLevel(2)"
                          class="spice-btn flex-1 py-3 border-2 border-forest bg-forest/5 rounded-xl font-bold">
                    üå∂Ô∏è M√©dio
                  </button>
                  <button type="button" onclick="setSpiceLevel(3)"
                          class="spice-btn flex-1 py-3 border border-sage/20 rounded-xl bg-white hover:border-forest transition-all">
                    üî• Picante
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">
                  Observa√ß√µes Adicionais
                </label>
                <textarea id="observations"
                          placeholder="Ex: Sem cebola, restri√ß√µes alimentares, prefer√™ncias especiais..."
                          class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest h-24"></textarea>
              </div>
            </div>

            <!-- DADOS PARA ENTREGA -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-sage/20 mb-8">
              <h3 class="font-display text-2xl text-forest mb-6">Dados para Entrega</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Seu Nome *</label>
                  <input id="cliente-nome" type="text" placeholder="Ex: Jo√£o Silva"
                         class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
                </div>
                <div>
                  <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">WhatsApp *</label>
                  <input id="cliente-tel" type="tel" placeholder="(00) 00000-0000"
                         class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="md:col-span-2">
                  <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">
                    Endere√ßo de Entrega *
                  </label>
                  <input id="cliente-endereco" type="text"
                         placeholder="Rua, n√∫mero, bairro e ponto de refer√™ncia"
                         class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
                </div>
                <div>
                  <label class="block text-xs font-bold uppercase text-gray-400 mb-1 ml-1">Cidade *</label>
                  <input id="cliente-cidade" type="text" placeholder="Ex: Blumenau"
                         class="w-full px-4 py-3 bg-cream/50 border border-sage/20 rounded-xl focus:outline-forest">
                </div>
              </div>
            </div>
          </div>

          <!-- BARRA FIXA DE FINALIZA√á√ÉO -->
          <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 md:p-6
                      flex flex-col md:flex-row justify-between items-center
                      shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50">
            <div class="text-center md:text-left mb-4 md:mb-0">
              <p class="text-xs text-gray-400 uppercase font-bold">Total do Kit</p>
              <p id="total-price" class="text-3xl font-display text-terracotta">R$ 0,00</p>
            </div>
            <button onclick="finalizarPedido()"
                    class="w-full md:w-auto bg-forest text-white px-12 py-4 rounded-2xl font-bold
                           shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2">
              üì± Enviar para WhatsApp
            </button>
          </div>

        </div>
      </section>

      <!-- ===== DASHBOARD ADMIN ===== -->
      <section id="page-dashboard" class="hidden">
        <h2 class="text-2xl font-bold mb-6 font-display text-forest">Painel Administrativo</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Combos</p>
            <p class="text-3xl font-bold text-forest" id="stat-combos">0</p>
            <p class="text-xs text-sage mt-1" id="stat-combos-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Itens no Card√°pio</p>
            <p class="text-3xl font-bold text-forest" id="stat-marmitas">0</p>
            <p class="text-xs text-sage mt-1" id="stat-marmitas-visiveis"></p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Total de Pedidos</p>
            <p class="text-3xl font-bold text-terracotta" id="stat-total-pedidos">0</p>
            <p class="text-xs text-sage mt-1">hist√≥rico completo</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-sm mb-1">Faturamento Total</p>
            <p class="text-3xl font-bold text-forest" id="stat-faturamento">R$ 0</p>
            <p class="text-xs text-sage mt-1">todos os pedidos</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20">
          <h3 class="font-bold text-lg mb-4">A√ß√µes R√°pidas</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="showPage('pedidos')"
                    class="border-2 border-terracotta text-terracotta px-4 py-3 rounded-xl font-bold
                           hover:bg-terracotta hover:text-white transition-all text-sm">
              üìã Ver Pedidos
            </button>
            <button onclick="exportarBancoDados()"
                    class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold
                           hover:bg-forest hover:text-white transition-all text-sm">
              ‚¨áÔ∏è Exportar Dados
            </button>
            <button onclick="showPage('combos')"
                    class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold
                           hover:bg-forest hover:text-white transition-all text-sm">
              üì¶ Combos
            </button>
            <button onclick="showPage('marmitas')"
                    class="border-2 border-forest text-forest px-4 py-3 rounded-xl font-bold
                           hover:bg-forest hover:text-white transition-all text-sm">
              üç± Card√°pio
            </button>
          </div>
        </div>
      </section>

      <!-- ===== P√ÅGINA PEDIDOS ===== -->
      <section id="page-pedidos" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold font-display text-forest">üìã Pedidos Recebidos</h2>
          <button onclick="exportarBancoDados()"
                  class="bg-forest text-white px-5 py-3 rounded-xl font-bold hover:scale-105 transition-all text-sm">
            ‚¨áÔ∏è Exportar Banco de Dados
          </button>
        </div>

        <!-- FILTRO POR DATA -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 mb-6">
          <p class="text-xs font-bold uppercase text-gray-400 mb-3">Filtrar por Per√≠odo</p>
          <div class="flex flex-col md:flex-row gap-3 items-end">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Data inicial</label>
              <input type="date" id="filtro-data-inicio"
                     class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Data final</label>
              <input type="date" id="filtro-data-fim"
                     class="w-full px-4 py-2 border border-sage/30 rounded-xl focus:outline-forest">
            </div>
            <button onclick="aplicarFiltroData()"
                    class="bg-forest text-white px-6 py-2 rounded-xl font-bold hover:bg-forest/90 transition-all whitespace-nowrap">
              Filtrar
            </button>
            <button onclick="limparFiltro()"
                    class="border border-gray-300 text-gray-500 px-6 py-2 rounded-xl font-bold hover:bg-gray-50 transition-all whitespace-nowrap">
              Ver Todos
            </button>
          </div>
        </div>

        <!-- CARDS FATURAMENTO -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Pedidos no Per√≠odo</p>
            <p class="text-3xl font-bold text-forest" id="periodo-qtd-pedidos">0</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Faturamento no Per√≠odo</p>
            <p class="text-2xl font-bold text-terracotta" id="periodo-faturamento">R$ 0,00</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Ticket M√©dio</p>
            <p class="text-2xl font-bold text-forest" id="periodo-ticket-medio">R$ 0,00</p>
          </div>
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20">
            <p class="text-gray-400 text-xs mb-1">Total de Itens</p>
            <p class="text-3xl font-bold text-forest" id="periodo-total-itens">0</p>
          </div>
        </div>

        <!-- TABELA DE PEDIDOS -->
        <div class="bg-white rounded-2xl shadow-sm border border-sage/20 mb-6 overflow-hidden">
          <div class="p-5 border-b border-sage/10 flex justify-between items-center">
            <p class="font-bold text-forest">Lista de Pedidos</p>
            <p class="text-xs text-gray-400" id="pedidos-periodo-label">Todos os pedidos</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-400 uppercase text-xs">
                <tr>
                  <th class="px-4 py-3 text-left">Data/Hora</th>
                  <th class="px-4 py-3 text-left">Cliente</th>
                  <th class="px-4 py-3 text-left">WhatsApp</th>
                  <th class="px-4 py-3 text-left">Cidade</th>
                  <th class="px-4 py-3 text-left">Combo</th>
                  <th class="px-4 py-3 text-right">Total</th>
                  <th class="px-4 py-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabela-pedidos" class="divide-y divide-gray-50"></tbody>
            </table>
          </div>
          <div id="pedidos-vazio" class="hidden p-12 text-center text-gray-400">
            <p class="text-4xl mb-3">üì≠</p>
            <p class="font-bold">Nenhum pedido encontrado</p>
            <p class="text-xs mt-1">Ajuste o per√≠odo ou aguarde novos pedidos</p>
          </div>
        </div>

        <!-- RANKINGS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10">
              <p class="font-bold text-forest">üì¶ Faturamento por Combo</p>
              <p class="text-xs text-gray-400 mt-1">Combos mais vendidos no per√≠odo</p>
            </div>
            <div id="ranking-combos" class="p-4 space-y-3"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-sage/20 overflow-hidden">
            <div class="p-5 border-b border-sage/10">
              <p class="font-bold text-forest">üç± Itens mais pedidos</p>
              <p class="text-xs text-gray-400 mt-1">Top 10 itens no per√≠odo</p>
            </div>
            <div id="ranking-itens" class="p-4 space-y-3"></div>
          </div>
        </div>
      </section>

      <!-- ===== GERENCIAR COMBOS ===== -->
      <section id="page-combos" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar Combos</h2>
          <button onclick="abrirModalCombo()"
                  class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all">
            + Novo Combo
          </button>
        </div>
        <div id="combos-admin-list" class="space-y-3"></div>
      </section>

      <!-- ===== GERENCIAR CARD√ÅPIO ===== -->
      <section id="page-marmitas" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold font-display text-forest">Gerenciar Card√°pio</h2>
          <button onclick="abrirModalMarmita()"
                  class="bg-forest text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all">
            + Novo Item
          </button>
        </div>
        <div id="marmitas-admin-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>

    </main>
  </div>
</div>

<!-- ==================== CUSTOM DIALOG (ALERT/CONFIRM) ==================== -->
<div id="custom-dialog" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-bg">
  <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl text-center">
    <p id="dialog-msg" class="text-gray-700 font-medium mb-6 text-sm"></p>
    <div class="flex gap-3 justify-center" id="dialog-btns"></div>
  </div>
</div>

<!-- ==================== TOAST ==================== -->
<div id="toast"
     class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-charcoal text-white
            px-8 py-4 rounded-2xl shadow-2xl z-[70] font-bold text-center max-w-sm">
</div>
<script>
  // ============================================================
  // FIREBASE CONFIG ‚Äî substitua pelos seus dados
  // ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyBL0z6PwA6Ik_U671G7HJZLsHT9udCT7YI",
  authDomain: "sabor-e-saude-a233e.firebaseapp.com",
  databaseURL: "https://sabor-e-saude-a233e-default-rtdb.firebaseio.com",
  projectId: "sabor-e-saude-a233e",
  storageBucket: "sabor-e-saude-a233e.firebasestorage.app",
  messagingSenderId: "283293618461",
  appId: "1:283293618461:web:1db0ad8b6db9f145d791f4",
  measurementId: "G-R6LW9FKEQF"
};

  const WHATSAPP_RESTAURANTE = "5547996988109";

  // ============================================================
  // INICIALIZA√á√ÉO FIREBASE
  // ============================================================
  let database;
  let firebaseInitialized = false;
  try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseInitialized = true;
  } catch(e) {
    console.warn("Firebase n√£o configurado. Usando localStorage.");
  }

  // ============================================================
  // ESTADO GLOBAL
  // ============================================================
  let isAdmin          = false;
  let sidebarVisible   = true;
  let currentCombo     = null;
  let quantities       = {};
  let vegetaisSelecionados = [];
  let spiceLevel       = 2;
  let maxMarmitas      = 0;
  let marmitasCache    = [];
  let combosCache      = [];
  let pedidosCache     = [];
  let pedidoAtualModal = null;

  const CAT_ICONS = {
    marmita:    'üç± Marmitas',
    sopa:       'üç≤ Sopas',
    suco:       'ü•§ Sucos',
    sobremesa:  'üç∞ Sobremesas',
    proteico:   'üí™ Proteicos',
    'low-carb': 'ü•ó Low Carb',
    vegano:     'üå± Veganos',
    vegetal:    'ü•¶ Vegetais'
  };

  const CAT_EMOJI = {
    marmita:'üç±', sopa:'üç≤', suco:'ü•§', sobremesa:'üç∞',
    proteico:'üí™', 'low-carb':'ü•ó', vegano:'üå±', vegetal:'ü•¶'
  };

  // ============================================================
  // UTILIT√ÅRIOS (TOAST E CUSTOM DIALOGS)
  // ============================================================
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3500);
  }

  function showCustomConfirm(msg, onConfirm) {
    const dialog = document.getElementById('custom-dialog');
    document.getElementById('dialog-msg').textContent = msg;
    document.getElementById('dialog-btns').innerHTML = `
      <button id="btn-dialog-cancel" class="flex-1 border border-gray-300 py-2 rounded-xl font-bold hover:bg-gray-50 transition-all text-sm">Cancelar</button>
      <button id="btn-dialog-ok" class="flex-1 bg-forest text-white py-2 rounded-xl font-bold hover:bg-forest/90 transition-all text-sm">Confirmar</button>
    `;
    dialog.classList.remove('hidden');

    document.getElementById('btn-dialog-cancel').onclick = () => dialog.classList.add('hidden');
    document.getElementById('btn-dialog-ok').onclick = () => {
      dialog.classList.add('hidden');
      onConfirm();
    };
  }

  function showCustomAlert(msg) {
    const dialog = document.getElementById('custom-dialog');
    document.getElementById('dialog-msg').innerHTML = msg.replace(/\n/g, '<br>');
    document.getElementById('dialog-btns').innerHTML = `
      <button id="btn-dialog-ok" class="w-full bg-forest text-white py-2 rounded-xl font-bold hover:bg-forest/90 transition-all text-sm">OK</button>
    `;
    dialog.classList.remove('hidden');
    document.getElementById('btn-dialog-ok').onclick = () => dialog.classList.add('hidden');
  }

  // ============================================================
  // GEMINI API CONFIG
  // ============================================================
  const GEMINI_API_KEY = ""; // ‚ö†Ô∏è COLOQUE SUA CHAVE DA API AQUI SE FOR PUBLICAR FORA DA PLATAFORMA (Ex: "AIzaSy...")
  const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

  async function callGemini(prompt, systemInstruction = "", jsonSchema = null) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
    };
    if (jsonSchema) {
      payload.generationConfig = { responseMimeType: "application/json", responseSchema: jsonSchema };
    }
    const delays = [1000, 2000, 4000, 8000, 16000];
    for (let i = 0; i < 5; i++) {
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        return jsonSchema ? JSON.parse(text) : text;
      } catch (e) {
        if (i === 4) { 
          showToast("‚ùå Erro IA: Verifique se inseriu a sua API Key no c√≥digo."); 
          console.error("Erro na IA: Faltou preencher a constante GEMINI_API_KEY ou a chave √© inv√°lida.", e); 
          return null; 
        }
        await new Promise(r => setTimeout(r, delays[i]));
      }
    }
  }

  // ============================================================
  // FIREBASE HELPERS - CORRIGIDOS (Aviso de Permiss√µes)
  // ============================================================
  async function fbGet(path) {
    if (!firebaseInitialized) return null;
    try {
      const snap = await database.ref(path).once('value');
      return snap.val();
    } catch (e) {
      console.error("üî• ERRO FIREBASE (Leitura): Permiss√£o negada! Libere as Regras do Realtime Database.", e);
      return null;
    }
  }
  
  async function fbSet(path, value) {
    if (!firebaseInitialized) return false;
    try {
      await database.ref(path).set(value);
      return true;
    } catch (e) {
      console.error("üî• ERRO FIREBASE (Grava√ß√£o): Permiss√£o negada! V√° no Console do Firebase > Realtime Database > Regras e altere .write para true.", e);
      showToast("‚ö†Ô∏è Firebase Bloqueado (Permiss√£o Negada). Salvando apenas localmente.");
      return false; 
    }
  }
  
  async function fbRemove(path) {
    if (!firebaseInitialized) return false;
    try {
      await database.ref(path).remove();
      return true;
    } catch (e) {
      console.error("üî• ERRO FIREBASE (Exclus√£o): Permiss√£o negada! Verifique as Regras.", e);
      return false;
    }
  }
  function lsGet(key)       { return JSON.parse(localStorage.getItem(key) || '[]'); }
  function lsSet(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

  // ============================================================
  // CRUD: MARMITAS
  // ============================================================
  async function getMarmitas() {
    if (!firebaseInitialized) return lsGet('marmitas_fit_data');
    const d = await fbGet('marmitas');
    return d ? Object.values(d) : [];
  }
  async function saveMarmita(m) {
    let success = false;
    if (firebaseInitialized) success = await fbSet(`marmitas/${m.id}`, m);
    if (!success) {
      let list = lsGet('marmitas_fit_data');
      const i  = list.findIndex(x => x.id === m.id);
      i !== -1 ? list[i] = m : list.push(m);
      lsSet('marmitas_fit_data', list);
    }
  }
  async function deleteMarmita(id) {
    let success = false;
    if (firebaseInitialized) success = await fbRemove(`marmitas/${id}`);
    if (!success) {
      lsSet('marmitas_fit_data', lsGet('marmitas_fit_data').filter(m => m.id !== id));
    }
  }

  // ============================================================
  // CRUD: COMBOS
  // ============================================================
  async function getCombos() {
    if (!firebaseInitialized) return lsGet('combos_fit_data');
    const d = await fbGet('combos');
    return d ? Object.values(d) : [];
  }
  async function saveCombo(c) {
    let success = false;
    if (firebaseInitialized) success = await fbSet(`combos/${c.id}`, c);
    if (!success) {
      let list = lsGet('combos_fit_data');
      const i  = list.findIndex(x => x.id === c.id);
      i !== -1 ? list[i] = c : list.push(c);
      lsSet('combos_fit_data', list);
    }
  }
  async function deleteCombo(id) {
    let success = false;
    if (firebaseInitialized) success = await fbRemove(`combos/${id}`);
    if (!success) {
      lsSet('combos_fit_data', lsGet('combos_fit_data').filter(c => c.id !== id));
    }
  }

  // ============================================================
  // CRUD: PEDIDOS
  // ============================================================
  async function getPedidos() {
    if (!firebaseInitialized) return lsGet('pedidos_fit_data');
    const d = await fbGet('pedidos');
    return d ? Object.values(d) : [];
  }
  async function savePedido(pedido) {
    let success = false;
    if (firebaseInitialized) success = await fbSet(`pedidos/${pedido.id}`, pedido);
    
    // Fallback de seguran√ßa se o Firebase falhar
    if (!success) {
      let list = lsGet('pedidos_fit_data');
      list.push(pedido);
      lsSet('pedidos_fit_data', list);
    }
    pedidosCache = await getPedidos();
  }
  async function excluirPedido(id) {
    showCustomConfirm('Excluir este pedido do banco de dados?', async () => {
      let success = false;
      if (firebaseInitialized) success = await fbRemove(`pedidos/${id}`);
      if (!success) {
        lsSet('pedidos_fit_data', lsGet('pedidos_fit_data').filter(p => p.id !== id));
      }
      pedidosCache = await getPedidos();
      showToast('‚úÖ Pedido exclu√≠do!');
      aplicarFiltroData();
      atualizarDashboard();
    });
  }

  // ============================================================
  // INICIALIZA√á√ÉO DO APP
  // ============================================================
  async function initData() {
    document.getElementById('loading').classList.remove('hidden');

    marmitasCache = await getMarmitas();
    combosCache   = await getCombos();
    pedidosCache  = await getPedidos();

    if (marmitasCache.length === 0) {
      const iniciais = [
        { id:1, nome:'Frango com Batata Doce',    preco:22.00, kcal:350, desc:'Frango grelhado e pur√™ de batata doce',    cat:'marmita', visivel:true, dispCombo:true },
        { id:2, nome:'Patinho com Arroz Integral', preco:25.00, kcal:400, desc:'Carne mo√≠da magra com legumes salteados', cat:'marmita', visivel:true, dispCombo:true },
        { id:3, nome:'Til√°pia com Ervas',          preco:28.00, kcal:300, desc:'Peixe assado com ervas e vagem',          cat:'marmita', visivel:true, dispCombo:true },
        { id:4, nome:'Strogonoff de Frango Fit',   preco:24.00, kcal:380, desc:'Com arroz integral e batata palha',       cat:'marmita', visivel:true, dispCombo:true },
        { id:5, nome:'Sopa de Legumes',            preco:15.00, kcal:180, desc:'Sopa cremosa com legumes frescos',        cat:'sopa',    visivel:true, dispCombo:true },
        { id:6, nome:'Suco Detox Verde',           preco:8.00,  kcal:80,  desc:'Couve, lim√£o e gengibre',                 cat:'suco',    visivel:true, dispCombo:false },
        { id:7, nome:'Br√≥colis',                   preco:0,     kcal:35,  desc:'Br√≥colis cozido no vapor',                cat:'vegetal', visivel:true, dispCombo:true },
        { id:8, nome:'Abobrinha',                  preco:0,     kcal:20,  desc:'Abobrinha grelhada',                      cat:'vegetal', visivel:true, dispCombo:true },
        { id:9, nome:'Cenoura',                    preco:0,     kcal:40,  desc:'Cenoura cozida',                          cat:'vegetal', visivel:true, dispCombo:true }
      ];
      for (const m of iniciais) await saveMarmita(m);
      marmitasCache = iniciais;
    }

    if (combosCache.length === 0) {
      const iniciais = [
        { id:1, nome:'Kit 10 Marmitas', qtd:10, preco_base:210.00, tipo:'aberto', visivel:true, itens:{}, vegetal_min:1, vegetal_max:3 },
        { id:2, nome:'Kit 20 Marmitas', qtd:20, preco_base:400.00, tipo:'aberto', visivel:true, itens:{}, vegetal_min:1, vegetal_max:3 }
      ];
      for (const c of iniciais) await saveCombo(c);
      combosCache = iniciais;
    }

    // Listeners tempo real Firebase
    if (firebaseInitialized) {
      database.ref('marmitas').on('value', snap => {
        const d = snap.val();
        marmitasCache = d ? Object.values(d) : [];
        renderCardapio();
        if (isAdmin) { renderMarmitasAdmin(); atualizarDashboard(); }
      });
      database.ref('combos').on('value', snap => {
        const d = snap.val();
        combosCache = d ? Object.values(d) : [];
        renderCardapio();
        if (isAdmin) { renderCombosAdmin(); atualizarDashboard(); }
      });
      database.ref('pedidos').on('value', snap => {
        const d = snap.val();
        pedidosCache = d ? Object.values(d) : [];
        atualizarBadgePedidos();
        if (isAdmin) atualizarDashboard();
      });
    }

    // Datas padr√£o filtro (m√™s atual)
    const hoje       = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    document.getElementById('filtro-data-inicio').value = primeiroDia.toISOString().split('T')[0];
    document.getElementById('filtro-data-fim').value    = hoje.toISOString().split('T')[0];

    renderCardapio();
    document.getElementById('loading').classList.add('hidden');
    if (!firebaseInitialized) showToast('‚ö†Ô∏è Modo offline ‚Äì configure o Firebase');
  }

  // ============================================================
  // NAVEGA√á√ÉO
  // ============================================================
  function showPage(pageId) {
    document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
    const p = document.getElementById(`page-${pageId}`);
    if (!p) return;
    p.classList.remove('hidden');
    if (pageId === 'dashboard') atualizarDashboard();
    if (pageId === 'combos')    renderCombosAdmin();
    if (pageId === 'marmitas')  renderMarmitasAdmin();
    if (pageId === 'pedidos')   aplicarFiltroData();
  }

  // ============================================================
  // SIDEBAR TOGGLE
  // ============================================================
  function toggleSidebar() {
    const sb  = document.getElementById('sidebar');
    const btn = document.getElementById('btn-toggle-sidebar');
    sidebarVisible = !sidebarVisible;
    if (sidebarVisible) {
      sb.classList.remove('hidden');
      btn.textContent = '‚ò∞';
      btn.title = 'Minimizar menu';
    } else {
      sb.classList.add('hidden');
      btn.textContent = '‚ò∞';
      btn.title = 'Expandir menu';
    }
  }

  // ============================================================
  // ADMIN: LOGIN
  // ============================================================
  function openAdminModal()  { document.getElementById('admin-modal').classList.remove('hidden'); }
  function closeAdminModal() {
    document.getElementById('admin-modal').classList.add('hidden');
    document.getElementById('login-error').classList.add('hidden');
  }

  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value;
    if (u === 'admin' && p === 'admin123') {
      isAdmin = true;
      closeAdminModal();
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('btn-toggle-sidebar').classList.remove('hidden');
      document.getElementById('btn-admin-view').classList.add('hidden');
      showPage('dashboard');
      atualizarBadgePedidos();
      showToast('‚úÖ Login realizado com sucesso!');
    } else {
      document.getElementById('login-error').classList.remove('hidden');
    }
  }

  function entrarComoCliente() {
    isAdmin = false;
    sidebarVisible = true;
    document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('btn-toggle-sidebar').classList.add('hidden');
    document.getElementById('btn-admin-view').classList.remove('hidden');
    showPage('cardapio');
  }

  function atualizarBadgePedidos() {
    const badge = document.getElementById('badge-pedidos');
    if (pedidosCache.length > 0) {
      badge.textContent = pedidosCache.length;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  // ============================================================
  // DASHBOARD
  // ============================================================
  function atualizarDashboard() {
    const mv  = marmitasCache.filter(m => m.visivel).length;
    const cv  = combosCache.filter(c => c.visivel !== false).length;
    const fat = pedidosCache.reduce((a, p) => a + (p.total || 0), 0);
    document.getElementById('stat-combos').textContent            = combosCache.length;
    document.getElementById('stat-combos-visiveis').textContent   = `${cv} vis√≠veis`;
    document.getElementById('stat-marmitas').textContent          = marmitasCache.length;
    document.getElementById('stat-marmitas-visiveis').textContent = `${mv} vis√≠veis`;
    document.getElementById('stat-total-pedidos').textContent     = pedidosCache.length;
    document.getElementById('stat-faturamento').textContent       = `R$ ${fat.toFixed(2)}`;
  }

  // ============================================================
  // CARD√ÅPIO CLIENTE
  // ============================================================
  function renderCardapio() {
    const visiveis = combosCache.filter(c => c.visivel !== false);
    const el = document.getElementById('combos-container');
    if (!visiveis.length) {
      el.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum combo dispon√≠vel.</p>';
      return;
    }
    el.innerHTML = visiveis.map(c => {
      const badge = c.tipo === 'fechado'
        ? '<span class="text-xs bg-terracotta/20 text-terracotta px-2 py-1 rounded-full font-bold">üì¶ Fechado</span>'
        : '<span class="text-xs bg-sage/20 text-sage px-2 py-1 rounded-full font-bold">üõí Aberto</span>';
      const info = c.tipo === 'fechado'
        ? `<p class="text-xs text-gray-400 mt-2">üí° Combo com itens pr√©-definidos</p>`
        : `<p class="text-xs text-gray-400 mt-2">üí° Cada item sai por <span class="font-bold text-sage">R$ ${(c.preco_base/c.qtd).toFixed(2)}</span></p>`;
      const vegInfo = (c.vegetal_max > 0)
        ? `<p class="text-xs text-green-600 mt-1">ü•¶ Inclui at√© ${c.vegetal_max} vegetal(is)</p>` : '';
      return `
        <button onclick="selecionarCombo(${c.id})"
                class="bg-white p-6 rounded-3xl border-2 border-transparent hover:border-forest shadow-sm text-left transition-all hover:-translate-y-1">
          <div class="flex justify-between items-start mb-2">
            <p class="text-forest font-bold text-xl">${c.nome}</p>
            ${badge}
          </div>
          <div class="mt-4">
            <span class="text-3xl font-display font-bold text-terracotta">R$ ${c.preco_base.toFixed(2)}</span>
          </div>
          ${info}${vegInfo}
        </button>`;
    }).join('');
  }

  function selecionarCombo(id) {
    currentCombo = combosCache.find(c => c.id === id);
    if (!currentCombo) { showToast('‚ùå Combo n√£o encontrado'); return; }

    maxMarmitas        = currentCombo.qtd;
    quantities         = {};
    vegetaisSelecionados = [];

    document.getElementById('marmitas-section').classList.remove('hidden');
    document.getElementById('combo-name-display').textContent = currentCombo.nome;
    document.getElementById('max-marmitas').textContent       = maxMarmitas;
    document.getElementById('current-marmitas').textContent   = '0';
    document.getElementById('combo-tipo-badge').textContent   =
      currentCombo.tipo === 'fechado' ? 'üì¶ Combo Fechado' : 'üõí Voc√™ escolhe os itens';

    if (currentCombo.tipo === 'fechado') {
      mostrarComboFechado();
      document.getElementById('selecao-marmitas-container').classList.add('hidden');
      document.getElementById('progress-counter').classList.add('hidden');
      
      // Auto-scroll para Combo Fechado
      if (currentCombo.vegetal_max > 0) {
         setTimeout(() => document.getElementById('secao-vegetais').scrollIntoView({behavior: 'smooth', block: 'start'}), 600);
      } else {
         setTimeout(() => document.getElementById('secao-checkout').scrollIntoView({behavior: 'smooth', block: 'start'}), 600);
      }
    } else {
      document.getElementById('combo-fechado-itens').classList.add('hidden');
      document.getElementById('selecao-marmitas-container').classList.remove('hidden');
      document.getElementById('progress-counter').classList.remove('hidden');
      renderMarmitas();
      
      const bar = document.getElementById('progress-bar');
      if (bar) bar.style.width = '0%';
    }

    renderVegetais();
    atualizarTotal();
    setTimeout(() => window.scrollTo({
      top: document.getElementById('marmitas-section').offsetTop - 100,
      behavior: 'smooth'
    }), 100);
  }

  // ============================================================
  // VEGETAIS
  // ============================================================
function renderVegetais() {
  const secao  = document.getElementById('secao-vegetais');
  const vegMax = currentCombo?.vegetal_max || 0;
  const vegMin = currentCombo?.vegetal_min || 0;

  if (!vegMax) { secao.classList.add('hidden'); return; }

  const vegetais = marmitasCache.filter(m => m.cat === 'vegetal' && m.visivel);
  if (!vegetais.length) { secao.classList.add('hidden'); return; }

  secao.classList.remove('hidden');

  document.getElementById('vegetal-counter').textContent     = '0';
  document.getElementById('vegetal-counter-max').textContent = ` / ${vegMax}`;
  document.getElementById('vegetal-instrucao').textContent   =
    vegMin > 0
      ? `Escolha de ${vegMin} a ${vegMax} vegetal(is) ‚Äî eles s√£o adicionais ao seu kit`
      : `Escolha at√© ${vegMax} vegetal(is) para acompanhar seu kit (opcional)`;

  const container = document.getElementById('vegetais-container');
  container.innerHTML = vegetais.map(v => `
    <button type="button"
            id="vegetal-btn-${v.id}"
            onclick="toggleVegetal(${v.id})"
            class="vegetal-btn flex items-center gap-2 px-4 py-3 border-2 border-sage/30
                   rounded-xl bg-white text-left text-sm font-medium hover:border-forest
                   transition-all w-full">
      <span class="text-xl">ü•¶</span>
      <div>
        <p class="font-medium">${v.nome}</p>
        <p class="text-xs text-gray-400">${v.kcal} kcal</p>
      </div>
    </button>`).join('');
}

  function toggleVegetal(id) {
    const vegMax = currentCombo?.vegetal_max || 0;
    const idx    = vegetaisSelecionados.indexOf(id);
    const btn    = document.getElementById(`vegetal-btn-${id}`);

    if (idx === -1) {
      if (vegetaisSelecionados.length >= vegMax) {
        showToast(`‚ö†Ô∏è M√°ximo de ${vegMax} vegetal(is) para este combo`);
        return;
      }
      vegetaisSelecionados.push(id);
      btn.classList.add('selected');
      
      // Auto-scroll
      if (vegetaisSelecionados.length === vegMax) {
        setTimeout(() => {
          showToast('‚úÖ Vegetais selecionados! Finalize o pedido.');
          document.getElementById('secao-checkout').scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 500);
      }
    } else {
      vegetaisSelecionados.splice(idx, 1);
      btn.classList.remove('selected');
    }
    document.getElementById('vegetal-counter').textContent = vegetaisSelecionados.length;
  }

function mostrarComboFechado() {
  const el = document.getElementById('lista-itens-fechado');
  if (!el) return;
  el.innerHTML = '';
}

function toggleDescItem(btn) {
  const desc = btn.nextElementSibling;
  const arrow = btn.querySelector('span:last-child');
  const aberto = !desc.classList.contains('hidden');
  desc.classList.toggle('hidden', aberto);
  arrow.textContent = aberto ? '‚ñº' : '‚ñ≤';
}

function renderMarmitas() {
  const lote = currentCombo?.lote_selecao || 1;

  // Itens principais: vis√≠veis, dispon√≠veis em combo, SEM vegetais, e filtrados pelo combo atual
  const disponiveis = marmitasCache.filter(m => {
    if (!m.visivel || m.cat === 'vegetal' || m.dispCombo === false) return false;
    if (currentCombo?.itens_disponiveis && currentCombo.itens_disponiveis.length > 0) {
      return currentCombo.itens_disponiveis.includes(m.id);
    }
    return true; // Fallback se for combo antigo sem configura√ß√£o
  });

  const el = document.getElementById('marmitas-container');
  if (!disponiveis.length) {
    el.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum item dispon√≠vel.</p>';
    return;
  }

  // Agrupar por categoria
  const porCat = {};
  disponiveis.forEach(m => {
    if (!porCat[m.cat]) porCat[m.cat] = [];
    porCat[m.cat].push(m);
  });

  el.innerHTML = Object.keys(porCat).map(cat => `
    <div class="mb-6">
      <p class="text-xs font-bold uppercase text-gray-400 mb-3 ml-1">${CAT_ICONS[cat] || 'üç¥ Outros'}</p>
      ${porCat[cat].map(m => `
        <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-100 hover:border-sage/50 transition-all mb-2">
          <div class="flex-1 pr-4">
            <p class="font-bold text-forest">${CAT_EMOJI[m.cat]||'üç¥'} ${m.nome}</p>
            <p class="text-xs text-gray-400 leading-tight mt-1">${m.desc} ‚Ä¢ ${m.kcal} kcal</p>
          </div>
          <div class="flex items-center gap-3 bg-cream p-1 rounded-xl">
            <button type="button" onclick="updateQty(${m.id},-1)"
                    class="w-8 h-8 rounded-lg bg-white shadow-sm font-bold text-sm hover:bg-red-50 transition-all">‚àí${lote}</button>
            <span id="qty-${m.id}" class="font-bold w-6 text-center">0</span>
            <button type="button" onclick="updateQty(${m.id},1)"
                    class="w-8 h-8 rounded-lg bg-forest text-white shadow-sm font-bold text-sm hover:bg-forest/80 transition-all">+${lote}</button>
          </div>
        </div>`).join('')}
    </div>`).join('');
  }

function updateQty(id, delta) {
  const lote = currentCombo?.lote_selecao || 1;
  const total = Object.values(quantities).reduce((a,b) => a+b, 0);
  
  if (delta > 0 && total + lote > maxMarmitas) {
    showToast(`‚ö†Ô∏è Kit completo! M√°ximo de ${maxMarmitas} marmitas`);
    return;
  }
  
  const atual = quantities[id] || 0;
  let novoValor = atual + (delta * lote);
  if (novoValor < 0) novoValor = 0;
  
  quantities[id] = novoValor;
  const el = document.getElementById(`qty-${id}`);
  if (el) el.textContent = quantities[id];

  const novoTotal = Object.values(quantities).reduce((a,b) => a+b, 0);
  document.getElementById('current-marmitas').textContent = novoTotal;

  // Atualizar barra de progresso
  const pct = Math.min(100, Math.round((novoTotal / maxMarmitas) * 100));
  const bar  = document.getElementById('progress-bar');
  if (bar) bar.style.width = pct + '%';

  // Toast quando completar e redirecionamento (Auto-scroll)
  if (novoTotal === maxMarmitas) {
    showToast('üéâ Kit completo!');
    
    const vegMax = currentCombo?.vegetal_max || 0;
    if (vegMax > 0) {
      setTimeout(() => {
        showToast('ü•¶ Agora escolha seus vegetais!');
        document.getElementById('secao-vegetais').scrollIntoView({behavior: 'smooth', block: 'start'});
      }, 700);
    } else {
      setTimeout(() => {
        document.getElementById('secao-checkout').scrollIntoView({behavior: 'smooth', block: 'start'});
      }, 700);
    }
  }

  atualizarTotal();
}

  function atualizarTotal() {
    if (currentCombo)
      document.getElementById('total-price').textContent = `R$ ${currentCombo.preco_base.toFixed(2)}`;
  }

  function setSpiceLevel(l) {
    spiceLevel = l;
    document.querySelectorAll('.spice-btn').forEach((btn, i) => {
      const active = i === l - 1;
      btn.classList.toggle('border-2',       active);
      btn.classList.toggle('border-forest',  active);
      btn.classList.toggle('bg-forest/5',    active);
      btn.classList.toggle('font-bold',      active);
      btn.classList.toggle('border-sage/20', !active);
      btn.classList.toggle('bg-white',       !active);
    });
  }

  // ============================================================
  // FINALIZAR PEDIDO (Bot√£o WhatsApp Corrigido)
  // ============================================================
  function finalizarPedido() {
    const nome     = document.getElementById('cliente-nome').value.trim();
    const tel      = document.getElementById('cliente-tel').value.trim();
    const endereco = document.getElementById('cliente-endereco').value.trim();
    const cidade   = document.getElementById('cliente-cidade').value.trim();
    const obs      = document.getElementById('observations').value.trim();

    if (!nome || !tel || !endereco || !cidade) {
      showToast('‚ùå Preencha nome, telefone, endere√ßo e cidade');
      return;
    }

    // Validar m√≠nimo de vegetais
    const vegMin = currentCombo?.vegetal_min || 0;
    if (vegMin > 0 && vegetaisSelecionados.length < vegMin) {
      showToast(`‚ö†Ô∏è Selecione pelo menos ${vegMin} vegetal(is)`);
      return;
    }

    if (currentCombo.tipo === 'fechado') {
      registrarEEnviar(nome, tel, endereco, cidade, obs, true);
    } else {
      const total = Object.values(quantities).reduce((a,b) => a+b, 0);
      if (total === 0) { showToast('‚ö†Ô∏è Selecione pelo menos um item!'); return; }
      
      // Corrigido: Usando o custom confirm em vez do nativo
      if (total < maxMarmitas) {
        showCustomConfirm(`Faltam ${maxMarmitas - total} itens para completar. Continuar mesmo assim?`, () => {
          registrarEEnviar(nome, tel, endereco, cidade, obs, false);
        });
        return;
      }
      
      registrarEEnviar(nome, tel, endereco, cidade, obs, false);
    }
  }

  async function registrarEEnviar(nome, tel, endereco, cidade, obs, isFechado) {
    const temperos = ['üåø Suave','üå∂Ô∏è M√©dio','üî• Picante'];

    const itens_detalhes = {};
    let   listaWpp       = '';
    let   totalItens     = 0;

    if (isFechado) {
      const porCat = {};
      Object.entries(currentCombo.itens || {}).forEach(([itemId, qtd]) => {
        const m = marmitasCache.find(x => x.id === parseInt(itemId));
        if (m && qtd > 0) {
          itens_detalhes[m.nome] = (itens_detalhes[m.nome] || 0) + qtd;
          totalItens += qtd;
          if (!porCat[m.cat]) porCat[m.cat] = [];
          porCat[m.cat].push({...m, quantidade: qtd});
        }
      });
      Object.keys(porCat).forEach(cat => {
        listaWpp += `\n*${CAT_ICONS[cat]||'Outros'}:*\n`;
        porCat[cat].forEach(item => { listaWpp += `‚Ä¢ ${item.quantidade}x ${item.nome}\n`; });
      });
    } else {
      Object.entries(quantities).forEach(([id, qtd]) => {
        if (qtd > 0) {
          const m = marmitasCache.find(x => x.id == id);
          if (m) {
            itens_detalhes[m.nome] = (itens_detalhes[m.nome] || 0) + qtd;
            listaWpp += `‚Ä¢ *${qtd}x* ${m.nome}\n`;
            totalItens += qtd;
          }
        }
      });
    }

    // Vegetais selecionados
    const nomesVegetais = vegetaisSelecionados.map(vid => {
      const v = marmitasCache.find(x => x.id === vid);
      return v ? v.nome : '';
    }).filter(Boolean);

    let listaVegetaisWpp = '';
    if (nomesVegetais.length) {
      listaVegetaisWpp = `\n*ü•¶ Vegetais:*\n${nomesVegetais.map(v => `‚Ä¢ ${v}`).join('\n')}\n`;
      nomesVegetais.forEach(v => {
        itens_detalhes[`[Vegetal] ${v}`] = (itens_detalhes[`[Vegetal] ${v}`] || 0) + 1;
      });
    }

    const pedidoId = 'pedido_' + Date.now();
    const pedido   = {
      id:               pedidoId,
      timestamp:        new Date().toISOString(),
      cliente_nome:     nome,
      cliente_tel:      tel,
      cliente_endereco: endereco,
      cliente_cidade:   cidade,
      observacoes:      obs,
      combo_id:         currentCombo.id,
      combo_nome:       currentCombo.nome,
      combo_tipo:       currentCombo.tipo,
      tempero:          temperos[spiceLevel - 1],
      vegetais:         nomesVegetais,
      itens_detalhes,
      qtd_itens:        totalItens,
      total:            currentCombo.preco_base
    };

    // A opera√ß√£o de salvar n√£o bloquear√° o c√≥digo agora
    await savePedido(pedido);
    atualizarBadgePedidos();

    const tipo = isFechado ? 'üì¶ COMBO FECHADO' : 'üõí PERSONALIZADO';
    const msg  = encodeURIComponent(
      `*üç± NOVO PEDIDO ‚Äì SABOR E SA√öDE*\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
      `*CLIENTE:* ${nome}\n` +
      `*TEL:* ${tel}\n` +
      `*KIT:* ${currentCombo.nome} (${tipo})\n` +
      `*TEMPERO:* ${temperos[spiceLevel-1]}\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
      `*ITENS DO PEDIDO:*\n${listaWpp}${listaVegetaisWpp}\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
      `*ENDERE√áO:* ${endereco}, ${cidade}\n` +
      `*OBS:* ${obs || 'Nenhuma'}\n` +
      `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
      `*üí∞ TOTAL:* R$ ${currentCombo.preco_base.toFixed(2)}`
    );

    showToast('‚úÖ Pedido salvo! Abrindo WhatsApp...');
    
    // Abrir o WhatsApp sem setTimeout para n√£o ser bloqueado pelos navegadores
    const url = `https://wa.me/${WHATSAPP_RESTAURANTE}?text=${msg}`;
    window.open(url, '_blank');
    
    // Limpa a tela
    resetarAposEnvio();
  }

  function resetarAposEnvio() {
    currentCombo         = null;
    quantities           = {};
    vegetaisSelecionados = [];
    spiceLevel           = 2;
    document.getElementById('marmitas-section').classList.add('hidden');
    document.getElementById('secao-vegetais').classList.add('hidden');
    ['cliente-nome','cliente-tel','cliente-endereco','cliente-cidade','observations']
      .forEach(id => { document.getElementById(id).value = ''; });
    setSpiceLevel(2);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Corrigido: Usando o custom confirm em vez do nativo que crashava
  function resetarPedido() {
    showCustomConfirm('Deseja realmente limpar seu pedido atual?', () => {
      resetarAposEnvio();
      showToast('üîÑ Pedido resetado!');
    });
  }

  // ============================================================
  // PEDIDOS: FILTRO E RENDERIZA√á√ÉO
  // ============================================================
  function aplicarFiltroData() {
    const inicio = document.getElementById('filtro-data-inicio').value;
    const fim    = document.getElementById('filtro-data-fim').value;
    let filtrados = [...pedidosCache];

    if (inicio && fim) {
      const dtInicio = new Date(inicio + 'T00:00:00');
      const dtFim    = new Date(fim    + 'T23:59:59');
      filtrados = filtrados.filter(p => {
        const dt = new Date(p.timestamp);
        return dt >= dtInicio && dt <= dtFim;
      });
      document.getElementById('pedidos-periodo-label').textContent =
        `${formatarData(inicio)} at√© ${formatarData(fim)}`;
    } else {
      document.getElementById('pedidos-periodo-label').textContent = 'Todos os pedidos';
    }

    renderPedidos(filtrados);
    renderFaturamentoPorCombo(filtrados);
    renderFaturamentoPorItem(filtrados);
    atualizarCardsFaturamento(filtrados);
  }

  function limparFiltro() {
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value    = '';
    aplicarFiltroData();
  }

  function atualizarCardsFaturamento(lista) {
    const total      = lista.reduce((a, p) => a + (p.total || 0), 0);
    const totalItens = lista.reduce((a, p) => a + (p.qtd_itens || 0), 0);
    const ticket     = lista.length ? total / lista.length : 0;
    document.getElementById('periodo-qtd-pedidos').textContent  = lista.length;
    document.getElementById('periodo-faturamento').textContent  = `R$ ${total.toFixed(2)}`;
    document.getElementById('periodo-ticket-medio').textContent = `R$ ${ticket.toFixed(2)}`;
    document.getElementById('periodo-total-itens').textContent  = totalItens;
  }

  function renderPedidos(lista) {
    const tbody    = document.getElementById('tabela-pedidos');
    const vazio    = document.getElementById('pedidos-vazio');
    const ordenados = [...lista].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

    if (!ordenados.length) {
      tbody.innerHTML = '';
      vazio.classList.remove('hidden');
      return;
    }
    vazio.classList.add('hidden');

    tbody.innerHTML = ordenados.map(p => {
      const dt  = new Date(p.timestamp);
      const tel = p.cliente_tel ? p.cliente_tel.replace(/\D/g,'') : '';
      const btnWpp = tel
        ? `<button onclick="abrirWhatsAppCliente('${tel}','${p.cliente_nome}')"
                   class="text-green-600 hover:text-green-800 font-bold" title="WhatsApp">üì±</button>`
        : `<span class="text-gray-300" title="Sem telefone">üìµ</span>`;
      return `
        <tr class="table-row border-b border-gray-50">
          <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
            ${dt.toLocaleDateString('pt-BR')}<br>
            <span class="text-gray-400">${dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
          </td>
          <td class="px-4 py-3 font-medium">${p.cliente_nome}</td>
          <td class="px-4 py-3 text-xs text-gray-500">${p.cliente_tel || '‚Äî'}</td>
          <td class="px-4 py-3 text-xs text-gray-500">${p.cliente_cidade || '‚Äî'}</td>
          <td class="px-4 py-3 text-xs">
            <span class="bg-sage/10 text-forest px-2 py-1 rounded-full font-bold">${p.combo_nome}</span>
          </td>
          <td class="px-4 py-3 text-right font-bold text-terracotta whitespace-nowrap">
            R$ ${(p.total||0).toFixed(2)}
          </td>
          <td class="px-4 py-3 text-center">
            <div class="flex items-center justify-center gap-2">
              ${btnWpp}
              <button onclick="verPedido('${p.id}')"
                      class="text-blue-500 hover:text-blue-700 font-bold" title="Ver detalhes">üîç</button>
              <button onclick="excluirPedido('${p.id}')"
                      class="text-red-400 hover:text-red-600 font-bold" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  function renderFaturamentoPorCombo(lista) {
    const el   = document.getElementById('ranking-combos');
    const mapa = {};
    lista.forEach(p => {
      const k = p.combo_nome || 'Desconhecido';
      if (!mapa[k]) mapa[k] = { qtd: 0, total: 0 };
      mapa[k].qtd++;
      mapa[k].total += p.total || 0;
    });
    const ranking = Object.entries(mapa).sort((a,b) => b[1].total - a[1].total);
    if (!ranking.length) {
      el.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Sem dados no per√≠odo</p>';
      return;
    }
    const maxVal = ranking[0][1].total || 1;
    el.innerHTML = ranking.map(([nome, dados]) => {
      const pct = Math.round((dados.total / maxVal) * 100);
      return `
        <div>
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm font-bold text-forest truncate max-w-[60%]">${nome}</span>
            <div class="text-right">
              <span class="text-sm font-bold text-terracotta">R$ ${dados.total.toFixed(2)}</span>
              <span class="text-xs text-gray-400 ml-2">${dados.qtd} pedido${dados.qtd>1?'s':''}</span>
            </div>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2">
            <div class="bg-terracotta h-2 rounded-full" style="width:${pct}%"></div>
          </div>
        </div>`;
    }).join('');
  }

  function renderFaturamentoPorItem(lista) {
    const el   = document.getElementById('ranking-itens');
    const mapa = {};
    lista.forEach(p => {
      Object.entries(p.itens_detalhes || {}).forEach(([nome, qtd]) => {
        if (!mapa[nome]) mapa[nome] = 0;
        mapa[nome] += qtd;
      });
    });
    const ranking = Object.entries(mapa).sort((a,b) => b[1]-a[1]).slice(0,10);
    if (!ranking.length) {
      el.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Sem dados no per√≠odo</p>';
      return;
    }
    const maxQtd = ranking[0][1] || 1;
    el.innerHTML = ranking.map(([nome, qtd]) => {
      const pct = Math.round((qtd / maxQtd) * 100);
      return `
        <div>
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm font-bold text-forest truncate max-w-[70%]">${nome}</span>
            <span class="text-sm font-bold text-sage">${qtd}x</span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2">
            <div class="bg-sage h-2 rounded-full" style="width:${pct}%"></div>
          </div>
        </div>`;
    }).join('');
  }

  // ============================================================
  // MODAL VISUALIZAR PEDIDO
  // ============================================================
  function verPedido(id) {
    pedidoAtualModal = pedidosCache.find(p => p.id === id);
    if (!pedidoAtualModal) return;
    const p  = pedidoAtualModal;
    const dt = new Date(p.timestamp);
    const tel = p.cliente_tel ? p.cliente_tel.replace(/\D/g,'') : '';
    document.getElementById('btn-wpp-cliente').style.display = tel ? '' : 'none';

    const itensHtml = Object.entries(p.itens_detalhes || {}).map(([nome, qtd]) =>
      `<li class="flex justify-between text-sm py-1 border-b border-gray-50">
         <span>${nome}</span>
         <span class="font-bold text-forest">${qtd}x</span>
       </li>`
    ).join('');

    const vegetaisHtml = (p.vegetais && p.vegetais.length)
      ? `<div class="bg-green-50 border border-green-100 rounded-xl p-4">
           <p class="text-xs text-gray-400 uppercase font-bold mb-2">ü•¶ Vegetais Selecionados</p>
           <p class="text-sm font-medium text-green-700">${p.vegetais.join(', ')}</p>
         </div>` : '';

    document.getElementById('modal-pedido-content').innerHTML = `
      <div class="bg-cream rounded-xl p-4 space-y-2">
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Data/Hora</span>
          <span class="text-sm font-bold">${dt.toLocaleDateString('pt-BR')} ${dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Cliente</span>
          <span class="text-sm font-bold">${p.cliente_nome}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">WhatsApp</span>
          <span class="text-sm">${p.cliente_tel || '‚Äî'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Endere√ßo</span>
          <span class="text-sm text-right max-w-[60%]">${p.cliente_endereco || '‚Äî'}, ${p.cliente_cidade || ''}</span>
        </div>
      </div>
      <div class="bg-cream rounded-xl p-4 space-y-2">
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Combo</span>
          <span class="text-sm font-bold text-forest">${p.combo_nome}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Tipo</span>
          <span class="text-sm">${p.combo_tipo === 'fechado' ? 'üì¶ Fechado' : 'üõí Aberto'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Tempero</span>
          <span class="text-sm">${p.tempero || '‚Äî'}</span>
        </div>
        ${p.observacoes ? `
        <div class="flex justify-between">
          <span class="text-xs text-gray-400 uppercase font-bold">Obs</span>
          <span class="text-sm text-right max-w-[60%]">${p.observacoes}</span>
        </div>` : ''}
      </div>
      ${vegetaisHtml}
      <div class="bg-white border border-sage/20 rounded-xl p-4">
        <p class="text-xs text-gray-400 uppercase font-bold mb-3">Itens do Pedido</p>
        <ul class="space-y-1">${itensHtml || '<li class="text-sm text-gray-400">Combo fechado</li>'}</ul>
      </div>
      <div class="flex justify-between items-center bg-forest text-white rounded-xl p-4">
        <span class="font-bold uppercase text-sm">Total do Pedido</span>
        <span class="text-2xl font-display font-bold">R$ ${(p.total||0).toFixed(2)}</span>
      </div>`;

    document.getElementById('modal-pedido').classList.remove('hidden');
  }

  function closeModalPedido() {
    document.getElementById('modal-pedido').classList.add('hidden');
    pedidoAtualModal = null;
  }

  function abrirWhatsAppCliente(tel, nome) {
    let numero = tel, nomeCliente = nome;
    if (!tel && pedidoAtualModal) {
      numero      = pedidoAtualModal.cliente_tel.replace(/\D/g,'');
      nomeCliente = pedidoAtualModal.cliente_nome;
    }
    if (!numero) { showToast('‚ùå Cliente sem n√∫mero cadastrado'); return; }
    if (!numero.startsWith('55')) numero = '55' + numero;
    const msg = encodeURIComponent(`Ol√° ${nomeCliente}! üòä Aqui √© do *Sabor e Sa√∫de*. Tudo bem?`);
    window.open(`https://wa.me/${numero}?text=${msg}`, '_blank');
  }

  // ============================================================
  // EXPORTAR BANCO DE DADOS
  // ============================================================
  async function exportarBancoDados() {
    showToast('‚è≥ Preparando exporta√ß√£o...');
    const marmitas = await getMarmitas();
    const combos   = await getCombos();
    const pedidos  = await getPedidos();

    const jsonCompleto = { exportado_em: new Date().toLocaleString('pt-BR'), marmitas, combos, pedidos };
    const blobJson  = new Blob([JSON.stringify(jsonCompleto, null, 2)], { type: 'application/json' });
    const linkJson  = document.createElement('a');
    linkJson.href   = URL.createObjectURL(blobJson);
    linkJson.download = `saboresaude_backup_${dataHoje()}.json`;
    linkJson.click();

    if (pedidos.length) {
      const cab   = ['ID','Data','Hora','Cliente','WhatsApp','Endere√ßo','Cidade','Combo','Tipo','Tempero','Vegetais','Total (R$)','Qtd Itens','Itens','Observa√ß√µes'];
      const linhas = pedidos
        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))
        .map(p => {
          const dt    = new Date(p.timestamp);
          const itens = Object.entries(p.itens_detalhes || {}).map(([n,q]) => `${q}x ${n}`).join(' | ');
          return [
            p.id,
            dt.toLocaleDateString('pt-BR'),
            dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}),
            p.cliente_nome,
            p.cliente_tel || '',
            (p.cliente_endereco || '').replace(/\n/g,' '),
            p.cliente_cidade || '',
            p.combo_nome,
            p.combo_tipo === 'fechado' ? 'Fechado' : 'Aberto',
            p.tempero || '',
            (p.vegetais || []).join(' | '),
            (p.total || 0).toFixed(2),
            p.qtd_itens || 0,
            itens,
            (p.observacoes || '').replace(/\n/g,' ')
          ].map(v => `"${v}"`).join(',');
        });
      const csvContent = '\uFEFF' + [cab.join(','), ...linhas].join('\n');
      const blobCsv    = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const linkCsv    = document.createElement('a');
      linkCsv.href     = URL.createObjectURL(blobCsv);
      linkCsv.download = `saboresaude_pedidos_${dataHoje()}.csv`;
      setTimeout(() => linkCsv.click(), 500);
    }
    setTimeout(() => showToast('‚úÖ Arquivos exportados!'), 800);
  }

  function dataHoje()        { return new Date().toISOString().split('T')[0]; }
  function formatarData(str) { if (!str) return ''; const [y,m,d]=str.split('-'); return `${d}/${m}/${y}`; }

  // ============================================================
  // ADMIN: MARMITAS
  // ============================================================
  function renderMarmitasAdmin() {
    const el = document.getElementById('marmitas-admin-list');
    if (!marmitasCache.length) {
      el.innerHTML = '<p class="text-gray-400 text-center py-8 col-span-full">Nenhum item cadastrado.</p>';
      return;
    }
    el.innerHTML = marmitasCache.map(m => {
      const vBadge    = m.visivel
        ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">üëÅÔ∏è Vis√≠vel</span>'
        : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">üëª Oculto</span>';
      const cBadge    = m.dispCombo !== false
        ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">üì¶ No combo</span>'
        : '<span class="text-xs bg-orange-100 text-orange-500 px-2 py-1 rounded-full">üö´ Fora do combo</span>';
      const btnToggle = m.visivel
        ? `<button onclick="toggleMarmita(${m.id},false)"
                   class="text-xs bg-yellow-50 text-yellow-700 px-3 py-2 rounded-lg font-bold hover:bg-yellow-100 transition-all">
             üëª Ocultar</button>`
        : `<button onclick="toggleMarmita(${m.id},true)"
                   class="text-xs bg-green-50 text-green-700 px-3 py-2 rounded-lg font-bold hover:bg-green-100 transition-all">
             üëÅÔ∏è Exibir</button>`;
      return `
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-sage/20 ${!m.visivel?'opacity-60':''}">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <h3 class="font-bold text-lg text-forest">${m.nome}</h3>
              <div class="flex gap-2 mt-2 flex-wrap">
                <span class="text-xs text-gray-400 uppercase bg-gray-50 px-2 py-1 rounded">${m.cat}</span>
                ${vBadge} ${cBadge}
              </div>
            </div>
            <span class="text-2xl font-bold text-terracotta ml-4">R$ ${m.preco.toFixed(2)}</span>
          </div>
          <p class="text-sm text-gray-600 mb-3">${m.desc}</p>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <span class="text-xs bg-sage/10 px-3 py-1 rounded-full font-bold text-sage">${m.kcal} kcal</span>
            <div class="flex gap-2 flex-wrap">
              ${btnToggle}
              <button onclick="editarMarmita(${m.id})"
                      class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold hover:bg-blue-100 transition-all">
                ‚úèÔ∏è Editar</button>
              <button onclick="excluirMarmitaAdmin(${m.id})"
                      class="text-xs bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold hover:bg-red-100 transition-all">
                üóëÔ∏è Excluir</button>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  async function toggleMarmita(id, estado) {
    const m = marmitasCache.find(x => x.id === id);
    if (!m) return;
    m.visivel = estado;
    await saveMarmita(m);
    showToast(`‚úÖ Item ${estado ? 'vis√≠vel' : 'oculto'}!`);
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }

  function abrirModalMarmita(id = null) {
    document.getElementById('modal-marmita-title').textContent = id ? 'Editar Item' : 'Novo Item';
    document.getElementById('edit-marmita-id').value = id || '';
    if (id) {
      const m = marmitasCache.find(x => x.id === id);
      if (m) {
        document.getElementById('marmita-nome').value             = m.nome;
        document.getElementById('marmita-preco').value            = m.preco;
        document.getElementById('marmita-kcal').value             = m.kcal;
        document.getElementById('marmita-desc').value             = m.desc;
        document.getElementById('marmita-cat').value              = m.cat;
        document.getElementById('marmita-visivel').checked        = m.visivel !== false;
        document.getElementById('marmita-disponivel-combo').checked = m.dispCombo !== false;
      }
    } else {
      ['marmita-nome','marmita-preco','marmita-kcal','marmita-desc'].forEach(f => {
        document.getElementById(f).value = '';
      });
      document.getElementById('marmita-cat').value                = 'marmita';
      document.getElementById('marmita-visivel').checked          = true;
      document.getElementById('marmita-disponivel-combo').checked = true;
    }
    document.getElementById('modal-marmita').classList.remove('hidden');
  }

  function closeModalMarmita() { document.getElementById('modal-marmita').classList.add('hidden'); }
  function editarMarmita(id)   { abrirModalMarmita(id); }

  async function salvarMarmita(e) {
    e.preventDefault();
    const id = document.getElementById('edit-marmita-id').value;
    const marmita = {
      id:        id ? parseInt(id) : (marmitasCache.length ? Math.max(...marmitasCache.map(m=>m.id))+1 : 1),
      nome:      document.getElementById('marmita-nome').value.trim(),
      preco:     parseFloat(document.getElementById('marmita-preco').value),
      kcal:      parseInt(document.getElementById('marmita-kcal').value),
      desc:      document.getElementById('marmita-desc').value.trim(),
      cat:       document.getElementById('marmita-cat').value,
      visivel:   document.getElementById('marmita-visivel').checked,
      dispCombo: document.getElementById('marmita-disponivel-combo').checked
    };
    await saveMarmita(marmita);
    showToast(id ? '‚úÖ Item atualizado!' : '‚úÖ Item criado!');
    closeModalMarmita();
    if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
  }

  async function excluirMarmitaAdmin(id) {
    showCustomConfirm('Excluir este item do card√°pio?', async () => {
      await deleteMarmita(id);
      showToast('‚úÖ Item exclu√≠do!');
      if (!firebaseInitialized) { renderMarmitasAdmin(); renderCardapio(); }
    });
  }

  // ============================================================
  // ADMIN: COMBOS
  // ============================================================
  function renderCombosAdmin() {
    const el = document.getElementById('combos-admin-list');
    if (!combosCache.length) {
      el.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum combo cadastrado.</p>';
      return;
    }
    el.innerHTML = combosCache.map(c => {
      const tipoBadge = c.tipo === 'fechado'
        ? '<span class="text-xs bg-terracotta/20 text-terracotta px-3 py-1 rounded-full font-bold">üì¶ Fechado</span>'
        : '<span class="text-xs bg-sage/20 text-sage px-3 py-1 rounded-full font-bold">üõí Aberto</span>';
      const vBadge    = c.visivel !== false
        ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">üëÅÔ∏è Vis√≠vel</span>'
        : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">üëª Oculto</span>';
      const vegInfo   = c.vegetal_max > 0
        ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">ü•¶ ${c.vegetal_min}-${c.vegetal_max} vegetais</span>`
        : '';
      const info = c.tipo === 'fechado'
        ? `${Object.keys(c.itens||{}).length} tipos de itens`
        : `${c.qtd} itens ‚Ä¢ R$ ${(c.preco_base/c.qtd).toFixed(2)} cada`;
      const btnToggle = c.visivel !== false
        ? `<button onclick="toggleCombo(${c.id},false)"
                   class="text-xs bg-yellow-50 text-yellow-700 px-3 py-2 rounded-lg font-bold hover:bg-yellow-100 transition-all">
             üëª Ocultar</button>`
        : `<button onclick="toggleCombo(${c.id},true)"
                   class="text-xs bg-green-50 text-green-700 px-3 py-2 rounded-lg font-bold hover:bg-green-100 transition-all">
             üëÅÔ∏è Exibir</button>`;
      return `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-sage/20 ${c.visivel===false?'opacity-60':''}">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2 flex-wrap">
                <h3 class="font-bold text-xl text-forest">${c.nome}</h3>
                ${tipoBadge} ${vBadge} ${vegInfo}
              </div>
              <p class="text-sm text-gray-500">${info}</p>
            </div>
            <span class="text-2xl font-bold text-terracotta ml-4">R$ ${c.preco_base.toFixed(2)}</span>
          </div>
          <div class="flex gap-2 justify-end flex-wrap">
            ${btnToggle}
            <button onclick="editarCombo(${c.id})"
                    class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold hover:bg-blue-100 transition-all">
              ‚úèÔ∏è Editar</button>
            <button onclick="excluirComboAdmin(${c.id})"
                    class="text-xs bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold hover:bg-red-100 transition-all">
              üóëÔ∏è Excluir</button>
          </div>
        </div>`;
    }).join('');
  }

  async function toggleCombo(id, estado) {
    const c = combosCache.find(x => x.id === id);
    if (!c) return;
    c.visivel = estado;
    await saveCombo(c);
    showToast(`‚úÖ Combo ${estado ? 'vis√≠vel' : 'oculto'}!`);
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  function carregarChecklistPratos(selecionados = null) {
    const el = document.getElementById('checklist-pratos-abertos');
    const pratos = marmitasCache.filter(m => m.dispCombo !== false && m.cat !== 'vegetal');
    
    if (!pratos.length) {
      el.innerHTML = '<p class="text-xs text-gray-400 py-2">Nenhum prato dispon√≠vel.</p>';
      return;
    }

    el.innerHTML = pratos.map(p => {
      // Se selecionados for null, marca todos por padr√£o (combo novo)
      const isChecked = (selecionados === null || selecionados.includes(p.id)) ? 'checked' : '';
      return `
        <label class="flex items-center gap-3 p-2 hover:bg-sage/5 rounded-lg cursor-pointer transition-all">
          <input type="checkbox" name="prato-aberto-${p.id}" value="${p.id}" ${isChecked} class="w-4 h-4 text-forest rounded">
          <span class="text-sm font-medium text-charcoal">${p.nome} <span class="text-xs text-gray-400">(${p.kcal} kcal)</span></span>
        </label>
      `;
    }).join('');
  }

  function marcarPratosCombo(marcar) {
    document.querySelectorAll('input[name^="prato-aberto-"]').forEach(cb => cb.checked = marcar);
  }

  function toggleTipoCombo() {
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    document.getElementById('config-aberto').classList.toggle('hidden', tipo === 'fechado');
    document.getElementById('config-fechado').classList.toggle('hidden', tipo === 'aberto');
    if (tipo === 'fechado') {
      document.getElementById('combo-qtd').removeAttribute('required');
      document.getElementById('combo-preco').removeAttribute('required');
      document.getElementById('combo-lote').removeAttribute('required');
      document.getElementById('combo-preco-fechado').setAttribute('required','required');
      carregarItensComboFechado();
    } else {
      document.getElementById('combo-qtd').setAttribute('required','required');
      document.getElementById('combo-preco').setAttribute('required','required');
      document.getElementById('combo-lote').setAttribute('required','required');
      document.getElementById('combo-preco-fechado').removeAttribute('required');
    }
    atualizarPreviewCombo();
  }

  function carregarItensComboFechado() {
    const el     = document.getElementById('itens-combo-container');
    // Apenas itens dispon√≠veis em combo e que n√£o sejam vegetais
    const porCat = {};
    marmitasCache
      .filter(m => m.dispCombo !== false && m.cat !== 'vegetal')
      .forEach(m => {
        if (!porCat[m.cat]) porCat[m.cat] = [];
        porCat[m.cat].push(m);
      });
    el.innerHTML = Object.keys(porCat).map(cat => `
      <div class="mb-4">
        <p class="font-bold text-sm text-forest mb-2">${CAT_ICONS[cat]||'üì¶ Outros'}</p>
        ${porCat[cat].map(item => `
          <div class="flex items-center gap-3 py-2 px-3 hover:bg-sage/5 rounded-lg">
            <div class="flex-1">
              <span class="text-sm">${item.nome}</span>
              <span class="text-xs text-gray-400 ml-2">${item.kcal} kcal</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-500">Qtd:</label>
              <input type="number" name="item-combo-${item.id}" min="0" value="0"
                     onchange="atualizarPreviewCombo()"
                     class="qty-input w-16 px-2 py-1 border border-sage/30 rounded text-center text-sm focus:outline-forest">
            </div>
          </div>`).join('')}
      </div>`).join('');
  }

  function atualizarPreviewCombo() {
    const tipo = document.querySelector('input[name="tipo-combo"]:checked').value;
    const el   = document.getElementById('preco-unitario-preview');
    if (tipo === 'aberto') {
      const qtd   = parseInt(document.getElementById('combo-qtd').value)    || 0;
      const preco = parseFloat(document.getElementById('combo-preco').value) || 0;
      el.textContent = (qtd > 0 && preco > 0)
        ? `Cada item sair√° por R$ ${(preco/qtd).toFixed(2)}`
        : 'Preencha quantidade e pre√ßo';
    } else {
      let total = 0;
      document.querySelectorAll('input[name^="item-combo-"]').forEach(i => { total += parseInt(i.value)||0; });
      const preco = parseFloat(document.getElementById('combo-preco-fechado').value) || 0;
      el.textContent = total > 0
        ? `${total} itens${preco > 0 ? ` ‚Ä¢ R$ ${(preco/total).toFixed(2)} por item` : ' ‚Ä¢ Defina o pre√ßo'}`
        : 'Selecione os itens e defina o pre√ßo';
    }
  }

  function abrirModalCombo(id = null) {
    document.getElementById('modal-combo-title').textContent = id ? 'Editar Combo' : 'Novo Combo';
    document.getElementById('edit-combo-id').value = id || '';
    if (id) {
      const c = combosCache.find(x => x.id === id);
      if (c) {
        document.getElementById('combo-nome').value        = c.nome;
        document.getElementById('combo-visivel').checked   = c.visivel !== false;
        document.getElementById('combo-vegetal-min').value = c.vegetal_min || 0;
        document.getElementById('combo-vegetal-max').value = c.vegetal_max || 0;
        if (c.tipo === 'fechado') {
          document.querySelector('input[name="tipo-combo"][value="fechado"]').checked = true;
          toggleTipoCombo();
          document.getElementById('combo-preco-fechado').value = c.preco_base;
          setTimeout(() => {
            Object.entries(c.itens || {}).forEach(([itemId, qtd]) => {
              const inp = document.querySelector(`input[name="item-combo-${itemId}"]`);
              if (inp) inp.value = qtd;
            });
            atualizarPreviewCombo();
          }, 100);
        } else {
          document.querySelector('input[name="tipo-combo"][value="aberto"]').checked = true;
          toggleTipoCombo();
          document.getElementById('combo-qtd').value   = c.qtd;
          document.getElementById('combo-preco').value = c.preco_base;
          document.getElementById('combo-lote').value  = c.lote_selecao || 1;
          carregarChecklistPratos(c.itens_disponiveis || []);
          atualizarPreviewCombo();
        }
      }
    } else {
      document.getElementById('combo-nome').value          = '';
      document.getElementById('combo-qtd').value           = '';
      document.getElementById('combo-preco').value         = '';
      document.getElementById('combo-lote').value          = '1';
      document.getElementById('combo-preco-fechado').value = '';
      document.getElementById('combo-vegetal-min').value   = '0';
      document.getElementById('combo-vegetal-max').value   = '0';
      document.getElementById('combo-visivel').checked     = true;
      document.querySelector('input[name="tipo-combo"][value="aberto"]').checked = true;
      carregarChecklistPratos(null);
      toggleTipoCombo();
    }
    document.getElementById('modal-combo').classList.remove('hidden');
    document.getElementById('combo-qtd').addEventListener('input',   atualizarPreviewCombo);
    document.getElementById('combo-preco').addEventListener('input', atualizarPreviewCombo);
  }

  function closeModalCombo() { document.getElementById('modal-combo').classList.add('hidden'); }
  function editarCombo(id)   { abrirModalCombo(id); }

  async function salvarCombo(e) {
    e.preventDefault();
    const id      = document.getElementById('edit-combo-id').value;
    const nome    = document.getElementById('combo-nome').value.trim();
    const visivel = document.getElementById('combo-visivel').checked;
    const tipo    = document.querySelector('input[name="tipo-combo"]:checked').value;
    const vegMin  = parseInt(document.getElementById('combo-vegetal-min').value) || 0;
    const vegMax  = parseInt(document.getElementById('combo-vegetal-max').value) || 0;
    let qtd, preco_base, itens = {}, lote_selecao = 1, itens_disponiveis = [];

    if (tipo === 'fechado') {
      let total = 0;
      document.querySelectorAll('input[name^="item-combo-"]').forEach(inp => {
        const itemId = inp.name.replace('item-combo-','');
        const q = parseInt(inp.value) || 0;
        if (q > 0) { itens[itemId] = q; total += q; }
      });
      if (!total) { showToast('‚ö†Ô∏è Selecione pelo menos um item!'); return; }
      qtd        = total;
      preco_base = parseFloat(document.getElementById('combo-preco-fechado').value);
    } else {
      qtd        = parseInt(document.getElementById('combo-qtd').value);
      preco_base = parseFloat(document.getElementById('combo-preco').value);
      lote_selecao = parseInt(document.getElementById('combo-lote').value) || 1;
      
      document.querySelectorAll('input[name^="prato-aberto-"]:checked').forEach(cb => {
        itens_disponiveis.push(parseInt(cb.value));
      });
      if (itens_disponiveis.length === 0) {
        showToast('‚ö†Ô∏è Selecione pelo menos um prato dispon√≠vel para o combo!');
        return;
      }
    }

    const combo = {
      id:          id ? parseInt(id) : (combosCache.length ? Math.max(...combosCache.map(c=>c.id))+1 : 1),
      nome, qtd, preco_base, visivel, tipo, itens,
      vegetal_min: vegMin,
      vegetal_max: vegMax,
      lote_selecao,
      itens_disponiveis
    };
    await saveCombo(combo);
    showToast(id ? '‚úÖ Combo atualizado!' : '‚úÖ Combo criado!');
    closeModalCombo();
    if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
  }

  async function excluirComboAdmin(id) {
    showCustomConfirm('Excluir este combo?', async () => {
      await deleteCombo(id);
      showToast('‚úÖ Combo exclu√≠do!');
      if (!firebaseInitialized) { renderCombosAdmin(); renderCardapio(); }
    });
  }

  // ============================================================
  // INTEGRA√á√ïES GEMINI IA
  // ============================================================
  async function gerarDescricaoIA() {
    const nome = document.getElementById('marmita-nome').value.trim();
    const kcal = document.getElementById('marmita-kcal').value;
    if (!nome) return showToast("‚ö†Ô∏è Escreva o nome da marmita primeiro!");
    
    const txtArea = document.getElementById('marmita-desc');
    const btn = document.getElementById('btn-gerar-ia');
    const origText = btn.innerHTML;
    
    btn.innerHTML = '‚è≥ A gerar...';
    btn.disabled = true;

    const prompt = `Crie uma descri√ß√£o apetitosa, comercial e muito curta (m√°ximo 2 frases) para uma refei√ß√£o/marmita fit chamada "${nome}" que tem ${kcal || 'algumas'} calorias. Destaque os ingredientes de forma atrativa e foque na sa√∫de e nutri√ß√£o. Responda apenas com a descri√ß√£o.`;
    
    const resultado = await callGemini(prompt, "√âs um copywriter especialista em culin√°ria saud√°vel e fitness em Portugal.");
    
    if (resultado) {
      txtArea.value = resultado.trim();
      showToast("‚ú® Descri√ß√£o gerada com sucesso!");
    }
    
    btn.innerHTML = origText;
    btn.disabled = false;
  }

  async function preencherComboComIA() {
    const objetivo = document.getElementById('ia-objetivo').value.trim();
    if (!objetivo) return showToast("‚ö†Ô∏è Escreva o seu objetivo primeiro!");

    const btn = document.getElementById('btn-ia-preencher');
    const origText = btn.innerHTML;
    btn.innerHTML = '‚è≥ A analisar...';
    btn.disabled = true;

    const lote = currentCombo?.lote_selecao || 1;

    const disponiveis = marmitasCache.filter(m => {
      if (!m.visivel || m.cat === 'vegetal' || m.dispCombo === false) return false;
      if (currentCombo?.itens_disponiveis && currentCombo.itens_disponiveis.length > 0) {
        return currentCombo.itens_disponiveis.includes(m.id);
      }
      return true;
    });

    const cardapioInfo = disponiveis.map(m => `ID: ${m.id} | Nome: ${m.nome} | Kcal: ${m.kcal} | Categoria: ${m.cat}`).join('\n');
    
    const max = maxMarmitas;
    const prompt = `O cliente tem o seguinte objetivo/prefer√™ncia: "${objetivo}". Ele comprou um combo de ${max} marmitas. Aqui est√° o card√°pio dispon√≠vel:\n${cardapioInfo}\nRegras:\n1. Escolhe exatamente ${max} marmitas no total.\n2. Podes repetir marmitas, mas a quantidade (qtd) de cada item selecionado DEVE ser obrigatoriamente um m√∫ltiplo de ${lote}.\n3. A soma de todas as quantidades tem que ser exatamente ${max}.\n4. Justifica a tua escolha com uma mensagem curta, amig√°vel e motivadora (em portugu√™s de Portugal).`;

    const schema = { type: "OBJECT", properties: { mensagem: { type: "STRING" }, selecoes: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "INTEGER" }, qtd: { type: "INTEGER" } } } } } };

    const resultado = await callGemini(prompt, "√âs um nutricionista e assistente inteligente do restaurante Sabor e Sa√∫de.", schema);

    if (resultado && resultado.selecoes) {
      quantities = {};
      let totalAdicionado = 0;
      resultado.selecoes.forEach(item => {
        if (totalAdicionado + item.qtd > max) return;
        const m = disponiveis.find(x => x.id === item.id);
        if (m) {
          quantities[m.id] = item.qtd;
          totalAdicionado += item.qtd;
        }
      });

      if (totalAdicionado < max) showToast("‚ö†Ô∏è A IA preencheu parte do kit. Podes completar o resto!");
      else showToast("‚ú® Kit preenchido com IA com sucesso!");

      disponiveis.forEach(m => {
        const el = document.getElementById(`qty-${m.id}`);
        if (el) el.textContent = quantities[m.id] || 0;
      });

      document.getElementById('current-marmitas').textContent = totalAdicionado;
      const pct = Math.min(100, Math.round((totalAdicionado / maxMarmitas) * 100));
      const bar = document.getElementById('progress-bar');
      if (bar) bar.style.width = pct + '%';
      atualizarTotal();

      // Deslizar caso a IA preencha tudo
      if (totalAdicionado === maxMarmitas) {
         const vegMax = currentCombo?.vegetal_max || 0;
         if (vegMax > 0) {
           setTimeout(() => document.getElementById('secao-vegetais').scrollIntoView({behavior: 'smooth', block: 'start'}), 1200);
         } else {
           setTimeout(() => document.getElementById('secao-checkout').scrollIntoView({behavior: 'smooth', block: 'start'}), 1200);
         }
      }

      showCustomAlert("‚ú® A Intelig√™ncia Artificial diz:\n\n" + resultado.mensagem);
    }
    
    btn.innerHTML = origText;
    btn.disabled = false;
  }

  // ============================================================
  // START
  // ============================================================
  window.onload = initData;
</script>
</body>
</html>